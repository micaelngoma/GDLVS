<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Verification Records</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root {
      --dark:#2a3f54; --light:#f6f8fb; --panel:#fff;
      --info:#2980b9; --success:#27ae60; --danger:#e74c3c;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:"Segoe UI",sans-serif;background:var(--light);color:#333;}
    header, nav{position:fixed;left:0;right:0;z-index:1000;}
    header{top:0;background:var(--dark);color:#fff;padding:8px 14px;
      display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
    nav{top:46px;background:#fff;border-bottom:1px solid #eee;padding:10px 16px;
      display:flex;flex-wrap:wrap;gap:14px;}
    body{padding-top:100px;}
    header h1{margin:0;font-size:1.1rem;display:flex;align-items:center;gap:6px;}
    .controls{display:flex;align-items:center;gap:8px;}
    .controls select,.controls button{padding:5px 9px;border:0;border-radius:6px;font-size:.85rem;cursor:pointer;}
    .controls select{background:#1f2d3a;color:#fff;}
    .controls button{background:#1f2d3a;color:#fff;}
    .controls button:hover{background:#16222d;}
    nav a{color:var(--dark);text-decoration:none;font-weight:600;}
    nav a.active{border-bottom:2px solid var(--dark);padding-bottom:3px;}

    .container{max-width:1000px;margin:20px auto;background:#fff;border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:20px;}
    .insights{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:18px;}
    .insight-card{flex:1 1 30%;min-width:200px;border-radius:10px;padding:18px;text-align:center;color:#fff;}
    .insight-total{background:var(--info);}
    .insight-success{background:var(--success);position:relative;}
    .insight-fail{background:var(--danger);}
    .insight-card h3{margin:0;font-size:.95rem;font-weight:600;}
    .insight-card h2{margin:6px 0 0;font-size:1.4rem;font-weight:700;}
    .success-rate{font-size:.85rem;margin-top:4px;font-weight:500;color:#eafbe4;}

    .table-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px;}
    input#searchRequests{max-width:260px;padding:8px;border:1px solid #ddd;border-radius:8px;}
    .btn-export,.btn-toggle{background:var(--info);color:#fff;padding:8px 12px;border:0;border-radius:8px;cursor:pointer;}
    .btn-export:hover,.btn-toggle:hover{background:#1f6392;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 12px;border:1px solid #eee;}
    th{background:#f2f2f2;font-weight:600;}
    .btn-action{border:0;border-radius:6px;padding:6px 10px;cursor:pointer;color:#fff;}
    .btn-view{background:var(--info);} .btn-view:hover{background:#1f6392;}
    .btn-delete{background:var(--danger);} .btn-delete:hover{background:#c0392b;}
    .btn-archive{background:var(--success);} .btn-archive:hover{background:#219150;}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;
      align-items:center;justify-content:center;z-index:9999;}
    .modal{background:#fff;border-radius:10px;max-width:440px;width:90%;padding:22px;
      box-shadow:0 4px 12px rgba(0,0,0,0.25);animation:fadeIn .25s ease;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:translateY(0);}}
    .modal h3{margin-top:0;}
    .modal p strong{display:inline-block;width:130px;}
    .modal-buttons{margin-top:18px;display:flex;justify-content:space-between;}
    .modal-buttons button{flex:1;margin:0 4px;padding:8px 10px;border-radius:6px;border:0;
      color:#fff;font-weight:600;cursor:pointer;}
    .btn-close{background:#555;} .btn-close:hover{background:#333;}
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-clipboard-check"></i> <span data-i18n="verificationRecords">Verification Records</span></h1>
    <div class="controls">
      <select id="languageSwitcher">
        <option value="en">🇬🇧 EN</option>
        <option value="fr">🇫🇷 FR</option>
        <option value="ja">🇯🇵 JP</option>
      </select>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span></button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
    <a href="verify.html"><i class="fas fa-search"></i> Verification</a>
    <a href="add_licenses.html"><i class="fas fa-id-card"></i> Add License</a>
    <a href="users.html"><i class="fas fa-users-cog"></i> Users</a>
    <a href="verification_requests.html" class="active"><i class="fas fa-inbox"></i> Records</a>
    <a href="analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a>
  </nav>

  <main class="container">
    <!-- Insights Section -->
    <section>
      <h2><i class="fas fa-chart-line"></i> Verification Insights</h2>
      <div class="insights">
        <div class="insight-card insight-total">
          <h3><i class="fas fa-search"></i> Total:</h3>
          <h2 id="totalVerifications">0</h2>
        </div>
        <div class="insight-card insight-success">
          <h3><i class="fas fa-check-circle"></i> Successful:</h3>
          <h2 id="successfulVerifications">0</h2>
          <div class="success-rate" id="successRate">Success Rate: 0%</div>
        </div>
        <div class="insight-card insight-fail">
          <h3><i class="fas fa-times-circle"></i> Unsuccessful:</h3>
          <h2 id="unsuccessfulVerifications">0</h2>
        </div>
      </div>
    </section>

    <section>
      <div class="table-controls">
        <button class="btn-toggle" id="toggleReviewed">Show Reviewed Verifications</button>
        <input type="text" id="searchRequests" placeholder="Search verifications...">
        <button class="btn-export" id="exportBtn">📥 Export</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>License #</th>
            <th>Organization</th>
            <th>Purpose</th>
            <th>Country</th>
            <th>Result</th>
            <th>Email</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="requestsTable"><tr><td colspan="8">Loading...</td></tr></tbody>
      </table>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3><i class="fas fa-file-alt"></i> Verification Details</h3>
      <div id="modalBody"></div>
      <div class="modal-buttons">
        <button id="archiveBtn" class="btn-archive">Mark Reviewed</button>
        <button id="deleteBtn" class="btn-delete">Delete</button>
        <button id="closeBtn" class="btn-close">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let showReviewed = false;
    const tbody = document.getElementById("requestsTable");
    const toggleBtn = document.getElementById("toggleReviewed");

    const qVer = query(collection(db, "verifications"), orderBy("verifiedAt", "desc"));
    onSnapshot(qVer, (snap) => {
      const docs = [];
      snap.forEach((d) => docs.push({ id: d.id, ...d.data() }));
      renderTable(docs);
      renderInsights(docs);
    });

    function renderInsights(docs) {
      const visible = docs.filter((d) => showReviewed ? d.archived : !d.archived);
      const total = visible.length;
      let success = 0;
      let fail = 0;

      visible.forEach((d) => {
        const res = (d.result || "").toLowerCase().trim();
        if (res.includes("not found")) fail++;
        else if (res.includes("found")) success++;
      });

      const rate = total > 0 ? ((success / total) * 100).toFixed(1) : 0;

      document.getElementById("totalVerifications").textContent = total;
      document.getElementById("successfulVerifications").textContent = success;
      document.getElementById("unsuccessfulVerifications").textContent = fail;
      document.getElementById("successRate").textContent = `Success Rate: ${rate}%`;
    }

    function renderTable(docs) {
      tbody.innerHTML = "";
      const filtered = docs.filter((d) => showReviewed ? d.archived : !d.archived);
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8">No verifications found</td></tr>`;
        return;
      }
      filtered.forEach((d) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.licenseNumber || ""}</td>
          <td>${d.requestingOrg || ""}</td>
          <td>${d.purpose || ""}</td>
          <td>${d.country || ""}</td>
          <td>${d.result || ""}</td>
          <td>${d.email || ""}</td>
          <td>${d.verifiedAt?.toDate ? d.verifiedAt.toDate().toLocaleString() : ""}</td>
          <td><button class="btn-action btn-view" data-id="${d.id}">View</button></td>`;
        tbody.appendChild(tr);
      });
    }

    toggleBtn.addEventListener("click", () => {
      showReviewed = !showReviewed;
      toggleBtn.textContent = showReviewed ? "Hide Reviewed Verifications" : "Show Reviewed Verifications";
    });

    const modal = document.getElementById("modalOverlay");
    const modalBody = document.getElementById("modalBody");
    let currentId = null;

    tbody.addEventListener("click", async (e) => {
      if (!e.target.classList.contains("btn-view")) return;
      currentId = e.target.dataset.id;
      const s = await getDoc(doc(db, "verifications", currentId));
      if (!s.exists()) return;
      const d = s.data();
      modalBody.innerHTML = `
        <p><strong>License #:</strong> ${d.licenseNumber || ""}</p>
        <p><strong>Organization:</strong> ${d.requestingOrg || ""}</p>
        <p><strong>Country:</strong> ${d.country || ""}</p>
        <p><strong>Purpose:</strong> ${d.purpose || ""}</p>
        <p><strong>Result:</strong> ${d.result || ""}</p>
        <p><strong>Email:</strong> ${d.email || ""}</p>
        <p><strong>Verified At:</strong> ${d.verifiedAt?.toDate ? d.verifiedAt.toDate().toLocaleString() : ""}</p>
        <p><strong>Verified By:</strong> ${d.verifiedBy || ""}</p>
        <p><strong>Status:</strong> ${d.archived ? "Reviewed ✅" : "Pending 🔄"}</p>`;
      modal.style.display = "flex";
    });

    document.getElementById("closeBtn").onclick = () => (modal.style.display = "none");
    modal.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };
    document.getElementById("archiveBtn").onclick = async () => {
      if (!currentId) return;
      await updateDoc(doc(db, "verifications", currentId), { archived: true });
      modal.style.display = "none";
      alert("✅ Marked as reviewed");
    };
    document.getElementById("deleteBtn").onclick = async () => {
      if (!currentId) return;
      if (!confirm("Delete this verification?")) return;
      await deleteDoc(doc(db, "verifications", currentId));
      modal.style.display = "none";
      alert("🗑️ Deleted!");
    };

    onAuthStateChanged(auth, (user) => { if (!user) location.href = "index.html"; });
    document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth).then(() => location.href = "index.html"));
  </script>
</body>
</html>
