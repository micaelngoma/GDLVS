<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GDLVS ‚Äì Verification Requests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- i18n + jQuery -->
    <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
    <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

    <style>
      :root {
        --brand-dark: #004aad;
        --brand-dark-2: #003780;
        --success: #28a745;
        --danger: #dc3545;
        --bg: #f6f8fb;
        --panel: #fff;
        --shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: var(--bg);
        margin: 0;
      }

      header {
        background: var(--brand-dark);
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 18px;
      }

      header h1 {
        font-size: 1.2rem;
        margin: 0;
      }

      header select,
      header button {
        background: #1f2d3a;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 6px 10px;
        margin-left: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: var(--panel);
        box-shadow: var(--shadow);
        border-radius: 8px;
        overflow: hidden;
      }

      th,
      td {
        padding: 12px 10px;
        border-bottom: 1px solid #e5e5e5;
        text-align: left;
        font-size: 0.95rem;
      }

      th {
        background: #f0f3f8;
      }

      .container {
        max-width: 1100px;
        margin: 30px auto;
        padding: 10px;
      }

      button.action {
        border: none;
        border-radius: 6px;
        color: #fff;
        padding: 6px 10px;
        cursor: pointer;
      }

      .approve {
        background: var(--success);
      }

      .reject {
        background: var(--danger);
      }

      .approve:hover {
        background: #1e7e34;
      }

      .reject:hover {
        background: #c82333;
      }

      .status {
        font-weight: 600;
      }

      .status.pending {
        color: #f0ad4e;
      }
      .status.approved {
        color: var(--success);
      }
      .status.rejected {
        color: var(--danger);
      }

      footer {
        text-align: center;
        margin-top: 25px;
        color: #777;
      }
    </style>
  </head>

  <body>
    <header>
      <h1><i class="fas fa-inbox"></i> Verification Requests</h1>
      <div>
        <select id="languageSwitcher">
          <option value="en">üá¨üáß EN</option>
          <option value="fr">üá´üá∑ FR</option>
          <option value="ja">üáØüáµ JP</option>
        </select>
        <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </header>

    <div class="container">
      <table id="requestsTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Organization</th>
            <th>Phone</th>
            <th>Country</th>
            <th>Purpose</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <footer>‚Äî GDLVS Administration ‚Äî</footer>

    <script>
      /* === Firebase Init === */
      const firebaseConfig = {
        apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
        authDomain: "gdlvs-2348e.firebaseapp.com",
        projectId: "gdlvs-2348e",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      /* === EmailJS Init === */
      emailjs.init("TfmaZEvxtz2MNUb70");
      const ADMIN_EMAIL = "m.ngoma1988@gmail.com";

      /* === i18n === */
      const i18nResources = {
        en: { translation: { logout: "Logout" } },
        fr: { translation: { logout: "D√©connexion" } },
        ja: { translation: { logout: "„É≠„Ç∞„Ç¢„Ç¶„Éà" } },
      };
      i18next.use(i18nextBrowserLanguageDetector).init(
        { resources: i18nResources, fallbackLng: "en" },
        () => jqueryI18next.init(i18next, $, { useOptionsAttr: true })
      );
      document
        .getElementById("languageSwitcher")
        .addEventListener("change", function () {
          i18next.changeLanguage(this.value, () => $("body").localize());
        });

      /* === Auth + Role Check === */
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        const roleDoc = await db.collection("roles").doc(user.email).get();
        if (!roleDoc.exists || roleDoc.data().role !== "admin") {
          alert("‚õî Access restricted to administrators only.");
          window.location.href = "verify.html";
          return;
        }
        loadRequests();
      });

      document
        .getElementById("logoutBtn")
        .addEventListener("click", () => auth.signOut().then(() => (window.location.href = "index.html")));

      /* === Load Requests === */
      async function loadRequests() {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        const snap = await db.collection("requests").orderBy("requestedAt", "desc").get();
        snap.forEach((doc) => {
          const d = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.fullName || ""}</td>
            <td>${d.email || ""}</td>
            <td>${d.organization || ""}</td>
            <td>${d.phone || ""}</td>
            <td>${d.country || ""}</td>
            <td>${d.purpose || ""}</td>
            <td class="status ${d.status}">${d.status}</td>
            <td>
              <button class="action approve" onclick="updateStatus('${doc.id}','approved','${d.email}','${d.fullName}')">Approve</button>
              <button class="action reject" onclick="updateStatus('${doc.id}','rejected','${d.email}','${d.fullName}')">Reject</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      /* === Update Status + Email Notification === */
      async function updateStatus(docId, status, email, name) {
        try {
          await db.collection("requests").doc(docId).update({ status });
          await emailjs.send("service_ddq3kka", "template_inl3jsv", {
            name,
            email,
            status,
            organization: "",
            phone: "",
            purpose: "",
            message:
              status === "approved"
                ? "‚úÖ Your GDLVS access request has been approved. Your account will be created within 72 hours."
                : "‚ùå Your GDLVS access request has been rejected. Please contact the administrator for details.",
          });
          await emailjs.send("service_ddq3kka", "template_inl3jsv", {
            name: "Admin Copy ‚Äì " + name,
            email: ADMIN_EMAIL,
            status,
            organization: "",
            phone: "",
            purpose: "",
            message: `Admin copy ‚Äì Request for ${name} has been ${status}.`,
          });
          alert(`‚úÖ Request ${status}! Notification sent.`);
          loadRequests();
        } catch (err) {
          console.error(err);
          alert("‚ùå Error: " + err.message);
        }
      }

      window.updateStatus = updateStatus;
    </script>
  </body>
</html>
