<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GDLVS - Verification Requests</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- i18n + jQuery -->
    <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
    <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

    <style>
      :root {
        --brand-dark: #004aad;
        --brand-dark-2: #003780;
        --success: #28a745;
        --danger: #dc3545;
        --bg: #f6f8fb;
        --panel: #fff;
        --shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: var(--bg);
        margin: 0;
      }

      header {
        background: var(--brand-dark);
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 18px;
      }

      header h1 {
        font-size: 1.2rem;
        margin: 0;
      }

      header button,
      header select {
        background: #1f2d3a;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 6px 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: var(--panel);
        box-shadow: var(--shadow);
        border-radius: 8px;
        overflow: hidden;
      }

      th,
      td {
        padding: 12px 10px;
        border-bottom: 1px solid #e5e5e5;
        text-align: left;
        font-size: 0.95rem;
      }

      th {
        background: #f0f3f8;
      }

      .container {
        max-width: 1100px;
        margin: 30px auto;
        padding: 10px;
      }

      button.action {
        border: none;
        border-radius: 6px;
        color: #fff;
        padding: 6px 10px;
        cursor: pointer;
      }

      .approve {
        background: var(--success);
      }

      .reject {
        background: var(--danger);
      }

      .approve:hover {
        background: #1e7e34;
      }

      .reject:hover {
        background: #c82333;
      }

      .status {
        font-weight: 600;
      }

      .status.pending {
        color: #f0ad4e;
      }
      .status.approved {
        color: var(--success);
      }
      .status.rejected {
        color: var(--danger);
      }

      footer {
        text-align: center;
        margin-top: 25px;
        color: #777;
      }
    </style>
  </head>

  <body>
    <header>
      <h1><i class="fas fa-inbox"></i> Verification Requests</h1>
      <div>
        <select id="languageSwitcher">
          <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
          <option value="fr">ðŸ‡«ðŸ‡· FR</option>
          <option value="ja">ðŸ‡¯ðŸ‡µ JP</option>
        </select>
        <button id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <div class="container">
      <table id="requestsTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Organization</th>
            <th>Phone</th>
            <th>Country</th>
            <th>Purpose</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="7" style="text-align:center;">Loading requests...</td></tr>
        </tbody>
      </table>
    </div>

    <footer>â€” GDLVS Administration â€”</footer>

    <script>
      /* === Firebase Init === */
      const firebaseConfig = {
        apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
        authDomain: "gdlvs-2348e.firebaseapp.com",
        projectId: "gdlvs-2348e",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      /* === i18n === */
      const i18nResources = {
        en: { translation: { logout: "Logout" } },
        fr: { translation: { logout: "DÃ©connexion" } },
        ja: { translation: { logout: "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" } },
      };
      i18next
        .use(i18nextBrowserLanguageDetector)
        .init(
          { resources: i18nResources, fallbackLng: "en" },
          () => jqueryI18next.init(i18next, $, { useOptionsAttr: true })
        );
      document
        .getElementById("languageSwitcher")
        .addEventListener("change", function () {
          i18next.changeLanguage(this.value, () => $("body").localize());
        });

      /* === Logout === */
      document
        .getElementById("logoutBtn")
        .addEventListener("click", () =>
          auth.signOut().then(() => (window.location.href = "index.html"))
        );

      /* === Auth State and Role Restriction === */
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        // Get role from Firestore roles collection
        const roleDoc = await db.collection("roles").doc(user.email).get();
        const role = roleDoc.exists ? roleDoc.data().role : "verifier";

        if (role === "admin") {
          loadRequests();
        } else {
          // Redirect verifiers safely without flashing loop
          window.location.replace("verify.html");
        }
      });

      /* === Load Verification Requests === */
      async function loadRequests() {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        const snapshot = await db
          .collection("requests")
          .orderBy("requestedAt", "desc")
          .get();

        if (snapshot.empty) {
          tbody.innerHTML =
            "<tr><td colspan='7' style='text-align:center;'>No requests found</td></tr>";
          return;
        }

        snapshot.forEach((doc) => {
          const d = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.fullName || ""}</td>
            <td>${d.email || ""}</td>
            <td>${d.organization || ""}</td>
            <td>${d.phone || ""}</td>
            <td>${d.country || ""}</td>
            <td>${d.purpose || ""}</td>
            <td class="status ${d.status || "pending"}">${d.status || "pending"}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    </script>
  </body>
</html>
