<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Access Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- jQuery + i18n (UMD, same pattern as index.html) -->
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <!-- Firebase v8 (same major as index.html) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <style>
    body{font-family:Arial,sans-serif;color:#333;margin:0;background:#f6f8fb;}
    .background-image{position:fixed;inset:0;background:url('https://raw.githubusercontent.com/micaelngoma/GDLVS/main/Gabon%20Forest.jpg') center/cover no-repeat;z-index:-1;filter:brightness(0.9);}
    header{background:#2a3f54;color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;position:fixed;top:0;left:0;right:0;z-index:1000;}
    header h1{margin:0;font-size:1.1rem;display:flex;gap:8px;align-items:center;}
    .controls{display:flex;gap:8px;align-items:center;}
    .controls select,.controls button{padding:6px 10px;border-radius:8px;border:0;font-size:.9rem;}
    .controls select{background:#fff;color:#000;}
    .controls button{background:#1e2d3c;color:#fff;cursor:pointer;}
    nav{background:#1e2d3c;color:#fff;padding:10px 14px;display:flex;gap:16px;position:fixed;top:56px;left:0;right:0;z-index:999;}
    nav a{color:#fff;text-decoration:none;font-weight:bold;transition:all .25s}
    nav a.active,nav a:hover{border-bottom:2px solid #f1c40f;padding-bottom:3px;box-shadow:0 2px 6px rgba(241,196,15,.7);}
    main.container{max-width:95vw;margin:120px auto 0;background:rgba(255,255,255,.95);padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.2);}
    .search-bar{width:50%;display:block;padding:10px;margin:0 auto 15px;border-radius:8px;border:1px solid #ccc;}
    table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed;}
    th,td{border:1px solid #eee;padding:8px;background:#fff;text-align:left;word-wrap:break-word;}
    th{background:#f2f2f2;}
    .status{font-weight:bold;text-transform:capitalize;}
    .status.pending{color:#f1c40f;} .status.approved{color:#27ae60;} .status.rejected{color:#e74c3c;}
    .btn-inline{padding:5px 8px;border-radius:6px;border:0;cursor:pointer;color:#fff;background:#2980b9;margin:2px;}
    .btn-danger{background:#e74c3c;} .btn-success{background:#27ae60;} .btn-pending{background:#f1c40f;color:#000;} .btn-delete{background:#555;}
  </style>
</head>
<body>
  <div class="background-image"></div>

  <header>
    <h1><i class="fas fa-user-check"></i> <span data-i18n="pageTitle">Access Requests</span></h1>
    <div class="controls">
      <select id="languageSwitcher">
        <option value="en">🇬🇧 English</option>
        <option value="fr">🇫🇷 Français</option>
        <option value="ja">🇯🇵 日本語</option>
      </select>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span></button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fas fa-home"></i> <span data-i18n="dashboard">Dashboard</span></a>
    <a href="verify.html"><i class="fas fa-search"></i> <span data-i18n="verification">Verification</span></a>
    <a href="add_licenses.html"><i class="fas fa-id-card"></i> <span data-i18n="addLicense">Add License</span></a>
    <a href="users.html"><i class="fas fa-users-cog"></i> <span data-i18n="users">Users</span></a>
    <a href="verification_requests.html"><i class="fas fa-inbox"></i> <span data-i18n="verRequests">Verification Requests</span></a>
    <a href="request_access.html" class="active"><i class="fas fa-user-check"></i> <span data-i18n="accessRequests">Access Requests</span></a>
    <a href="analytics.html"><i class="fas fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></a>
  </nav>

  <main class="container">
    <h2><i class="fas fa-table"></i> <span data-i18n="recordsTitle">Access Request Records</span></h2>
    <input type="text" id="searchInput" class="search-bar" data-i18n="[placeholder]searchPlaceholder" placeholder="Search...">

    <table id="accessTable">
      <thead>
        <tr>
          <th data-i18n="name">Full Name</th>
          <th data-i18n="email">Email</th>
          <th data-i18n="org">Organization</th>
          <th data-i18n="phone">Phone</th>
          <th data-i18n="purpose">Purpose</th>
          <th data-i18n="status">Status</th>
          <th data-i18n="action">Action</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="7" data-i18n="loading">Loading...</td></tr>
      </tbody>
    </table>
  </main>

  <script>
    /* ========== Firebase (same style as index.html) ========== */
    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Redirect to login when signed out
    auth.onAuthStateChanged(user => {
      if (!user) {
        // use replace() so back button doesn’t return to a protected page
        window.location.replace("index.html");
      }
    });

    // Robust logout handler (prevents flash + reload loop)
    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut()
        .then(() => window.location.replace("index.html"))
        .catch(err => {
          console.error("Logout error:", err);
          // Fallback navigation even if signOut throws
          window.location.replace("index.html");
        });
    });

    /* ========== i18n resources (EN/FR/JA) ========== */
    const i18nResources = {
      en:{translation:{
        pageTitle:"Access Requests", logout:"Logout",
        dashboard:"Dashboard", verification:"Verification", addLicense:"Add License",
        users:"Users", verRequests:"Verification Requests", analytics:"Analytics",
        accessRequests:"Access Requests", recordsTitle:"Access Request Records",
        searchPlaceholder:"Search...", name:"Full Name", email:"Email", org:"Organization",
        phone:"Phone", purpose:"Purpose", status:"Status", action:"Action",
        approve:"Approve", reject:"Reject", pending:"Pending", delete:"Delete",
        noData:"No requests found", loading:"Loading..."
      }},
      fr:{translation:{
        pageTitle:"Demandes d'accès", logout:"Déconnexion",
        dashboard:"Tableau de bord", verification:"Vérification", addLicense:"Ajouter un permis",
        users:"Utilisateurs", verRequests:"Demandes de vérification", analytics:"Analytique",
        accessRequests:"Demandes d'accès", recordsTitle:"Enregistrements des demandes d'accès",
        searchPlaceholder:"Rechercher...", name:"Nom complet", email:"E-mail", org:"Organisation",
        phone:"Téléphone", purpose:"But", status:"Statut", action:"Action",
        approve:"Approuver", reject:"Rejeter", pending:"En attente", delete:"Supprimer",
        noData:"Aucune demande trouvée", loading:"Chargement..."
      }},
      ja:{translation:{
        pageTitle:"アクセスリクエスト", logout:"ログアウト",
        dashboard:"ダッシュボード", verification:"照会", addLicense:"免許を追加",
        users:"ユーザー", verRequests:"照会リクエスト", analytics:"分析",
        accessRequests:"アクセスリクエスト", recordsTitle:"アクセスリクエスト記録",
        searchPlaceholder:"検索...", name:"氏名", email:"メール", org:"組織",
        phone:"電話", purpose:"目的", status:"状態", action:"操作",
        approve:"承認", reject:"拒否", pending:"保留", delete:"削除",
        noData:"リクエストが見つかりません", loading:"読み込み中..."
      }}
    };

    // Initialize i18n exactly like index.html
    i18next.use(i18nextBrowserLanguageDetector).init(
      { resources:i18nResources, fallbackLng:"en" },
      () => {
        jqueryI18next.init(i18next, $, { useOptionsAttr:true });
        applyTranslations();
      }
    );

    // Force-apply translations anywhere jQuery-i18next might miss
    function applyTranslations(){
      $("body").localize(); // translates elements with data-i18n and [placeholder]
      // Extra safety for dynamic pieces:
      document.querySelector("#searchInput").placeholder = i18next.t("searchPlaceholder");
      // Table headers (in case)
      document.querySelectorAll("th[data-i18n]").forEach(th => th.textContent = i18next.t(th.dataset.i18n));
      // Action buttons inside table rows
      document.querySelectorAll("#accessTable tbody .btn-success").forEach(b => b.textContent = i18next.t("approve"));
      document.querySelectorAll("#accessTable tbody .btn-danger").forEach(b => b.textContent = i18next.t("reject"));
      document.querySelectorAll("#accessTable tbody .btn-pending").forEach(b => b.textContent = i18next.t("pending"));
      document.querySelectorAll("#accessTable tbody .btn-delete").forEach(b => b.textContent = i18next.t("delete"));
    }

    // Language switcher (match index.html behavior)
    document.getElementById("languageSwitcher").addEventListener("change", function(){
      const lang = this.value;
      i18next.changeLanguage(lang, () => applyTranslations());
    });

    /* ========== Data (Firestore realtime) ========== */
    const tbody = document.querySelector("#accessTable tbody");

    db.collection("requests").orderBy("createdAt","desc").onSnapshot(snapshot => {
      tbody.innerHTML = "";
      if (snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="7" data-i18n="noData">${i18next.t("noData")}</td></tr>`;
        applyTranslations();
        return;
      }
      snapshot.forEach(d => {
        const r = d.data();
        const status = (r.status || "pending").toLowerCase();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.fullName || ""}</td>
          <td>${r.email || ""}</td>
          <td>${r.organization || ""}</td>
          <td>${r.phone || ""}</td>
          <td>${r.purpose || ""}</td>
          <td class="status ${status}">${status}</td>
          <td>
            <button class="btn-inline btn-success" data-action="approved">${i18next.t("approve")}</button>
            <button class="btn-inline btn-danger" data-action="rejected">${i18next.t("reject")}</button>
            <button class="btn-inline btn-pending" data-action="pending">${i18next.t("pending")}</button>
            <button class="btn-inline btn-delete" data-action="delete">${i18next.t("delete")}</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      applyTranslations(); // ensure the just-inserted nodes are localized
    });

    /* ========== Search Filter ========== */
    document.getElementById("searchInput").addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      document.querySelectorAll("#accessTable tbody tr").forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? "" : "none";
      });
    });
  </script>
</body>
</html>
