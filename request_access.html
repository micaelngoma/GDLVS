<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Access Requests</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- jQuery + i18n -->
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <style>
    :root {
      --brand-dark:#2a3f54;
      --brand-dark-2:#1e2d3c;
      --panel-bg:rgba(255,255,255,0.9);
      --card-shadow:0 2px 8px rgba(0,0,0,0.25);
      --success:#27ae60;
      --danger:#e74c3c;
      --warn:#f1c40f;
    }

    * {box-sizing:border-box;}
    body {
      margin:0;
      font-family:Arial, sans-serif;
      background:#f6f8fb;
      color:#333;
      min-height:100vh;
    }

    header {
      position:fixed;
      top:0; left:0; right:0;
      z-index:1000;
      background:rgba(42,63,84,0.95);
      color:#fff;
      padding:10px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:var(--card-shadow);
      backdrop-filter:blur(8px);
    }
    header h1 {
      margin:0;
      font-size:1.1rem;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .controls {display:flex;gap:8px;align-items:center;}
    .controls select,
    .controls button {
      padding:6px 10px;
      border-radius:8px;
      border:0;
      font-size:.9rem;
    }
    .controls select {background:#fff;color:#000;}
    .controls button {background:var(--brand-dark-2);color:#fff;cursor:pointer;}
    .controls button:hover {background:#16222d;}

    nav {
      position:fixed;
      top:52px; left:0; right:0;
      z-index:999;
      background:rgba(255,255,255,0.9);
      border-bottom:1px solid #eaeaea;
      padding:10px 14px;
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      backdrop-filter:blur(6px);
    }
    nav a {
      color:var(--brand-dark);
      text-decoration:none;
      font-weight:bold;
      transition:.2s;
    }
    nav a:hover {color:var(--brand-dark-2);}
    nav a.active {
      border-bottom:2px solid var(--brand-dark);
      padding-bottom:3px;
    }

    .container {
      max-width:1200px;
      margin:130px auto 25px;
      padding:0 16px;
    }

    section.panel {
      background:var(--panel-bg);
      border-radius:10px;
      box-shadow:var(--card-shadow);
      padding:20px;
      margin-top:20px;
      backdrop-filter:blur(6px);
    }
    h2, h3 {color:var(--brand-dark);margin-top:0;}
    table {
      width:100%;
      border-collapse:separate;
      border-spacing:0 6px;
      margin-top:10px;
    }
    th, td {
      background:#fff;
      border:1px solid #eee;
      padding:10px 12px;
      text-align:left;
    }
    th {background:#f2f2f2;}
    td.status.pending {color:var(--warn);font-weight:bold;}
    td.status.approved {color:var(--success);font-weight:bold;}
    td.status.rejected {color:var(--danger);font-weight:bold;}
  </style>
</head>

<body>
  <header>
    <h1><i class="fa-solid fa-user-check"></i> <span data-i18n="accessRequestsTitle">Access Requests</span></h1>
    <div class="controls">
      <select id="languageSwitcher">
        <option value="en">🇬🇧 English</option>
        <option value="fr">🇫🇷 Français</option>
        <option value="ja">🇯🇵 日本語</option>
      </select>
      <button id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> <span data-i18n="signOut">Sign Out</span></button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> <span data-i18n="dashboard">Dashboard</span></a>
    <a href="verify.html"><i class="fa-solid fa-search"></i> <span data-i18n="verification">Verification</span></a>
    <a href="add_licenses.html"><i class="fa-solid fa-id-card"></i> <span data-i18n="addLicense">Add License</span></a>
    <a href="users.html"><i class="fa-solid fa-users"></i> <span data-i18n="users">Users</span></a>
    <a href="verification_requests.html"><i class="fa-solid fa-inbox"></i> <span data-i18n="requests">Verification Requests</span></a>
    <a class="active" href="request_access.html"><i class="fa-solid fa-user-lock"></i> <span data-i18n="accessRequests">Access Requests</span></a>
    <a href="analytics.html"><i class="fa-solid fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></a>
  </nav>

  <main class="container">
    <section class="panel">
      <h2><i class="fa-solid fa-table"></i> <span data-i18n="accessRequestsList">Access Requests List</span></h2>
      <table>
        <thead>
          <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Organization</th>
            <th>Phone</th>
            <th>Purpose</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="accessRequestsBody">
          <tr><td colspan="7" data-i18n="loading">Loading...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Firebase setup
    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Redirect to login if not authenticated
    onAuthStateChanged(auth, u => { if (!u) location.href = "index.html"; });
    document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => location.href = "index.html");

    const tbody = document.getElementById("accessRequestsBody");

    // Load requests
    async function loadRequests() {
      tbody.innerHTML = `<tr><td colspan="7">Loading...</td></tr>`;
      try {
        const qAccess = query(collection(db, "access_requests"), orderBy("createdAt", "desc"));
        const snap = await getDocs(qAccess);
        tbody.innerHTML = "";
        if (snap.empty) {
          tbody.innerHTML = `<tr><td colspan="7">No requests found.</td></tr>`;
          return;
        }
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString() : "—";
          const statusClass = (d.status || "pending").toLowerCase();
          tbody.innerHTML += `
            <tr>
              <td>${d.fullName || ""}</td>
              <td>${d.email || ""}</td>
              <td>${d.organization || ""}</td>
              <td>${d.phone || ""}</td>
              <td>${d.purpose || ""}</td>
              <td class="status ${statusClass}">${d.status || "Pending"}</td>
              <td>${date}</td>
            </tr>`;
        });
      } catch (err) {
        console.error("Error loading requests:", err);
        tbody.innerHTML = `<tr><td colspan="7" style="color:red;">Error loading data</td></tr>`;
      }
    }

    loadRequests();

    // i18n setup
    const i18nResources = {
      en: { translation: {
        accessRequestsTitle: "Access Requests",
        signOut: "Sign Out",
        dashboard: "Dashboard",
        verification: "Verification",
        addLicense: "Add License",
        users: "Users",
        requests: "Verification Requests",
        accessRequests: "Access Requests",
        analytics: "Analytics",
        accessRequestsList: "Access Requests List",
        loading: "Loading..."
      }},
      fr: { translation: {
        accessRequestsTitle: "Demandes d'accès",
        signOut: "Déconnexion",
        dashboard: "Tableau de bord",
        verification: "Vérification",
        addLicense: "Ajouter un permis",
        users: "Utilisateurs",
        requests: "Demandes de vérification",
        accessRequests: "Demandes d'accès",
        analytics: "Analytique",
        accessRequestsList: "Liste des demandes d'accès",
        loading: "Chargement..."
      }},
      ja: { translation: {
        accessRequestsTitle: "アクセスリクエスト",
        signOut: "ログアウト",
        dashboard: "ダッシュボード",
        verification: "照会",
        addLicense: "免許を追加",
        users: "ユーザー",
        requests: "照会リクエスト",
        accessRequests: "アクセスリクエスト",
        analytics: "分析",
        accessRequestsList: "アクセスリクエスト一覧",
        loading: "読み込み中..."
      }}
    };

    i18next.use(i18nextBrowserLanguageDetector).init({resources:i18nResources,fallbackLng:"en"},()=>{
      jqueryI18next.init(i18next,$,{useOptionsAttr:true});
      $("body").localize();
    });
    document.getElementById("languageSwitcher").addEventListener("change",function(){
      i18next.changeLanguage(this.value,()=>{$("body").localize();});
    });
  </script>
</body>
</html>
