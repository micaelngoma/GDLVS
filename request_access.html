<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Access Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- jQuery + i18n -->
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <style>
    body{font-family:Arial,sans-serif;margin:0;background:#f6f8fb;}
    header{background:#2a3f54;color:#fff;padding:10px 14px;
           display:flex;justify-content:space-between;align-items:center;}
    .controls select,.controls button{padding:6px 10px;border-radius:6px;border:0;}
    .controls button{background:#1e2d3c;color:#fff;cursor:pointer;}
    main{max-width:95%;margin:30px auto;background:#fff;padding:20px;
         border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
    table{width:100%;border-collapse:collapse;}
    th,td{border:1px solid #ddd;padding:8px;}
    th{background:#f4f4f4;}
    .status.approved{color:green;} .status.rejected{color:red;} .status.pending{color:orange;}
    .btn-inline{border:0;border-radius:4px;padding:4px 6px;margin:2px;color:#fff;cursor:pointer;}
    .btn-success{background:#27ae60;} .btn-danger{background:#e74c3c;} .btn-pending{background:#f1c40f;color:#000;} .btn-delete{background:#555;}
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-user-check"></i> <span data-i18n="pageTitle">Access Requests</span></h1>
    <div class="controls">
      <select id="languageSwitcher">
        <option value="en">🇬🇧 English</option>
        <option value="fr">🇫🇷 Français</option>
        <option value="ja">🇯🇵 日本語</option>
      </select>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span></button>
    </div>
  </header>

  <main>
    <h2><i class="fas fa-table"></i> <span data-i18n="recordsTitle">Access Request Records</span></h2>
    <input type="text" id="searchInput" placeholder="Search..." data-i18n="[placeholder]searchPlaceholder"
           style="padding:8px;width:50%;border-radius:6px;border:1px solid #ccc;display:block;margin:10px auto;">
    <table id="accessTable">
      <thead>
        <tr>
          <th data-i18n="name">Full Name</th>
          <th data-i18n="email">Email</th>
          <th data-i18n="org">Organization</th>
          <th data-i18n="phone">Phone</th>
          <th data-i18n="purpose">Purpose</th>
          <th data-i18n="status">Status</th>
          <th data-i18n="action">Action</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="7" data-i18n="loading">Loading...</td></tr></tbody>
    </table>
  </main>

  <script>
    /* ---------- Firebase Init ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    /* ---------- Translation Setup ---------- */
    const i18nResources = {
      en:{translation:{pageTitle:"Access Requests",logout:"Logout",recordsTitle:"Access Request Records",
        searchPlaceholder:"Search...",name:"Full Name",email:"Email",org:"Organization",phone:"Phone",
        purpose:"Purpose",status:"Status",action:"Action",approve:"Approve",reject:"Reject",
        pending:"Pending",delete:"Delete",noData:"No requests found",loading:"Loading..."}},
      fr:{translation:{pageTitle:"Demandes d'accès",logout:"Déconnexion",recordsTitle:"Enregistrements des demandes d'accès",
        searchPlaceholder:"Rechercher...",name:"Nom complet",email:"E-mail",org:"Organisation",phone:"Téléphone",
        purpose:"But",status:"Statut",action:"Action",approve:"Approuver",reject:"Rejeter",
        pending:"En attente",delete:"Supprimer",noData:"Aucune demande trouvée",loading:"Chargement..."}},
      ja:{translation:{pageTitle:"アクセスリクエスト",logout:"ログアウト",recordsTitle:"アクセスリクエスト記録",
        searchPlaceholder:"検索...",name:"氏名",email:"メール",org:"組織",phone:"電話",purpose:"目的",
        status:"状態",action:"操作",approve:"承認",reject:"拒否",pending:"保留",delete:"削除",
        noData:"リクエストが見つかりません",loading:"読み込み中..."}}
    };

    i18next.use(i18nextBrowserLanguageDetector).init(
      {resources:i18nResources,fallbackLng:"en"},
      ()=>{jqueryI18next.init(i18next,$,{useOptionsAttr:true});$("body").localize();}
    );

    document.getElementById("languageSwitcher").addEventListener("change",function(){
      i18next.changeLanguage(this.value,()=>{$("body").localize();});
    });

    /* ---------- Auth Guard ---------- */
    let authReady = false;
    auth.onAuthStateChanged(user=>{
      authReady = true;
      if(!user){
        window.location.replace("index.html");
      } else {
        loadRequests(); // start loading only after confirmed login
      }
    });

    /* ---------- Logout ---------- */
    document.getElementById("logoutBtn").addEventListener("click",()=>{
      // ensure Auth is initialized
      if(!authReady){console.warn("Auth not ready yet");return;}
      auth.signOut()
        .then(()=>window.location.replace("index.html"))
        .catch(e=>{
          console.error("Logout failed:",e);
          window.location.replace("index.html");
        });
    });

    /* ---------- Load Firestore Requests ---------- */
    function loadRequests(){
      const tbody=document.querySelector("#accessTable tbody");
      db.collection("requests").orderBy("createdAt","desc").onSnapshot(snap=>{
        tbody.innerHTML="";
        if(snap.empty){
          tbody.innerHTML=`<tr><td colspan="7">${i18next.t("noData")}</td></tr>`;
          $("body").localize();return;
        }
        snap.forEach(doc=>{
          const d=doc.data();
          const st=(d.status||"pending").toLowerCase();
          tbody.innerHTML+=`
            <tr>
              <td>${d.fullName||""}</td>
              <td>${d.email||""}</td>
              <td>${d.organization||""}</td>
              <td>${d.phone||""}</td>
              <td>${d.purpose||""}</td>
              <td class="status ${st}">${st}</td>
              <td>
                <button class="btn-inline btn-success">${i18next.t("approve")}</button>
                <button class="btn-inline btn-danger">${i18next.t("reject")}</button>
                <button class="btn-inline btn-pending">${i18next.t("pending")}</button>
                <button class="btn-inline btn-delete">${i18next.t("delete")}</button>
              </td>
            </tr>`;
        });
        $("body").localize();
      },err=>{
        console.error("Firestore error:",err);
        tbody.innerHTML=`<tr><td colspan="7" style="color:red;">Error loading data</td></tr>`;
      });
    }

    /* ---------- Search ---------- */
    document.getElementById("searchInput").addEventListener("input",e=>{
      const val=e.target.value.toLowerCase();
      document.querySelectorAll("#accessTable tbody tr").forEach(r=>{
        r.style.display=r.textContent.toLowerCase().includes(val)?"":"none";
      });
    });
  </script>
</body>
</html>
