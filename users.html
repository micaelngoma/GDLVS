<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - User Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f8fb;
      margin: 0;
      color: #333;
    }
    header {
      background: #2a3f54;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header button {
      background: #1e2d3c;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    nav {
      background: #fff;
      border-bottom: 1px solid #ddd;
      padding: 10px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    nav a {
      text-decoration: none;
      color: #2a3f54;
      font-weight: bold;
    }
    nav a.active {
      border-bottom: 2px solid #2a3f54;
    }
    .container {
      max-width: 1000px;
      margin: 25px auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input, select, button {
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      width: 100%;
    }
    .btn-export {
      width: auto;
      background: #2980b9;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-export:hover { background: #1f6392; }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 6px;
      margin-top: 15px;
    }
    th, td {
      background: #fff;
      border: 1px solid #eee;
      padding: 10px;
      text-align: left;
    }
    th { background: #f2f2f2; }
    .muted { color: #666; font-size: 0.95rem; }
    footer {
      text-align: center;
      margin: 25px 0;
    }
    #languageSwitcher {
      padding: 6px 10px;
      border-radius: 8px;
    }

    /* 🔹 Button colors fixed */
    .btn-edit {
      background: #27ae60 !important; /* green */
      color: #fff !important;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-edit:hover { background: #1f8f4f !important; }

    .btn-delete {
      background: #e74c3c !important; /* red */
      color: #fff !important;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-delete:hover { background: #c0392b !important; }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-users-cog"></i> <span data-i18n="userManagement">User Management</span></h1>
    <button onclick="signOutUser()"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span></button>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
    <a href="verify.html"><i class="fas fa-search"></i> Verification</a>
    <a href="add_licenses.html"><i class="fas fa-id-card"></i> Add License</a>
    <a href="users.html" class="active"><i class="fas fa-users-cog"></i> User Management</a>
    <a id="navVerificationRequests" href="verification_requests.html" style="display:none;"><i class="fas fa-inbox"></i> Requests</a>
    <a href="analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a>
  </nav>

  <main>
    <div class="container">
      <h2><i class="fas fa-users"></i> User Management</h2>
      <p class="muted">Admins can add, edit, or remove users directly from here.</p>

      <input type="text" id="userSearch" placeholder="Search users by name or email...">

      <form id="addUserForm" onsubmit="addNewUser(event)">
        <input type="text" id="newUserName" placeholder="Full Name" required>
        <input type="email" id="newUserEmail" placeholder="Email" required>
        <select id="newUserRole">
          <option value="verifier">Verifier</option>
          <option value="admin">Admin</option>
        </select>
        <button type="submit" class="btn-edit">
          <i class="fas fa-user-plus"></i> Add User
        </button>
      </form>

      <button class="btn-export" onclick="exportTableToCSV('usersTable','users')">📥 Export Users</button>

      <table class="table">
        <thead>
          <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="usersTable"><tr><td colspan="5">Loading...</td></tr></tbody>
      </table>
    </div>
  </main>

  <footer>
    <label for="languageSwitcher"><i class="fas fa-globe"></i></label>
    <select id="languageSwitcher">
      <option value="en">🇬🇧 English</option>
      <option value="fr">🇫🇷 Français</option>
      <option value="ja">🇯🇵 日本語</option>
    </select>
  </footer>

  <!-- 🔹 Script fix for Search + Button functions -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ✅ SEARCH FIX — works instantly
    function filterUsers() {
      const q = (document.getElementById("userSearch")?.value || "").trim().toLowerCase();
      const rows = document.querySelectorAll("#usersTable tr");
      rows.forEach(row => {
        if (!row.children || row.children.length < 2) return;
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(q) ? "" : "none";
      });
    }
    document.addEventListener("DOMContentLoaded", () => {
      const searchEl = document.getElementById("userSearch");
      if (searchEl) searchEl.addEventListener("input", filterUsers);
    });

    // ✅ FIRESTORE USERS LOADER
    db.collection("users").onSnapshot(snapshot => {
      const tbody = document.getElementById("usersTable");
      tbody.innerHTML = "";
      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='5'>No users found.</td></tr>";
        return;
      }
      snapshot.forEach(doc => {
        const d = doc.data();
        tbody.innerHTML += `
          <tr>
            <td>${d.fullName || ""}</td>
            <td>${d.email || ""}</td>
            <td>${d.role || "verifier"}</td>
            <td>${d.status || "active"}</td>
            <td>
              <button class="btn-edit" onclick="updateUser('${doc.id}')">Update</button>
              <button class="btn-delete" onclick="deleteUser('${doc.id}')">Delete</button>
            </td>
          </tr>`;
      });
    });

    // ✅ Add new user
    async function addNewUser(e) {
      e.preventDefault();
      const name = document.getElementById("newUserName").value.trim();
      const email = document.getElementById("newUserEmail").value.trim();
      const role = document.getElementById("newUserRole").value;
      if (!name || !email) return alert("Please fill all fields.");

      await db.collection("users").doc(email).set({
        fullName: name,
        email: email,
        role: role,
        status: "active"
      });
      document.getElementById("addUserForm").reset();
      alert("✅ User added successfully!");
    }

    // ✅ Update/Delete (demo actions)
    async function updateUser(id) {
      const newStatus = prompt("Enter new status (active/suspended):");
      if (!newStatus) return;
      await db.collection("users").doc(id).update({ status: newStatus });
      alert("✅ User updated.");
    }

    async function deleteUser(id) {
      if (confirm("Are you sure you want to delete this user?")) {
        await db.collection("users").doc(id).delete();
        alert("🗑️ User deleted.");
      }
    }

    // ✅ Export table to CSV
    function exportTableToCSV(tableId, filename) {
      const rows = document.querySelectorAll(`#${tableId} tr`);
      let csv = [];
      rows.forEach(row => {
        const cols = row.querySelectorAll("th, td");
        const data = Array.from(cols).map(col => '"' + col.innerText.replace(/"/g, '""') + '"');
        csv.push(data.join(","));
      });
      const blob = new Blob([csv.join("\n")], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${filename}.csv`;
      link.click();
    }
  </script>
</body>
</html>
