<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - User Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- i18n + jQuery -->
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <style>
    .background-image{position:fixed;inset:0;background:url('https://raw.githubusercontent.com/micaelngoma/GDLVS/main/Gabon%20Forest.jpg') no-repeat center center fixed;background-size:cover;z-index:-1;filter:brightness(0.95)}
    :root{--brand-dark:#2a3f54;--brand-dark-2:#1e2d3c;--text:#333;--panel-bg:#fff;--card-shadow:0 2px 6px rgba(0,0,0,.1);--success:#27ae60;--danger:#e74c3c;--info:#2980b9}
    body{margin:0;font-family:Arial,sans-serif;background:#f6f8fb;color:#333}
    header{background:var(--brand-dark);color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
    header h1{margin:0;font-size:1.1rem;display:flex;gap:8px;align-items:center}
    .controls{display:flex;gap:8px}
    .controls select,.controls button{padding:6px 10px;border-radius:8px;border:0}
    .controls select{background:#fff}
    .controls button{background:var(--brand-dark-2);color:#fff}
    nav{background:#fff;border-bottom:1px solid #eaeaea;padding:10px 14px;display:flex;gap:15px;flex-wrap:wrap}
    nav a{color:var(--brand-dark);font-weight:bold;text-decoration:none}
    nav a.active{border-bottom:2px solid var(--brand-dark);padding-bottom:3px}
    .container{max-width:1000px;margin:20px auto 40px;background:#fff;border-radius:10px;box-shadow:var(--card-shadow);padding:20px}
    .muted{color:#666}
    .table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:12px}
    .table th,.table td{border:1px solid #eee;padding:10px 14px;background:#fff}
    .table th{background:#f2f2f2}
    .btn-export{background:var(--info);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .inline{padding:6px 12px;border-radius:8px;border:0;color:#fff;cursor:pointer}
    .btn-edit{background:var(--success)}
    .btn-delete{background:var(--danger)}
    input,select{padding:10px;border:1px solid #dcdcdc;border-radius:8px}
  </style>
</head>
<body>
  <div class="background-image"></div>

  <header>
    <h1><i class="fas fa-users-cog"></i> <span data-i18n="userManagement">User Management</span></h1>
    <div class="controls">
      <select id="languageSwitcher">
        <option value="en">ðŸ‡¬ðŸ‡§ English</option><option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option><option value="ja">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
      </select>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span></button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fas fa-home"></i> <span data-i18n="dashboard">Dashboard</span></a>
    <a href="verify.html"><i class="fas fa-search"></i> <span data-i18n="verificationPortal">Verification</span></a>
    <a href="add_licenses.html"><i class="fas fa-id-card"></i> <span data-i18n="addLicense">Add License</span></a>
    <a href="users.html" class="active"><i class="fas fa-users-cog"></i> <span data-i18n="userManagement">User Management</span></a>
    <a id="navVerificationRequests" href="verification_requests.html"><i class="fas fa-inbox"></i> <span data-i18n="verificationRequests">Verification Requests</span></a>
    <a href="analytics.html"><i class="fas fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></a>
  </nav>

  <main>
    <div class="container">
      <h2><i class="fas fa-users"></i> <span data-i18n="userManagement">User Management</span></h2>
      <p class="muted" data-i18n="userTip">Admins can add, edit, or remove users directly from here.</p>

      <input type="text" id="userSearch" data-i18n="[placeholder]searchUsers" placeholder="Search users by name or email...">

      <form id="addUserForm">
        <input type="text" id="newUserName" data-i18n="[placeholder]fullName" placeholder="Full Name" required>
        <input type="email" id="newUserEmail" placeholder="Email" required data-i18n="[placeholder]emailPlaceholder">
        <select id="newUserRole">
          <option value="verifier">verifier</option>
          <option value="admin">admin</option>
        </select>
        <button type="submit" class="inline btn-edit"><i class="fas fa-user-plus"></i> <span data-i18n="addUser">Add User</span></button>
      </form>

      <button class="btn-export" id="exportUsers">ðŸ“¥ <span data-i18n="exportUsers">Export Users</span></button>

      <table class="table">
        <thead>
          <tr>
            <th data-i18n="fullName">Full Name</th>
            <th data-i18n="email">Email</th>
            <th data-i18n="role">Role</th>
            <th data-i18n="status">Status</th>
            <th data-i18n="action">Action</th>
          </tr>
        </thead>
        <tbody id="usersTable"><tr><td colspan="5" data-i18n="loading">Loading...</td></tr></tbody>
      </table>
    </div>
  </main>

  <footer style="text-align:center;margin:22px 0 40px;">
    <small class="muted">GDLVS</small>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const i18nResources = {
      en:{translation:{
        dashboard:"Dashboard", verificationPortal:"Verification", addLicense:"Add License", userManagement:"User Management", verificationRequests:"Verification Requests", analytics:"Analytics", logout:"Logout",
        userTip:"Admins can add, edit, or remove users directly from here.",
        searchUsers:"Search users by name or email...", fullName:"Full Name", email:"Email", role:"Role", status:"Status", action:"Action",
        addUser:"Add User", exportUsers:"Export Users", loading:"Loading...", emailPlaceholder:"Email"
      }},
      fr:{translation:{
        dashboard:"Tableau de bord", verificationPortal:"VÃ©rification", addLicense:"Ajouter un permis", userManagement:"Gestion des utilisateurs", verificationRequests:"Demandes de vÃ©rification", analytics:"Analytique", logout:"DÃ©connexion",
        userTip:"Les administrateurs peuvent ajouter, modifier ou supprimer des utilisateurs ici.",
        searchUsers:"Rechercher des utilisateurs par nom ou e-mailâ€¦", fullName:"Nom complet", email:"Email", role:"RÃ´le", status:"Statut", action:"Action",
        addUser:"Ajouter lâ€™utilisateur", exportUsers:"Exporter les utilisateurs", loading:"Chargement...", emailPlaceholder:"Email"
      }},
      ja:{translation:{
        dashboard:"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰", verificationPortal:"ç…§åˆ", addLicense:"å…è¨±ã‚’è¿½åŠ ", userManagement:"ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†", verificationRequests:"ç…§åˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ", analytics:"åˆ†æž", logout:"ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ",
        userTip:"ç®¡ç†è€…ã¯ã“ã“ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚",
        searchUsers:"æ°åã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢â€¦", fullName:"æ°å", email:"ãƒ¡ãƒ¼ãƒ«", role:"å½¹å‰²", status:"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", action:"æ“ä½œ",
        addUser:"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ", exportUsers:"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ", loading:"èª­ã¿è¾¼ã¿ä¸­â€¦", emailPlaceholder:"ãƒ¡ãƒ¼ãƒ«"
      }}
    };
    i18next.use(i18nextBrowserLanguageDetector).init({resources:i18nResources,fallbackLng:"en"},()=>{ jqueryI18next.init(i18next,$,{useOptionsAttr:true}); $("body").localize(); });
    document.getElementById("languageSwitcher").addEventListener("change", function(){ i18next.changeLanguage(this.value, ()=>$("body").localize()); });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="index.html"; return; }
      const roleSnap = await getDoc(doc(db,"roles",user.email));
      const adminOnly = document.getElementById("navVerificationRequests");
      adminOnly.style.display = (roleSnap.exists() && roleSnap.data().role==="admin") ? "block":"none";
    });
    document.getElementById("logoutBtn").addEventListener("click", ()=>signOut(auth).then(()=>location.href="index.html"));

    // Realtime users + roles
    const usersTbody = document.getElementById("usersTable");
    onSnapshot(collection(db,"users"), async (snap)=>{
      // Preload roles
      const rolesMap = {};
      const rolesSnap = await onSnapshot(collection(db,"roles"), ()=>{}); // dummy to ensure cache
      // Fallback single fetch of roles
      const rolesColl = await (await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js")).getDocs(collection(db,"roles"));
      rolesColl.forEach(r=>rolesMap[r.id]=(r.data().role||"verifier"));

      usersTbody.innerHTML="";
      if(snap.empty){ usersTbody.innerHTML = `<tr><td colspan="5">${i18next.t("loading")}</td></tr>`; return; }
      snap.forEach(uDoc=>{
        const u=uDoc.data(); const role=rolesMap[u.email]||u.role||"verifier";
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td contenteditable data-field="fullName">${u.fullName||""}</td>
          <td>${u.email}</td>
          <td>
            <select data-field="role">
              <option ${role==="verifier"?"selected":""}>verifier</option>
              <option ${role==="admin"?"selected":""}>admin</option>
            </select>
          </td>
          <td>
            <select data-field="status">
              <option ${u.status==="approved"?"selected":""}>approved</option>
              <option ${u.status==="pending"?"selected":""}>pending</option>
              <option ${u.status==="disabled"?"selected":""}>disabled</option>
            </select>
          </td>
          <td>
            <button class="inline btn-edit" data-email="${u.email}">${i18next.t("addUser")}</button>
            <button class="inline btn-delete" data-email="${u.email}">Delete</button>
          </td>`;
        usersTbody.appendChild(tr);
      });
    });

    // Add user
    document.getElementById("addUserForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const name = document.getElementById("newUserName").value.trim();
      const email = document.getElementById("newUserEmail").value.trim();
      const role = document.getElementById("newUserRole").value;
      if(!name||!email) return alert("Name & Email required");
      await setDoc(doc(db,"users",email),{fullName:name,email,status:"approved",approved:true},{merge:true});
      await setDoc(doc(db,"roles",email),{role},{merge:true});
      e.target.reset();
    });

    // Row actions (update/delete)
    usersTbody.addEventListener("click", async (e)=>{
      const t = e.target;
      if(t.closest(".btn-edit")){
        const email = t.dataset.email;
        const tr = t.closest("tr");
        const updates = {};
        tr.querySelectorAll("[data-field]").forEach(el=>{
          const key = el.dataset.field;
          updates[key] = (el.tagName==="TD") ? el.textContent.trim() : el.value;
        });
        await setDoc(doc(db,"users",email),{fullName:updates.fullName,status:updates.status,approved:(updates.status==="approved")},{merge:true});
        await setDoc(doc(db,"roles",email),{role:updates.role},{merge:true});
        alert("User updated");
      }
      if(t.closest(".btn-delete")){
        const email = t.dataset.email;
        if(!confirm(`Delete ${email}?`)) return;
        await deleteDoc(doc(db,"users",email));
        await deleteDoc(doc(db,"roles",email));
      }
    });

    // Search
    document.getElementById("userSearch").addEventListener("keyup",(e)=>{
      const term = e.target.value.toLowerCase();
      document.querySelectorAll("#usersTable tr").forEach(row=>{
        row.style.display = row.textContent.toLowerCase().includes(term) ? "" : "none";
      });
    });

    // Export
    document.getElementById("exportUsers").addEventListener("click", ()=>{
      const rows = document.querySelectorAll(".table tr");
      const csv = [];
      rows.forEach(r=>{
        const cols = r.querySelectorAll("th,td");
        csv.push(Array.from(cols).map(c=>`"${c.innerText.replace(/"/g,'""')}"`).join(","));
      });
      const blob = new Blob([csv.join("\n")],{type:"text/csv"});
      const a = document.createElement("a");
      a.href=URL.createObjectURL(blob); a.download="users_export.csv"; a.click();
    });
  </script>
</body>
</html>
