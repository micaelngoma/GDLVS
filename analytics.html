<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Analytics Dashboard</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase + i18n -->
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <style>
    :root {
      --brand-dark:#2a3f54;
      --brand-dark-2:#1e2d3c;
      --panel-bg:rgba(255,255,255,0.9);
      --card-shadow:0 2px 8px rgba(0,0,0,0.25);
      --success:#27ae60;
      --danger:#e74c3c;
      --warn:#f1c40f;
      --info:#2980b9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background:#f6f8fb;color:#333}
    header{position:fixed;top:0;left:0;right:0;z-index:1000;background:var(--brand-dark);color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;}
    header h1{margin:0;font-size:1.1rem;display:flex;align-items:center;gap:8px;}
    .controls{display:flex;gap:8px;align-items:center}
    .controls select,.controls button{padding:6px 10px;border-radius:8px;border:0;font-size:.9rem}
    .controls select{background:#fff;color:#000}
    .controls button{background:var(--brand-dark-2);color:#fff;cursor:pointer}
    nav{position:fixed;top:52px;left:0;right:0;background:#fff;padding:10px 14px;display:flex;gap:16px;border-bottom:1px solid #eaeaea;z-index:999}
    nav a{color:var(--brand-dark);font-weight:bold;text-decoration:none}
    nav a.active{border-bottom:2px solid var(--brand-dark)}
    .container{max-width:1200px;margin:130px auto;padding:0 16px}
    .dashboard-cards{display:flex;flex-wrap:wrap;gap:15px;margin:15px 0 25px;}
    .card{flex:1;min-width:200px;border-radius:12px;padding:16px;text-align:center;color:#fff;box-shadow:var(--card-shadow)}
    .card.total{background:var(--info)}.card.active{background:var(--success)}.card.pending{background:var(--warn)}.card.danger{background:var(--danger)}
    section.panel{background:var(--panel-bg);border-radius:10px;box-shadow:var(--card-shadow);padding:20px;margin-top:20px;}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #eee;padding:8px;text-align:left;background:#fff}
    th{background:#f2f2f2}
    .chart-row{display:flex;flex-wrap:wrap;gap:20px;margin-top:20px;}
    .chart-box{flex:1;min-width:300px;max-width:48%;background:var(--panel-bg);border-radius:10px;box-shadow:var(--card-shadow);padding:20px;}
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-chart-line"></i> GDLVS Analytics</h1>
    <div class="controls">
      <select id="languageSwitcher">
        <option value="en">ðŸ‡¬ðŸ‡§ English</option>
        <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
        <option value="ja">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
      </select>
      <button id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="verify.html"><i class="fa-solid fa-search"></i> Verification</a>
    <a href="add_licenses.html"><i class="fa-solid fa-id-card"></i> Add License</a>
    <a href="users.html"><i class="fa-solid fa-users"></i> Users</a>
    <a href="verification_requests.html"><i class="fa-solid fa-inbox"></i> Access Requests</a>
    <a class="active" href="analytics.html"><i class="fa-solid fa-chart-bar"></i> Analytics</a>
  </nav>

  <main class="container">
    <h2><i class="fa-solid fa-database"></i> System Overview</h2>
    <div class="dashboard-cards">
      <div class="card total"><i class="fa-solid fa-id-card"></i><h3>Licenses: <span id="totalLicenses">0</span></h3></div>
      <div class="card active"><i class="fa-solid fa-magnifying-glass"></i><h3>Verifications: <span id="totalVerifications">0</span></h3></div>
      <div class="card pending"><i class="fa-solid fa-user-clock"></i><h3>Pending Users: <span id="pendingUsers">0</span></h3></div>
      <div class="card danger"><i class="fa-solid fa-envelope"></i><h3>Pending Requests: <span id="pendingRequests">0</span></h3></div>
      <div class="card total"><i class="fa-solid fa-globe"></i><h3>Countries: <span id="countriesCount">0</span></h3></div>
    </div>

    <div class="chart-row">
      <div class="chart-box">
        <h3><i class="fa-solid fa-chart-pie"></i> Verification Performance</h3>
        <canvas id="resultChart"></canvas>
      </div>
      <div class="chart-box">
        <h3><i class="fa-solid fa-chart-bar"></i> Top Countries</h3>
        <canvas id="countryChart"></canvas>
      </div>
    </div>

    <section class="panel">
      <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Verifications</h3>
      <table>
        <thead><tr><th>License #</th><th>Organization</th><th>Country</th><th>Result</th><th>Date</th></tr></thead>
        <tbody id="verificationLogs"><tr><td colspan="5">Loading...</td></tr></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, u => { if (!u) location.href = "index.html"; });
    document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => location.href = "index.html");

    const totalLicensesEl = document.getElementById("totalLicenses");
    const totalVerificationsEl = document.getElementById("totalVerifications");
    const pendingUsersEl = document.getElementById("pendingUsers");
    const pendingRequestsEl = document.getElementById("pendingRequests");
    const countriesCountEl = document.getElementById("countriesCount");
    const logsBody = document.getElementById("verificationLogs");

    let resultChart, countryChart;

    async function loadAnalytics() {
      // --- 1. Licenses Count
      const licensesSnap = await getDocs(collection(db, "licenses"));
      totalLicensesEl.textContent = licensesSnap.size;

      // --- 2. Pending Users
      const usersSnap = await getDocs(collection(db, "users"));
      let pendingU = 0;
      usersSnap.forEach(d => {
        const st = (d.data().status || "").toLowerCase();
        if (st === "pending" || st === "inactive") pendingU++;
      });
      pendingUsersEl.textContent = pendingU;

      // --- 3. Pending Access Requests
      const reqSnap = await getDocs(collection(db, "verification_requests"));
      let pendingR = 0;
      reqSnap.forEach(d => {
        const s = (d.data().status || "").toLowerCase();
        if (s === "pending" || s === "awaiting") pendingR++;
      });
      pendingRequestsEl.textContent = pendingR;

      // --- 4. Verifications
      const verSnap = await getDocs(query(collection(db, "verifications"), orderBy("verifiedAt", "desc")));
      let total = 0, ok = 0, fail = 0;
      const countries = {};
      logsBody.innerHTML = "";
      verSnap.forEach(doc => {
        const v = doc.data();
        total++;
        const result = (v.result || "").toLowerCase();
        if (result.includes("fail") || result.includes("invalid") || result.includes("not")) fail++;
        else ok++;
        const c = (v.country || "Unknown").trim();
        const org = v.organization || v.verifierOrg || "â€”";
        countries[c] = (countries[c] || 0) + 1;
        logsBody.innerHTML += `
          <tr>
            <td>${v.licenseNumber || ""}</td>
            <td>${org}</td>
            <td>${c}</td>
            <td>${v.result || ""}</td>
            <td>${v.verifiedAt ? new Date(v.verifiedAt.seconds * 1000).toLocaleString() : ""}</td>
          </tr>`;
      });

      totalVerificationsEl.textContent = total;
      countriesCountEl.textContent = Object.keys(countries).length;

      // --- 5. Charts
      if (resultChart) resultChart.destroy();
      resultChart = new Chart(document.getElementById("resultChart"), {
        type: "doughnut",
        data: {
          labels: ["Successful", "Failed"],
          datasets: [{ data: [ok, fail], backgroundColor: ["#27ae60", "#e74c3c"] }]
        },
        options: { plugins: { legend: { position: "bottom" } } }
      });

      if (countryChart) countryChart.destroy();
      const top5 = Object.entries(countries).sort((a,b)=>b[1]-a[1]).slice(0,5);
      countryChart = new Chart(document.getElementById("countryChart"), {
        type: "bar",
        data: {
          labels: top5.map(e => e[0]),
          datasets: [{ label: "Verifications", data: top5.map(e => e[1]), backgroundColor: "#2980b9" }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }
    loadAnalytics();
  </script>
</body>
</html>
