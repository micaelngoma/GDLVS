<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Analytics Dashboard</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- üîß Load order for i18n (VERY IMPORTANT) -->
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script>window.$ = window.jQuery = window.$ || window.jQuery;</script>
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <style>
    :root {
      --brand:#2a3f54; --brand2:#1e2d3c; --success:#27ae60; --danger:#e74c3c; --info:#2980b9;
      --shadow:0 2px 6px rgba(0,0,0,.1);
    }
    body{margin:0;font-family:Arial, sans-serif;background:#f6f8fb;color:#333;}
    header{background:var(--brand);color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;}
    header h1{margin:0;font-size:18px;display:flex;align-items:center;gap:8px;}
    .header-controls{display:flex;gap:8px;}
    .mini-btn{background:var(--brand2);color:#fff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer;}
    .mini-select{border:1px solid #ccc;border-radius:8px;padding:6px 8px;font-size:12px;background:#fff;}
    nav{background:#fff;border-bottom:1px solid #eaeaea;padding:10px 14px;display:flex;gap:14px;flex-wrap:wrap;}
    nav a{color:var(--brand);text-decoration:none;font-weight:700;}
    nav a.active{border-bottom:2px solid var(--brand);padding-bottom:4px;}
    .container{max-width:1200px;margin:20px auto;padding:0 14px;}
    .dashboard-cards{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:10px 0 20px;}
    .card{flex:1 1 200px;max-width:220px;min-width:160px;border-radius:12px;color:#fff;text-align:center;padding:14px;box-shadow:var(--shadow);}
    .card i{display:block;margin-bottom:6px;}
    .card.total{background:var(--info);}
    .card.active{background:var(--success);}
    .card.pending{background:#f39c12;}
    .card.danger{background:var(--danger);}
    section.panel{background:#fff;border-radius:10px;box-shadow:var(--shadow);padding:20px;margin-top:20px;}
    h2,h3{color:var(--brand);}
    table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:10px;}
    th,td{background:#fff;border:1px solid #eee;padding:10px 12px;}
    th{background:#f2f2f2;}
    canvas{max-width:100%;margin:20px auto;display:block;}
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-chart-line"></i> <span data-i18n="analyticsTitle">GDLVS Analytics</span></h1>
    <div class="header-controls">
      <select id="languageSwitcher" class="mini-select" aria-label="Language">
        <option value="en">üá¨üáß English</option>
        <option value="fr">üá´üá∑ Fran√ßais</option>
        <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
      </select>
      <button id="logoutBtn" class="mini-btn"><i class="fa-solid fa-right-from-bracket"></i> <span data-i18n="signOut">Sign Out</span></button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> <span data-i18n="dashboard">Dashboard</span></a>
    <a href="verify.html"><i class="fa-solid fa-search"></i> <span data-i18n="verification">Verification</span></a>
    <a href="add_licenses.html"><i class="fa-solid fa-id-card"></i> <span data-i18n="addLicense">Add License</span></a>
    <a href="users.html"><i class="fa-solid fa-users"></i> <span data-i18n="users">Users</span></a>
    <a href="verification_requests.html"><i class="fa-solid fa-inbox"></i> <span data-i18n="requests">Access Requests</span></a>
    <a class="active" href="analytics.html"><i class="fa-solid fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></a>
  </nav>

  <main class="container">
    <h2><i class="fa-solid fa-database"></i> <span data-i18n="systemOverview">System Overview</span></h2>
    <div class="dashboard-cards">
      <div class="card total"><i class="fa-solid fa-id-card"></i><h3><span data-i18n="licenses">Licenses</span>: <span id="totalLicenses">0</span></h3></div>
      <div class="card active"><i class="fa-solid fa-magnifying-glass"></i><h3><span data-i18n="verifications">Verifications</span>: <span id="totalVerifications">0</span></h3></div>
      <div class="card pending"><i class="fa-solid fa-user-clock"></i><h3><span data-i18n="pendingUsers">Pending Users</span>: <span id="pendingUsers">0</span></h3></div>
      <div class="card danger"><i class="fa-solid fa-envelope"></i><h3><span data-i18n="pendingRequests">Pending Requests</span>: <span id="pendingRequests">0</span></h3></div>
      <div class="card total"><i class="fa-solid fa-globe"></i><h3><span data-i18n="countries">Countries</span>: <span id="countriesCount">0</span></h3></div>
    </div>

    <section class="panel">
      <h3><i class="fa-solid fa-chart-pie"></i> <span data-i18n="verificationPerformance">Verification Performance</span></h3>
      <canvas id="resultChart"></canvas>
    </section>

    <section class="panel">
      <h3><i class="fa-solid fa-chart-bar"></i> <span data-i18n="topCountries">Top Countries</span></h3>
      <canvas id="countryChart"></canvas>
    </section>

    <section class="panel">
      <h3><i class="fa-solid fa-clock-rotate-left"></i> <span data-i18n="recentVerifications">Recent Verifications</span></h3>
      <table>
        <thead>
          <tr>
            <th>License #</th><th>Organization</th><th>Country</th><th>Result</th><th>Date</th>
          </tr>
        </thead>
        <tbody id="verificationLogs"><tr><td colspan="5" data-i18n="loading">Loading...</td></tr></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    /* ========= Firebase (inline, no external file needed) ========= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ========= i18n ========= */
    const i18nData = {
      en:{translation:{analyticsTitle:"GDLVS Analytics",signOut:"Sign Out",dashboard:"Dashboard",verification:"Verification",addLicense:"Add License",users:"Users",requests:"Access Requests",analytics:"Analytics",systemOverview:"System Overview",licenses:"Licenses",verifications:"Verifications",pendingUsers:"Pending Users",pendingRequests:"Pending Requests",countries:"Countries",verificationPerformance:"Verification Performance",topCountries:"Top Countries",recentVerifications:"Recent Verifications",loading:"Loading..."}},
      fr:{translation:{analyticsTitle:"Analyse GDLVS",signOut:"D√©connexion",dashboard:"Tableau de bord",verification:"V√©rification",addLicense:"Ajouter un permis",users:"Utilisateurs",requests:"Demandes d‚Äôacc√®s",analytics:"Analytique",systemOverview:"Aper√ßu du syst√®me",licenses:"Permis",verifications:"V√©rifications",pendingUsers:"Utilisateurs en attente",pendingRequests:"Demandes en attente",countries:"Pays",verificationPerformance:"Performance de v√©rification",topCountries:"Meilleurs pays",recentVerifications:"V√©rifications r√©centes",loading:"Chargement..."}},
      ja:{translation:{analyticsTitle:"GDLVS ÂàÜÊûê",signOut:"„É≠„Ç∞„Ç¢„Ç¶„Éà",dashboard:"„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ",verification:"ÁÖß‰ºö",addLicense:"ÂÖçË®±„ÇíËøΩÂä†",users:"„É¶„Éº„Ç∂„Éº",requests:"„Ç¢„ÇØ„Çª„Çπ„É™„ÇØ„Ç®„Çπ„Éà",analytics:"ÂàÜÊûê",systemOverview:"„Ç∑„Çπ„ÉÜ„É†Ê¶ÇË¶Å",licenses:"ÂÖçË®±",verifications:"ÁÖß‰ºö‰ª∂Êï∞",pendingUsers:"‰øùÁïô‰∏≠„ÅÆ„É¶„Éº„Ç∂„Éº",pendingRequests:"‰øùÁïô‰∏≠„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà",countries:"ÂõΩ",verificationPerformance:"ÁÖß‰ºö„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ",topCountries:"‰∏ä‰Ωç„ÅÆÂõΩ",recentVerifications:"ÊúÄËøë„ÅÆÁÖß‰ºö",loading:"Ë™≠„ÅøËæº„Åø‰∏≠..."}}
    };

    function applyI18n(){
      if (window.jqueryI18next && typeof $("body").localize === "function") $("body").localize();
      document.title = i18next.t("analyticsTitle");
      const short = (i18next.language||"en").split("-")[0];
      const sel = document.getElementById("languageSwitcher");
      if (sel && sel.value !== short) sel.value = short;
      document.documentElement.setAttribute("lang", short);
    }

    i18next.use(i18nextBrowserLanguageDetector).init(
      { resources:i18nData, fallbackLng:"en" },
      () => { jqueryI18next.init(i18next,$,{useOptionsAttr:true}); applyI18n(); }
    );
    i18next.on("languageChanged", applyI18n);
    document.getElementById("languageSwitcher").addEventListener("change", function(){
      i18next.changeLanguage(this.value);
    });

    /* ========= Auth ========= */
    onAuthStateChanged(auth,u=>{ if(!u) location.href='index.html'; });
    document.getElementById("logoutBtn").onclick = () => signOut(auth).then(()=>location.href='index.html');

    /* ========= Dashboard Logic ========= */
    const el = (id)=>document.getElementById(id);
    const totalLicensesEl     = el("totalLicenses");
    const totalVerificationsEl= el("totalVerifications");
    const pendingUsersEl      = el("pendingUsers");
    const pendingRequestsEl   = el("pendingRequests");
    const countriesCountEl    = el("countriesCount");
    const logsBody            = el("verificationLogs");
    let resultChart, countryChart;

    function formatDate(ts){
      try{
        if (ts?.toDate) return ts.toDate().toLocaleString();
        return ts ? new Date(ts).toLocaleString() : "";
      }catch{ return ""; }
    }

    async function loadAnalytics(){
      try{
        // Licenses count
        const licensesSnap = await getDocs(collection(db,"licenses"));
        totalLicensesEl.textContent = licensesSnap.size;

        // Pending users
        const usersSnap = await getDocs(collection(db,"users"));
        let pendingU = 0;
        usersSnap.forEach(d=>{
          const s = (d.data().status||"").toLowerCase();
          if (s === "pending") pendingU++;
        });
        pendingUsersEl.textContent = pendingU;

        // Pending access requests
        const reqSnap = await getDocs(collection(db,"requests"));
        let pendingReq = 0;
        reqSnap.forEach(d=>{
          const s = (d.data().status||"").toLowerCase();
          if (!s || s === "pending") pendingReq++;
        });
        pendingRequestsEl.textContent = pendingReq;

        // Verifications with charts + table
        const verSnap = await getDocs(query(collection(db,"verifications"), orderBy("verifiedAt","desc")));
        let total = 0, ok = 0, fail = 0;
        const countries = {};
        logsBody.innerHTML = "";

        verSnap.forEach(doc=>{
          const v = doc.data(); total++;
          const res = (v.result||"").toLowerCase();
          if (res.includes("not") || res.includes("fail")) fail++; else ok++;

          const c = (v.country || "Unknown").trim();
          countries[c] = (countries[c]||0) + 1;

          const row = document.createElement("tr");
          row.innerHTML =
            `<td>${v.licenseNumber || v.license || ""}</td>
             <td>${v.requestingOrg || v.organization || ""}</td>
             <td>${c}</td>
             <td>${v.result || ""}</td>
             <td>${formatDate(v.verifiedAt)}</td>`;
          logsBody.appendChild(row);
        });

        totalVerificationsEl.textContent = total;
        countriesCountEl.textContent = Object.keys(countries).length;

        // Result chart
        const ctx = document.getElementById("resultChart");
        if (resultChart) resultChart.destroy();
        resultChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: ["Successful","Failed"],
            datasets: [{ data:[ok,fail] }]
          },
          options: { plugins:{ legend:{ position:"bottom" } } }
        });

        // Top countries chart
        const top5 = Object.entries(countries).sort((a,b)=>b[1]-a[1]).slice(0,5);
        const ctx2 = document.getElementById("countryChart");
        if (countryChart) countryChart.destroy();
        countryChart = new Chart(ctx2, {
          type: "bar",
          data: {
            labels: top5.map(e=>e[0]),
            datasets: [{ label: "Verifications", data: top5.map(e=>e[1]) }]
          },
          options: { plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
        });

        // If no logs, show a friendly line
        if (!logsBody.children.length){
          logsBody.innerHTML = `<tr><td colspan="5">${i18next.t("loading")}</td></tr>`;
        }
      }catch(err){
        console.error("‚ùå Firestore read error:", err);
      }
    }

    // Initial load + refresh every 60s
    await loadAnalytics();
    setInterval(loadAnalytics, 60000);
  </script>
</body>
</html>
