<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Analytics Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--brand:#2a3f54;--brand2:#1e2d3c;--success:#27ae60;--danger:#e74c3c;--info:#2980b9;--shadow:0 2px 6px rgba(0,0,0,.1)}
    body{margin:0;font-family:Arial;background:#f6f8fb;color:#333}
    header{background:var(--brand);color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 14px}
    header h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
    .header-controls{display:flex;gap:8px}
    .mini-btn{background:var(--brand2);color:#fff;border:0;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
    .mini-select{border:1px solid #dcdcdc;border-radius:8px;padding:6px 8px;font-size:12px;background:#fff}
    nav{background:#fff;border-bottom:1px solid #eaeaea;padding:10px 14px;display:flex;gap:14px}
    nav a{color:var(--brand);text-decoration:none;font-weight:700}
    nav a.active{border-bottom:2px solid var(--brand);padding-bottom:4px}
    .container{max-width:1200px;margin:20px auto;padding:0 14px}
    .dashboard-cards{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:10px 0 20px}
    .card{flex:1 1 200px;max-width:220px;min-width:160px;border-radius:12px;color:#fff;text-align:center;padding:14px;box-shadow:var(--shadow)}
    .card i{display:block;margin-bottom:6px}
    .card.total{background:var(--info)}.card.active{background:var(--success)}.card.pending{background:#f39c12}.card.danger{background:var(--danger)}
    section.panel{background:#fff;border-radius:10px;box-shadow:var(--shadow);padding:20px;margin-top:20px}
    h2,h3{color:var(--brand)}
    table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:10px}
    th,td{background:#fff;border:1px solid #eee;padding:10px 12px}
    th{background:#f2f2f2}
    canvas{max-width:100%;margin:20px auto;display:block}
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-chart-line"></i> GDLVS Analytics</h1>
    <div class="header-controls">
      <select id="languageSwitcher" class="mini-select">
        <option value="en">ðŸ‡¬ðŸ‡§ English</option><option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option><option value="ja">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
      </select>
      <button id="logoutBtn" class="mini-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="verify.html"><i class="fa-solid fa-search"></i> Verification</a>
    <a href="add_licenses.html"><i class="fa-solid fa-id-card"></i> Add License</a>
    <a href="users.html"><i class="fa-solid fa-users-cog"></i> Users</a>
    <a href="verification_requests.html"><i class="fa-solid fa-inbox"></i> Requests</a>
    <a class="active" href="analytics.html"><i class="fa-solid fa-chart-bar"></i> Analytics</a>
  </nav>

  <main class="container">
    <h2><i class="fa-solid fa-database"></i> System Overview</h2>
    <div class="dashboard-cards">
      <div class="card total"><i class="fa-solid fa-id-card"></i><h3>Licenses: <span id="totalLicenses">0</span></h3></div>
      <div class="card active"><i class="fa-solid fa-magnifying-glass"></i><h3>Verifications: <span id="totalVerifications">0</span></h3></div>
      <div class="card pending"><i class="fa-solid fa-user-clock"></i><h3>Pending Users: <span id="pendingUsers">0</span></h3></div>
      <div class="card danger"><i class="fa-solid fa-envelope"></i><h3>Pending Requests: <span id="pendingRequests">0</span></h3></div>
      <div class="card total"><i class="fa-solid fa-globe"></i><h3>Countries: <span id="countriesCount">0</span></h3></div>
    </div>

    <section class="panel">
      <h3><i class="fa-solid fa-chart-pie"></i> Verification Performance</h3>
      <canvas id="resultChart"></canvas>
    </section>

    <section class="panel">
      <h3><i class="fa-solid fa-chart-bar"></i> Top Countries</h3>
      <canvas id="countryChart"></canvas>
    </section>

    <section class="panel">
      <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Verifications</h3>
      <table>
        <thead>
          <tr><th>License #</th><th>Organization</th><th>Country</th><th>Result</th><th>Date</th></tr>
        </thead>
        <tbody id="verificationLogs"><tr><td colspan="5">Loading...</td></tr></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
    import { collection, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

    // Auth guard
    onAuthStateChanged(auth,u=>{ if(!u) location.href='index.html'; });
    document.getElementById('logoutBtn').onclick=()=>signOut(auth).then(()=>location.href='index.html');

    const logsBody=document.getElementById('verificationLogs');
    const totalLicenses=document.getElementById('totalLicenses');
    const totalVerifications=document.getElementById('totalVerifications');
    const pendingUsers=document.getElementById('pendingUsers');
    const pendingRequests=document.getElementById('pendingRequests');
    const countriesCount=document.getElementById('countriesCount');

    // Firestore collections
    const verificationsQ=query(collection(db,'verifications'),orderBy('verifiedAt','desc'));
    const usersQ=collection(db,'users');
    const requestsQ=collection(db,'requests');
    const licensesQ=collection(db,'licenses');

    let resultChart,countryChart;

    // ðŸŸ¢ Verifications listener
    onSnapshot(verificationsQ,(snap)=>{
      let ok=0,fail=0,total=0;
      const countries={};
      logsBody.innerHTML='';
      snap.forEach(d=>{
        const v=d.data(); total++;
        const res=(v.result||'').toLowerCase();
        if(res.includes('not')||res.includes('fail')) fail++; else ok++;
        const c=(v.country||'Unknown').trim();
        countries[c]=(countries[c]||0)+1;
        const date=v.verifiedAt?.toDate?.()?v.verifiedAt.toDate().toLocaleString():v.verifiedAt||'';
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${v.licenseNumber||''}</td><td>${v.requestingOrg||''}</td><td>${c}</td><td>${v.result||''}</td><td>${date}</td>`;
        logsBody.appendChild(tr);
      });

      totalVerifications.textContent=total;
      countriesCount.textContent=Object.keys(countries).length;

      // Pie chart
      const ctx=document.getElementById('resultChart');
      if(resultChart) resultChart.destroy();
      resultChart=new Chart(ctx,{type:'pie',data:{labels:['Successful','Failed'],datasets:[{data:[ok,fail],backgroundColor:['#27ae60','#e74c3c']}]},options:{plugins:{legend:{position:'bottom'}}}});

      // Top 5 countries bar chart
      const sorted=Object.entries(countries).sort((a,b)=>b[1]-a[1]).slice(0,5);
      const ctx2=document.getElementById('countryChart');
      if(countryChart) countryChart.destroy();
      countryChart=new Chart(ctx2,{type:'bar',data:{labels:sorted.map(x=>x[0]),datasets:[{label:'Verifications',data:sorted.map(x=>x[1]),backgroundColor:'#2980b9'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    });

    // ðŸ‘¥ Users
    onSnapshot(usersQ,(snap)=>{
      let pending=0;
      snap.forEach(u=>{ if(u.data().status==='pending') pending++; });
      pendingUsers.textContent=pending;
    });

    // ðŸ“¬ Requests
    onSnapshot(requestsQ,(snap)=>{
      pendingRequests.textContent=snap.size;
    });

    // ðŸªª Licenses
    onSnapshot(licensesQ,(snap)=>{
      totalLicenses.textContent=snap.size;
    });
  </script>
</body>
</html>
