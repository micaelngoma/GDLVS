<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Analytics</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{--brand:#2a3f54;--brand2:#1e2d3c;--info:#2980b9;--shadow:0 2px 6px rgba(0,0,0,.1)}
    body{margin:0;font-family:Arial;background:#f6f8fb;color:#333}
    header{background:#2a3f54;color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 14px}
    header h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
    .header-controls{display:flex;gap:8px}
    .mini-btn{background:#1e2d3c;color:#fff;border:0;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
    .mini-select{border:1px solid #dcdcdc;border-radius:8px;padding:6px 8px;font-size:12px;background:#fff}
    nav{background:#fff;border-bottom:1px solid #eaeaea;padding:10px 14px;display:flex;gap:14px}
    nav a{color:#2a3f54;text-decoration:none;font-weight:700}
    nav a.active{border-bottom:2px solid #2a3f54;padding-bottom:4px}
    .container{max-width:1100px;margin:20px auto;padding:0 14px}
    .panel{background:#fff;border-radius:10px;box-shadow:var(--shadow);padding:20px}
    .dashboard-cards{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:10px 0 16px}
    .card{flex:1 1 180px;max-width:210px;min-width:150px;border-radius:12px;color:#fff;text-align:center;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .card i{display:block;margin-bottom:6px}
    .card.total{background:#2980b9}.card.active{background:#27ae60}.card.inactive{background:#e74c3c}
    .table-controls{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap}
    .table-controls input{max-width:300px;border:1px solid #dcdcdc;border-radius:8px;padding:8px 10px}
    .btn-export{background:#2980b9;color:#fff;border:0;border-radius:8px;padding:8px 12px}
    table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:10px}
    th,td{background:#fff;border:1px solid #eee;padding:10px 12px}
    th{background:#f2f2f2}
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></h1>
    <div class="header-controls">
      <select id="languageSwitcher" class="mini-select">
        <option value="en">🇬🇧 English</option><option value="fr">🇫🇷 Français</option><option value="ja">🇯🇵 日本語</option>
      </select>
      <button id="logoutBtn" class="mini-btn"><i class="fa-solid fa-right-from-bracket"></i> <span data-i18n="logout">Logout</span></button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> <span data-i18n="dashboard">Dashboard</span></a>
    <a href="verify.html"><i class="fa-solid fa-search"></i> <span data-i18n="verificationPortal">Verification</span></a>
    <a href="add_licenses.html"><i class="fa-solid fa-id-card"></i> <span data-i18n="addLicense">Add License</span></a>
    <a href="users.html"><i class="fa-solid fa-users-cog"></i> <span data-i18n="userManagement">Users</span></a>
    <a href="verification_requests.html"><i class="fa-solid fa-inbox"></i> <span data-i18n="requests">Requests</span></a>
    <a class="active" href="analytics.html"><i class="fa-solid fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></a>
  </nav>

  <main class="container">
    <h2><i class="fa-solid fa-chart-line"></i> <span data-i18n="verificationInsights">Verification Insights</span></h2>
    <div class="dashboard-cards">
      <div class="card total"><i class="fa-solid fa-search"></i><h3><span data-i18n="total">Total</span>: <span id="totalVerifications">0</span></h3></div>
      <div class="card active"><i class="fa-solid fa-circle-check"></i><h3><span data-i18n="successful">Successful</span>: <span id="successfulVerifications">0</span></h3></div>
      <div class="card inactive"><i class="fa-solid fa-circle-xmark"></i><h3><span data-i18n="unsuccessful">Unsuccessful</span>: <span id="failedVerifications">0</span></h3></div>
    </div>

    <section class="panel">
      <h3><i class="fa-solid fa-clock-rotate-left"></i> <span data-i18n="recentVerifications">Recent Verifications</span></h3>
      <div class="table-controls">
        <input id="analyticsSearch" type="text" data-i18n="[placeholder]searchLogsPh" placeholder="Search logs by license, org, or country...">
        <button class="btn-export" id="exportLogs"><i class="fa-solid fa-file-export"></i> <span data-i18n="export">Export</span></button>
      </div>
      <div class="verification-table-wrapper">
        <table>
          <thead>
            <tr>
              <th data-i18n="licenseNumber">License #</th>
              <th data-i18n="organization">Organization</th>
              <th data-i18n="country">Country</th>
              <th data-i18n="result">Result</th>
              <th data-i18n="date">Date</th>
            </tr>
          </thead>
          <tbody id="verificationLogs"><tr><td colspan="5" data-i18n="loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const i18n={en:{analytics:"Analytics",logout:"Logout",dashboard:"Dashboard",verificationPortal:"Verification",addLicense:"Add License",userManagement:"User Management",requests:"Requests",verificationInsights:"Verification Insights",total:"Total",successful:"Successful",unsuccessful:"Unsuccessful",recentVerifications:"Recent Verifications",searchLogsPh:"Search logs by license, org, or country...",export:"Export",licenseNumber:"License #",organization:"Organization",country:"Country",result:"Result",date:"Date",loading:"Loading..."},
               fr:{analytics:"Analytique",logout:"Déconnexion",dashboard:"Tableau de bord",verificationPortal:"Vérification",addLicense:"Ajouter un permis",userManagement:"Gestion des utilisateurs",requests:"Demandes",verificationInsights:"Aperçus des vérifications",total:"Total",successful:"Réussies",unsuccessful:"Échouées",recentVerifications:"Vérifications récentes",searchLogsPh:"Rechercher par permis, org. ou pays…",export:"Exporter",licenseNumber:"N° de permis",organization:"Organisation",country:"Pays",result:"Résultat",date:"Date",loading:"Chargement..."},
               ja:{analytics:"分析",logout:"ログアウト",dashboard:"ダッシュボード",verificationPortal:"照会",addLicense:"免許を追加",userManagement:"ユーザー管理",requests:"リクエスト",verificationInsights:"照会インサイト",total:"合計",successful:"成功",unsuccessful:"失敗",recentVerifications:"最近の照会",searchLogsPh:"番号/組織/国で検索…",export:"エクスポート",licenseNumber:"免許番号",organization:"組織",country:"国",result:"結果",date:"日付",loading:"読み込み中…"}};
    let lang=localStorage.getItem('gdlvs_lang')||'en';
    const t=(k)=>i18n[lang][k]||i18n.en[k];
    const apply=()=>document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k=el.dataset.i18n; if(k.startsWith('[placeholder]')) el.placeholder=t(k.replace('[placeholder]','')); else el.textContent=t(k);
    });
    const sel=document.getElementById('languageSwitcher'); sel.value=lang; apply();
    sel.onchange=()=>{lang=sel.value;localStorage.setItem('gdlvs_lang',lang);apply();};

    onAuthStateChanged(auth,u=>{if(!u) location.href='index.html';});
    document.getElementById('logoutBtn').onclick=()=>signOut(auth).then(()=>location.href='index.html');

    const tbody=document.getElementById('verificationLogs');
    const qv=query(collection(db,'verifications'), orderBy('verifiedAt','desc'));
    onSnapshot(qv,(snap)=>{
      let total=0,ok=0,fail=0; tbody.innerHTML='';
      if(snap.empty){ tbody.innerHTML=`<tr><td colspan="5">${t('loading')}</td></tr>`; }
      snap.forEach(d=>{
        const v=d.data(); total++;
        const res=(v.result||'').toLowerCase();
        if(res.includes('not')||res.includes('fail')) fail++; else ok++;
        const dt=v.verifiedAt?.toDate?.() ? v.verifiedAt.toDate().toLocaleString() : (v.verifiedAt||'');
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${v.licenseNumber||''}</td><td>${v.requestingOrg||''}</td><td>${v.country||''}</td><td>${v.result||''}</td><td>${dt}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('totalVerifications').textContent=total;
      document.getElementById('successfulVerifications').textContent=ok;
      document.getElementById('failedVerifications').textContent=fail;
    });

    document.getElementById('analyticsSearch').addEventListener('keyup',(e)=>{
      const term=e.target.value.toLowerCase();
      document.querySelectorAll('#verificationLogs tr').forEach(r=>{
        r.style.display=r.textContent.toLowerCase().includes(term)?'':'none';
      });
    });
    document.getElementById('exportLogs').onclick=()=>{
      const rows=[...document.querySelectorAll('table tr')];
      const csv=rows.map(r=>[...r.querySelectorAll('th,td')].map(c=>`"${c.innerText.replace(/"/g,'""')}"`).join(',')).join('\n');
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='analytics.csv'; a.click();
    };
  </script>
</body>
</html>
