<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS Analytics</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- jQuery & i18next -->
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f7fa;
    }

    header {
      background: #2c3e50;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    nav {
      background: #fff;
      border-bottom: 1px solid #ddd;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 10px 16px;
      position: fixed;
      top: 48px;
      width: 100%;
      z-index: 999;
    }

    nav a {
      color: #2c3e50;
      font-weight: bold;
      text-decoration: none;
    }

    nav a.active {
      border-bottom: 2px solid #2c3e50;
      padding-bottom: 3px;
    }

    main {
      margin-top: 120px;
      padding: 0 16px;
    }

    .dashboard-cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .card {
      flex: 1 1 180px;
      max-width: 200px;
      border-radius: 10px;
      color: white;
      text-align: center;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .total { background: #2980b9; }
    .active { background: #27ae60; }
    .pending { background: #f1c40f; color: #333; }
    .danger { background: #e74c3c; }

    section.panel {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .charts-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: space-between;
    }

    .charts-wrapper canvas {
      flex: 1 1 400px;
      max-width: 480px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th {
      background: #f2f2f2;
      cursor: pointer;
      user-select: none;
    }

    th span.arrow {
      font-size: 12px;
      margin-left: 5px;
      visibility: hidden;
    }

    th.sorted span.arrow {
      visibility: visible;
    }

    #logoutBtn {
      background: #34495e;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    #languageSwitcher {
      border-radius: 6px;
      padding: 6px;
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <header>
    <h1><i class="fa-solid fa-chart-line"></i> GDLVS Analytics</h1>
    <div>
      <select id="languageSwitcher">
        <option value="en">ðŸ‡¬ðŸ‡§ English</option>
        <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
        <option value="ja">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
      </select>
      <button id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="verify.html"><i class="fa-solid fa-search"></i> Verification</a>
    <a href="add_licenses.html"><i class="fa-solid fa-id-card"></i> Add License</a>
    <a href="users.html"><i class="fa-solid fa-users"></i> Users</a>
    <a href="verification_requests.html"><i class="fa-solid fa-inbox"></i> Access Requests</a>
    <a href="analytics.html" class="active"><i class="fa-solid fa-chart-bar"></i> Analytics</a>
  </nav>

  <main>
    <h2><i class="fa-solid fa-database"></i> System Overview</h2>
    <div class="dashboard-cards">
      <div class="card total"><i class="fa-solid fa-id-card"></i><h3>Licenses: <span id="totalLicenses">0</span></h3></div>
      <div class="card active"><i class="fa-solid fa-magnifying-glass"></i><h3>Verifications: <span id="totalVerifications">0</span></h3></div>
      <div class="card pending"><i class="fa-solid fa-user-clock"></i><h3>Pending Users: <span id="pendingUsers">0</span></h3></div>
      <div class="card danger"><i class="fa-solid fa-envelope"></i><h3>Pending Requests: <span id="pendingRequests">0</span></h3></div>
      <div class="card total"><i class="fa-solid fa-globe"></i><h3>Countries: <span id="countriesCount">0</span></h3></div>
    </div>

    <section class="panel">
      <h3><i class="fa-solid fa-chart-area"></i> Verification Analytics</h3>
      <div class="charts-wrapper">
        <canvas id="resultChart"></canvas>
        <canvas id="countryChart"></canvas>
      </div>
    </section>

    <section class="panel">
      <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Verifications</h3>
      <table>
        <thead>
          <tr>
            <th>License # <span class="arrow">â–²â–¼</span></th>
            <th>Organization <span class="arrow">â–²â–¼</span></th>
            <th>Country <span class="arrow">â–²â–¼</span></th>
            <th>Result <span class="arrow">â–²â–¼</span></th>
            <th>Date <span class="arrow">â–²â–¼</span></th>
          </tr>
        </thead>
        <tbody id="verificationLogs">
          <tr><td colspan="5">Loading...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => { if (!user) location.href = 'index.html'; });
    document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => location.href = 'index.html');

    const totalLicensesEl = document.getElementById("totalLicenses");
    const totalVerificationsEl = document.getElementById("totalVerifications");
    const pendingUsersEl = document.getElementById("pendingUsers");
    const pendingRequestsEl = document.getElementById("pendingRequests");
    const countriesCountEl = document.getElementById("countriesCount");
    const logsBody = document.getElementById("verificationLogs");

    let verificationsData = [];
    let resultChart, countryChart;

    async function loadAnalytics() {
      const licensesSnap = await getDocs(collection(db, "licenses"));
      totalLicensesEl.textContent = licensesSnap.size;

      const usersSnap = await getDocs(collection(db, "users"));
      let pendingU = 0;
      usersSnap.forEach((doc) => {
        if ((doc.data().status || "").toLowerCase() === "pending") pendingU++;
      });
      pendingUsersEl.textContent = pendingU;

      const reqSnap = await getDocs(collection(db, "requests"));
      let pendingR = 0;
      reqSnap.forEach((doc) => {
        const s = (doc.data().status || "").toLowerCase();
        if (!s || s === "pending") pendingR++;
      });
      pendingRequestsEl.textContent = pendingR;

      const verSnap = await getDocs(query(collection(db, "verifications"), orderBy("verifiedAt", "desc")));
      let ok = 0, fail = 0; const countries = {};

      verificationsData = [];
      verSnap.forEach((doc) => {
        const v = doc.data();
        const res = (v.result || "").toLowerCase();
        if (res.includes("not") || res.includes("fail")) fail++; else ok++;

        const country = v.country || "Unknown";
        countries[country] = (countries[country] || 0) + 1;

        verificationsData.push({
          licenseNumber: v.licenseNumber || "â€”",
          organization: v.requestingOrg || v.organization || v.verifierOrg || "â€”",
          country,
          result: v.result || "â€”",
          verifiedAt: v.verifiedAt ? new Date(v.verifiedAt.seconds * 1000) : null,
        });
      });

      totalVerificationsEl.textContent = verificationsData.length;
      countriesCountEl.textContent = Object.keys(countries).length;

      renderTable(verificationsData);
      drawCharts(ok, fail, countries);
    }

    function renderTable(data) {
      logsBody.innerHTML = "";
      if (data.length === 0) {
        logsBody.innerHTML = `<tr><td colspan="5">No verifications found</td></tr>`;
        return;
      }
      data.forEach((v) => {
        logsBody.innerHTML += `
          <tr>
            <td>${v.licenseNumber}</td>
            <td>${v.organization}</td>
            <td>${v.country}</td>
            <td>${v.result}</td>
            <td>${v.verifiedAt ? v.verifiedAt.toLocaleString() : "â€”"}</td>
          </tr>`;
      });
    }

    function drawCharts(ok, fail, countries) {
      if (resultChart) resultChart.destroy();
      resultChart = new Chart(document.getElementById("resultChart"), {
        type: "pie",
        data: { labels: ["Successful", "Failed"], datasets: [{ data: [ok, fail], backgroundColor: ["#27ae60", "#e74c3c"] }] },
        options: { plugins: { legend: { position: "bottom" } } }
      });

      if (countryChart) countryChart.destroy();
      const top5 = Object.entries(countries).sort((a, b) => b[1] - a[1]).slice(0, 5);
      countryChart = new Chart(document.getElementById("countryChart"), {
        type: "bar",
        data: { labels: top5.map(e => e[0]), datasets: [{ label: "Verifications", data: top5.map(e => e[1]), backgroundColor: "#2980b9" }] },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    // ===== Sortable Table =====
    const headers = document.querySelectorAll("table thead th");
    let sortDirection = 1;
    headers.forEach((th, index) => {
      th.addEventListener("click", () => {
        headers.forEach(h => h.classList.remove("sorted"));
        th.classList.add("sorted");
        const keyMap = ["licenseNumber", "organization", "country", "result", "verifiedAt"];
        const key = keyMap[index];
        verificationsData.sort((a, b) => {
          let valA = a[key], valB = b[key];
          if (key === "verifiedAt") {
            valA = valA ? valA.getTime() : 0;
            valB = valB ? valB.getTime() : 0;
          } else {
            valA = valA.toString().toLowerCase();
            valB = valB.toString().toLowerCase();
          }
          if (valA < valB) return -1 * sortDirection;
          if (valA > valB) return 1 * sortDirection;
          return 0;
        });
        th.querySelector("span.arrow").textContent = sortDirection === 1 ? "â–²" : "â–¼";
        sortDirection *= -1;
        renderTable(verificationsData);
      });
    });

    loadAnalytics();
    setInterval(loadAnalytics, 60000);
  </script>
</body>
</html>
