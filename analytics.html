<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Analytics Dashboard</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- jQuery + i18n -->
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script>window.$ = window.jQuery = window.$ || window.jQuery;</script>
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <style>
    :root {
      --brand-dark:#2a3f54;
      --brand-dark-2:#1e2d3c;
      --success:#27ae60;
      --danger:#e74c3c;
      --info:#2980b9;
      --warn:#f1c40f;
      --shadow:0 2px 6px rgba(0,0,0,.1);
    }

    body {
      margin:0;
      font-family:Arial, sans-serif;
      background:#f6f8fb;
      color:#333;
    }

    /* ===== Header / Navbar ===== */
    header {
      background:var(--brand-dark);
      color:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 14px;
      position:fixed;
      top:0; left:0; right:0;
      z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }
    header h1 {margin:0;font-size:18px;display:flex;align-items:center;gap:8px;}
    .header-controls{display:flex;gap:8px;}
    .mini-btn{background:var(--brand-dark-2);color:#fff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer;}
    .mini-select{border-radius:8px;padding:6px 8px;font-size:12px;background:#fff;}

    nav {
      background:#fff;
      border-bottom:1px solid #eaeaea;
      padding:10px 14px;
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      position:fixed;
      top:48px; left:0; right:0;
      z-index:900;
    }
    nav a {
      color:var(--brand-dark);
      text-decoration:none;
      font-weight:700;
    }
    nav a.active {
      border-bottom:2px solid var(--brand-dark);
      padding-bottom:4px;
    }

    main {
      margin-top:120px;
      max-width:1200px;
      padding:0 14px;
      margin-left:auto;
      margin-right:auto;
    }

    /* ===== Dashboard Cards ===== */
    .dashboard-cards {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:center;
      margin:10px 0 20px;
    }
    .card {
      flex:1 1 200px;
      max-width:220px;
      min-width:160px;
      border-radius:12px;
      color:#fff;
      text-align:center;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card i {display:block;margin-bottom:6px;}
    .card.total{background:var(--info);}
    .card.active{background:var(--success);}
    .card.pending{background:var(--warn);color:#333;}
    .card.danger{background:var(--danger);}

    /* ===== Panels ===== */
    section.panel {
      background:#fff;
      border-radius:10px;
      box-shadow:var(--shadow);
      padding:20px;
      margin-top:20px;
    }

    h2,h3{color:var(--brand-dark);}
    canvas{max-width:100%;display:block;}
    .charts-wrapper{display:flex;flex-wrap:wrap;gap:20px;justify-content:space-around;}
    .charts-wrapper canvas{flex:1 1 500px;max-width:550px;}

    /* ===== Table ===== */
    table {width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:10px;}
    th,td {background:#fff;border:1px solid #eee;padding:10px 12px;text-align:left;}
    th {background:#f2f2f2;cursor:pointer;user-select:none;}
    th span.arrow {margin-left:5px;color:#666;font-size:12px;visibility:hidden;}
    th.sorted span.arrow {visibility:visible;}
  </style>
</head>

<body>
  <header>
    <h1><i class="fa-solid fa-chart-line"></i> <span data-i18n="analyticsTitle">GDLVS Analytics</span></h1>
    <div class="header-controls">
      <select id="languageSwitcher" class="mini-select" aria-label="Language">
        <option value="en">🇬🇧 English</option>
        <option value="fr">🇫🇷 Français</option>
        <option value="ja">🇯🇵 日本語</option>
      </select>
      <button id="logoutBtn" class="mini-btn"><i class="fa-solid fa-right-from-bracket"></i> <span data-i18n="signOut">Sign Out</span></button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> <span data-i18n="dashboard">Dashboard</span></a>
    <a href="verify.html"><i class="fa-solid fa-search"></i> <span data-i18n="verification">Verification</span></a>
    <a href="add_licenses.html"><i class="fa-solid fa-id-card"></i> <span data-i18n="addLicense">Add License</span></a>
    <a href="users.html"><i class="fa-solid fa-users"></i> <span data-i18n="users">Users</span></a>
    <a href="verification_requests.html"><i class="fa-solid fa-inbox"></i> <span data-i18n="requests">Access Requests</span></a>
    <a class="active" href="analytics.html"><i class="fa-solid fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></a>
  </nav>

  <main>
    <h2><i class="fa-solid fa-database"></i> <span data-i18n="systemOverview">System Overview</span></h2>
    <div class="dashboard-cards">
      <div class="card total"><i class="fa-solid fa-id-card"></i><h3><span data-i18n="licenses">Licenses</span>: <span id="totalLicenses">0</span></h3></div>
      <div class="card active"><i class="fa-solid fa-magnifying-glass"></i><h3><span data-i18n="verifications">Verifications</span>: <span id="totalVerifications">0</span></h3></div>
      <div class="card pending"><i class="fa-solid fa-user-clock"></i><h3><span data-i18n="pendingUsers">Pending Users</span>: <span id="pendingUsers">0</span></h3></div>
      <div class="card danger"><i class="fa-solid fa-envelope"></i><h3><span data-i18n="pendingRequests">Pending Requests</span>: <span id="pendingRequests">0</span></h3></div>
      <div class="card total"><i class="fa-solid fa-globe"></i><h3><span data-i18n="countries">Countries</span>: <span id="countriesCount">0</span></h3></div>
    </div>

    <section class="panel">
      <h3><i class="fa-solid fa-chart-area"></i> <span data-i18n="analyticsCharts">Analytics Charts</span></h3>
      <div class="charts-wrapper">
        <canvas id="resultChart"></canvas>
        <canvas id="countryChart"></canvas>
      </div>
    </section>

    <section class="panel">
      <h3><i class="fa-solid fa-clock-rotate-left"></i> <span data-i18n="recentVerifications">Recent Verifications</span></h3>
      <table>
        <thead>
          <tr>
            <th>License #<span class="arrow">▲▼</span></th>
            <th>Organization<span class="arrow">▲▼</span></th>
            <th>Country<span class="arrow">▲▼</span></th>
            <th>Result<span class="arrow">▲▼</span></th>
            <th>Date<span class="arrow">▲▼</span></th>
          </tr>
        </thead>
        <tbody id="verificationLogs"><tr><td colspan="5" data-i18n="loading">Loading...</td></tr></tbody>
      </table>
    </section>
  </main>

  <!-- ===== SCRIPT ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:"AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain:"gdlvs-2348e.firebaseapp.com",
      projectId:"gdlvs-2348e",
      storageBucket:"gdlvs-2348e.appspot.com",
      messagingSenderId:"358715790318",
      appId:"1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (u)=>{ if(!u) location.href='index.html'; });
    document.getElementById("logoutBtn").onclick=()=>signOut(auth).then(()=>location.href='index.html');

    const totalLicensesEl=document.getElementById("totalLicenses");
    const totalVerificationsEl=document.getElementById("totalVerifications");
    const pendingUsersEl=document.getElementById("pendingUsers");
    const pendingRequestsEl=document.getElementById("pendingRequests");
    const countriesCountEl=document.getElementById("countriesCount");
    const logsBody=document.getElementById("verificationLogs");
    let resultChart,countryChart;
    let verificationsData=[];

    async function loadAnalytics(){
      const licensesSnap=await getDocs(collection(db,"licenses"));
      totalLicensesEl.textContent=licensesSnap.size;

      const usersSnap=await getDocs(collection(db,"users"));
      let pendingU=0; usersSnap.forEach(d=>{if((d.data().status||"").toLowerCase()==="pending") pendingU++;});
      pendingUsersEl.textContent=pendingU;

      const reqSnap=await getDocs(collection(db,"requests"));
      let pendingR=0; reqSnap.forEach(d=>{const s=(d.data().status||"").toLowerCase();if(!s||s==="pending") pendingR++;});
      pendingRequestsEl.textContent=pendingR;

      const verSnap=await getDocs(query(collection(db,"verifications"), orderBy("verifiedAt","desc")));
      let total=0,ok=0,fail=0; const countries={}; verificationsData=[];
      verSnap.forEach(doc=>{
        const v=doc.data(); total++;
        const res=(v.result||"").toLowerCase();
        if(res.includes("not")||res.includes("fail")) fail++; else ok++;
        const country=(v.country||"Unknown").trim();
        const org=v.requestingOrg||v.organization||v.verifierOrg||"—";
        const date=v.verifiedAt?new Date(v.verifiedAt.seconds*1000):null;
        countries[country]=(countries[country]||0)+1;
        verificationsData.push({licenseNumber:v.licenseNumber||"",organization:org,country,result:v.result||"",verifiedAt:date});
      });
      totalVerificationsEl.textContent=total;
      countriesCountEl.textContent=Object.keys(countries).length;
      renderTable(verificationsData);
      drawCharts(ok,fail,countries);
    }

    function renderTable(data){
      logsBody.innerHTML="";
      if(!data.length){logsBody.innerHTML=`<tr><td colspan="5">No verifications found</td></tr>`;return;}
      data.forEach(v=>{
        logsBody.innerHTML+=`
          <tr>
            <td>${v.licenseNumber}</td>
            <td>${v.organization}</td>
            <td>${v.country}</td>
            <td>${v.result}</td>
            <td>${v.verifiedAt?v.verifiedAt.toLocaleString():""}</td>
          </tr>`;
      });
    }

    function drawCharts(ok,fail,countries){
      const ctx=document.getElementById("resultChart");
      if(resultChart) resultChart.destroy();
      resultChart=new Chart(ctx,{
        type:"pie",
        data:{labels:["Successful","Failed"],datasets:[{data:[ok,fail],backgroundColor:["#27ae60","#e74c3c"]}]},
        options:{plugins:{legend:{position:"bottom"}}}
      });

      const ctx2=document.getElementById("countryChart");
      if(countryChart) countryChart.destroy();
      const top5=Object.entries(countries).sort((a,b)=>b[1]-a[1]).slice(0,5);
      countryChart=new Chart(ctx2,{
        type:"bar",
        data:{labels:top5.map(e=>e[0]),datasets:[{label:"Verifications",data:top5.map(e=>e[1]),backgroundColor:"#2980b9"}]},
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
    }

    // ===== Sortable Table with Arrows =====
    const headers=document.querySelectorAll("table thead th");
    let sortDirection=1; let lastIndex=-1;
    headers.forEach((th,index)=>{
      th.addEventListener("click",()=>{
        headers.forEach(h=>h.classList.remove("sorted"));
        th.classList.add("sorted");
        const keyMap=["licenseNumber","organization","country","result","verifiedAt"];
        const key=keyMap[index];
        verificationsData.sort((a,b)=>{
          let valA=a[key], valB=b[key];
          if(key==="verifiedAt"){valA=valA?valA.getTime():0;valB=valB?valB.getTime():0;}
          else{valA=valA.toString().toLowerCase();valB=valB.toString().toLowerCase();}
          if(valA<valB)return-1*sortDirection;
          if(valA>valB)return 1*sortDirection;
          return 0;
        });
        const arrows=th.querySelector("span.arrow");
        arrows.textContent=sortDirection===1?"▲":"▼";
        sortDirection*=-1;
        renderTable(verificationsData);
      });
    });

    await loadAnalytics();
    setInterval(loadAnalytics,60000);

    // ===== i18n =====
    const i18nResources={
      en:{translation:{
        analyticsTitle:"GDLVS Analytics",signOut:"Sign Out",dashboard:"Dashboard",
        verification:"Verification",addLicense:"Add License",users:"Users",
        requests:"Access Requests",analytics:"Analytics",systemOverview:"System Overview",
        licenses:"Licenses",verifications:"Verifications",pendingUsers:"Pending Users",
        pendingRequests:"Pending Requests",countries:"Countries",recentVerifications:"Recent Verifications",loading:"Loading..."
      }},
      fr:{translation:{
        analyticsTitle:"Analyse GDLVS",signOut:"Déconnexion",dashboard:"Tableau de bord",
        verification:"Vérification",addLicense:"Ajouter un permis",users:"Utilisateurs",
        requests:"Demandes d’accès",analytics:"Analytique",systemOverview:"Aperçu du système",
        licenses:"Permis",verifications:"Vérifications",pendingUsers:"Utilisateurs en attente",
        pendingRequests:"Demandes en attente",countries:"Pays",recentVerifications:"Vérifications récentes",loading:"Chargement..."
      }},
      ja:{translation:{
        analyticsTitle:"GDLVS 分析",signOut:"ログアウト",dashboard:"ダッシュボード",
        verification:"照会",addLicense:"免許を追加",users:"ユーザー",
        requests:"アクセスリクエスト",analytics:"分析",systemOverview:"システム概要",
        licenses:"免許",verifications:"照会件数",pendingUsers:"保留中のユーザー",
        pendingRequests:"保留中のリクエスト",countries:"国",recentVerifications:"最近の照会",loading:"読み込み中..."
      }}
    };

    i18next.use(i18nextBrowserLanguageDetector).init({resources:i18nResources,fallbackLng:"en"},
      ()=>{jqueryI18next.init(i18next,$,{useOptionsAttr:true});$("body").localize();}
    );
    document.getElementById("languageSwitcher").addEventListener("change",function(){
      i18next.changeLanguage(this.value,()=>$("body").localize());
    });
  </script>
</body>
</html>
