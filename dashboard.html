<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      color: #333;
    }
    .background-image {
      position: fixed;
      inset: 0;
      background: url('https://raw.githubusercontent.com/micaelngoma/GDLVS/main/Gabon%20Forest.jpg') no-repeat center center fixed;
      background-size: cover;
      filter: brightness(0.9);
      z-index: -1;
    }
    header {
      background: #2a3f54;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
    }
    header h1 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .controls select, .controls button {
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .controls select { background: #fff; color: #000; }
    .controls button { background: #1e2d3c; color: #fff; cursor: pointer; }
    .controls button:hover { background: #16222d; }
    nav {
      background: rgba(255,255,255,0.9);
      padding: 10px 14px;
      display: flex;
      gap: 16px;
      border-bottom: 1px solid #eaeaea;
      backdrop-filter: blur(6px);
    }
    nav a {
      text-decoration: none;
      color: #2a3f54;
      font-weight: bold;
    }
    nav a.active {
      border-bottom: 2px solid #2a3f54;
      padding-bottom: 3px;
    }

    .container {
      max-width: 1100px;
      margin: 25px auto;
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      padding: 25px;
      backdrop-filter: blur(6px);
    }

    .dashboard-cards {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .card {
      flex: 1;
      min-width: 220px;
      text-align: center;
      border-radius: 10px;
      color: white;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .card.total { background: #2980b9; }
    .card.active { background: #27ae60; }
    .card.suspended { background: #f1c40f; color: #333; }
    .card.expired { background: #e74c3c; }
    .card h2 { margin: 5px 0; font-size: 1.6rem; }

    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    #licenseSearch {
      max-width: 320px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
    }
    .btn-export {
      background: #2980b9;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .btn-export:hover { background: #1f6392; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 10px 14px;
      background: rgba(255,255,255,0.95);
    }
    th { background: rgba(240,240,240,0.95); font-weight: bold; }
    td button {
      background: #2980b9;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 8px;
      cursor: pointer;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
      width: min(520px, 90vw);
      padding: 18px;
    }
    .modal header {
      background: #2a3f54;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px 8px 0 0;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }
    .btn-primary { background: #27ae60; color: white; border: none; padding: 8px 12px; border-radius: 8px; }
    .btn-secondary { background: #95a5a6; color: white; border: none; padding: 8px 12px; border-radius: 8px; }

    @media (max-width: 768px) {
      .dashboard-cards { flex-direction: column; }
    }
  </style>
</head>

<body>
  <div class="background-image"></div>

  <header>
    <h1><i class="fas fa-id-card"></i> Dashboard</h1>
    <div class="controls">
      <select id="languageSwitcher">
        <option value="en">ðŸ‡¬ðŸ‡§ English</option>
        <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
        <option value="ja">ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž</option>
      </select>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html" class="active">Dashboard</a>
    <a href="verify.html">Verification</a>
    <a href="add_licenses.html">Add License</a>
    <a href="users.html">User Management</a>
    <a id="navVerificationRequests" href="verification_requests.html">Verification Requests</a>
    <a href="analytics.html">Analytics</a>
  </nav>

  <main class="container">
    <section class="dashboard-cards">
      <div class="card total"><h3>Total Licenses</h3><h2 id="totalLicenses">0</h2></div>
      <div class="card active"><h3>Active</h3><h2 id="activeLicenses">0</h2></div>
      <div class="card suspended"><h3>Suspended</h3><h2 id="suspendedLicenses">0</h2></div>
      <div class="card expired"><h3>Expired</h3><h2 id="expiredLicenses">0</h2></div>
    </section>

    <section>
      <h2><i class="fas fa-id-badge"></i> Licenses</h2>
      <div class="table-controls">
        <input id="licenseSearch" type="text" placeholder="Search licenses..." />
        <button class="btn-export" id="exportLicenses"><i class="fas fa-file-export"></i> Export</button>
      </div>
      <table id="licensesTable">
        <thead>
          <tr>
            <th>License #</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Issue</th>
            <th>Expiry</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="7">Loading...</td></tr></tbody>
      </table>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-overlay" id="editModalOverlay">
    <div class="modal">
      <header>
        <h3><i class="fas fa-pen-to-square"></i> Edit License</h3>
        <button class="btn-secondary" id="modalCloseBtn"><i class="fas fa-times"></i></button>
      </header>
      <div>
        <input type="hidden" id="modalLicenseId"/>
        <label>Full Name</label><input type="text" id="modalFullName"/>
        <label>Class</label><select id="modalClass">
          <option value="Class A">A</option><option value="Class B">B</option>
          <option value="Class C">C</option><option value="Class D">D</option>
          <option value="Class E">E</option>
        </select>
        <label>Status</label><select id="modalStatus">
          <option value="Active">Active</option><option value="Suspended">Suspended</option>
          <option value="Expired">Expired</option>
        </select>
        <label>Issue</label><input type="date" id="modalIssue"/>
        <label>Expiry</label><input type="date" id="modalExpiry"/>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" id="modalCancelBtn">Cancel</button>
        <button class="btn-primary" id="modalSaveBtn"><i class="fas fa-save"></i> Save</button>
      </div>
    </div>
  </div>

  <!-- Firebase Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", () => signOut(auth).then(() => window.location.href = "index.html"));

    onAuthStateChanged(auth, async (user) => {
      if (!user) return (window.location.href = "index.html");
      const roleSnap = await getDoc(doc(db, "roles", user.email));
      const role = roleSnap.exists() ? roleSnap.data().role : "verifier";
      document.getElementById("navVerificationRequests").style.display = role === "admin" ? "block" : "none";
    });

    const tbody = document.querySelector("#licensesTable tbody");
    const totalLic = document.getElementById("totalLicenses");
    const activeLic = document.getElementById("activeLicenses");
    const suspendedLic = document.getElementById("suspendedLicenses");
    const expiredLic = document.getElementById("expiredLicenses");

    const q = query(collection(db, "licenses"), orderBy("licenseNumber"));
    onSnapshot(q, (snap) => {
      tbody.innerHTML = "";
      let total = 0, active = 0, susp = 0, exp = 0;
      snap.forEach((docSnap) => {
        const d = docSnap.data(); total++;
        const s = (d.status || "").toLowerCase();
        if (s.startsWith("act")) active++;
        else if (s.startsWith("sus")) susp++;
        else if (s.startsWith("exp")) exp++;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${d.licenseNumber || docSnap.id}</td>
          <td>${d.fullName || ""}</td>
          <td>${d.class || ""}</td>
          <td>${d.issueDate || ""}</td>
          <td>${d.expiryDate || ""}</td>
          <td>${d.status || ""}</td>
          <td><button class="btn-inline" data-id="${d.licenseNumber || docSnap.id}"><i class="fas fa-pen"></i> Edit</button></td>`;
        tbody.appendChild(row);
      });
      totalLic.textContent = total;
      activeLic.textContent = active;
      suspendedLic.textContent = susp;
      expiredLic.textContent = exp;
    });
  </script>
</body>
</html>
