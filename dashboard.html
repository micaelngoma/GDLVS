<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- i18n + jQuery (UMD) -->
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <style>
    /* ===== Background (shared) ===== */
    .background-image{
      position:fixed;inset:0;
      background:url('https://raw.githubusercontent.com/micaelngoma/GDLVS/main/Gabon%20Forest.jpg') no-repeat center center fixed;
      background-size:cover;z-index:-1;filter:brightness(0.9)
    }

    /* ===== Theme ===== */
    :root{
      --brand-dark:#2a3f54; --brand-dark-2:#1e2d3c;
      --text:#333; --muted:#666;
      --panel-bg:rgba(255,255,255,0.9);
      --card-shadow:0 2px 8px rgba(0,0,0,0.25);
      --success:#27ae60; --danger:#e74c3c; --warn:#f1c40f; --info:#2980b9;
      --overlay:rgba(0,0,0,0.45);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial, sans-serif;color:var(--text);background:#f6f8fb;min-height:100vh}

    /* ===== Header / Nav ===== */
    header{background:var(--brand-dark);color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--card-shadow)}
    header h1{margin:0;font-size:1.1rem;display:flex;gap:8px;align-items:center}
    .controls{display:flex;gap:8px;align-items:center}
    .controls select,.controls button{padding:6px 10px;border-radius:8px;border:0;font-size:.9rem}
    .controls select{background:#fff;color:#000}
    .controls button{background:var(--brand-dark-2);color:#fff;cursor:pointer}
    .controls button:hover{background:#16222d}

    nav{background:rgba(255,255,255,0.9);border-bottom:1px solid #eaeaea;padding:10px 14px;display:flex;gap:16px;flex-wrap:wrap;backdrop-filter:blur(6px)}
    nav a{color:var(--brand-dark);text-decoration:none;font-weight:bold}
    nav a:hover{color:var(--brand-dark-2)}
    nav a.active{border-bottom:2px solid var(--brand-dark);padding-bottom:3px}

    /* ===== Containers / Panels ===== */
    .container{max-width:1100px;margin:25px auto;background:var(--panel-bg);border-radius:12px;box-shadow:var(--card-shadow);padding:25px;backdrop-filter:blur(6px)}
    .panel{background:var(--panel-bg);border-radius:10px;box-shadow:var(--card-shadow);padding:18px;margin:18px 0}

    /* ===== Stat Cards (equal width) ===== */
    .dashboard-cards{display:flex;gap:15px;flex-wrap:wrap;margin:12px 0 18px}
    .dashboard-cards .card{flex:1;min-width:220px;padding:16px;border-radius:10px;color:#fff;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.2);transition:transform .2s}
    .dashboard-cards .card:hover{transform:translateY(-4px)}
    .card.total{background:#2980b9}
    .card.active{background:#27ae60}
    .card.suspended{background:#f1c40f;color:#333}
    .card.expired{background:#e74c3c}
    .card h3{margin:6px 0}
    .card h2{margin:0;font-size:1.6rem;font-weight:700}

    /* ===== Table & Controls ===== */
    .table-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .btn-export{width:auto;background:#2980b9;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:.9rem}
    .btn-export:hover{background:#1f6392}
    #licenseSearch{max-width:320px;border:1px solid #dcdcdc;border-radius:8px;padding:8px;background:#fff}
    .verification-table-wrapper{overflow-x:auto}

    table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:10px}
    th,td{border:1px solid #eee;padding:10px 14px;text-align:left;background:#fff;vertical-align:middle}
    th{background:#f2f2f2;font-weight:bold}

    /* üîß Stretch table a bit more and keep one-line cells */
    #licensesTable{min-width:1200px; table-layout:auto}
    #licensesTable th,#licensesTable td{white-space:nowrap}

    /* Buttons inside table */
    .btn-inline{padding:6px 10px;border-radius:8px;border:0;cursor:pointer;color:#fff;background:var(--info)}
    .btn-inline:hover{opacity:.95}

    /* ===== Modal ===== */
    .modal-overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-overlay.show{display:flex}
    .modal{width:min(520px,90vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
    .modal header{background:var(--brand-dark);color:#fff;padding:10px 14px;display:flex;align-items:center;justify-content:space-between}
    .modal .modal-body{padding:16px}

    /* üîß Force vertical, tidy field stack in the modal */
    .modal .modal-body{display:flex;flex-direction:column;gap:10px}
    .modal .modal-body label{display:block;margin-top:2px;font-weight:600}
    .modal .modal-body input,.modal .modal-body select{width:100%}

    .modal .modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid #eee;background:#fafafa}
    .btn-primary{background:var(--success);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn-secondary{background:#95a5a6;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}

    @media(max-width:900px){header{flex-direction:column;gap:8px}}
  </style>
</head>
<body>
  <div class="background-image"></div>

  <!-- Header -->
  <header>
    <h1><i class="fas fa-id-card"></i> <span data-i18n="dashboard">Dashboard</span></h1>
    <div class="controls">
      <select id="languageSwitcher" aria-label="Language">
        <option value="en">üá¨üáß English</option>
        <option value="fr">üá´üá∑ Fran√ßais</option>
        <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
      </select>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span></button>
    </div>
  </header>

  <!-- Nav -->
  <nav>
    <a href="dashboard.html" class="active"><i class="fas fa-home"></i> <span data-i18n="dashboard">Dashboard</span></a>
    <a href="verify.html"><i class="fas fa-search"></i> <span data-i18n="verificationPortal">Verification</span></a>
    <a href="add_licenses.html"><i class="fas fa-id-card"></i> <span data-i18n="addLicense">Add License</span></a>
    <a href="users.html"><i class="fas fa-users-cog"></i> <span data-i18n="userManagement">User Management</span></a>
    <a id="navVerificationRequests" href="verification_requests.html"><i class="fas fa-inbox"></i> <span data-i18n="verificationRequests">Verification Requests</span></a>
    <a href="analytics.html"><i class="fas fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></a>
  </nav>

  <main class="container">
    <!-- Cards -->
    <section class="dashboard-cards">
      <div class="card total"><div>üë§</div><h3 data-i18n="totalLicenses">Total Licenses</h3><h2 id="totalLicenses">0</h2></div>
      <div class="card active"><div>‚úÖ</div><h3 data-i18n="activeLicenses">Active</h3><h2 id="activeLicenses">0</h2></div>
      <div class="card suspended"><div>‚ö†Ô∏è</div><h3 data-i18n="suspended">Suspended</h3><h2 id="suspendedLicenses">0</h2></div>
      <div class="card expired"><div>‚õî</div><h3 data-i18n="expired">Expired</h3><h2 id="expiredLicenses">0</h2></div>
    </section>

    <!-- Licenses Table -->
    <section class="panel">
      <h2><i class="fas fa-id-badge"></i> <span data-i18n="licensesList">Licenses</span></h2>
      <div class="table-controls">
        <input id="licenseSearch" type="text" data-i18n="[placeholder]searchLicenses" placeholder="Search licenses..." />
        <button class="btn-export" id="exportLicenses"><i class="fas fa-file-export"></i> <span data-i18n="export">Export</span></button>
      </div>
      <div class="verification-table-wrapper">
        <table id="licensesTable">
          <thead>
            <tr>
              <th data-i18n="licenseNumber">License #</th>
              <th data-i18n="fullName">Full Name</th>
              <th data-i18n="class">Class</th>
              <th data-i18n="issueDate">Issue</th>
              <th data-i18n="expiryDate">Expiry</th>
              <th data-i18n="status">Status</th>
              <th data-i18n="action">Action</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="7" data-i18n="loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer style="text-align:center;margin:22px 0 40px;">
    <small class="muted">GDLVS</small>
  </footer>

  <!-- ===== Edit Modal ===== -->
  <div class="modal-overlay" id="editModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
      <header>
        <h3 id="editModalTitle"><i class="fas fa-pen-to-square"></i> <span data-i18n="editLicense">Edit License</span></h3>
        <button class="btn-secondary" id="modalCloseBtn"><i class="fas fa-times"></i></button>
      </header>
      <div class="modal-body">
        <input type="hidden" id="modalLicenseId" />
        <label for="modalFullName" data-i18n="fullName">Full Name</label>
        <input type="text" id="modalFullName" />
        <label for="modalClass" data-i18n="class">Class</label>
        <select id="modalClass">
          <option value="Class A">A</option>
          <option value="Class B">B</option>
          <option value="Class C">C</option>
          <option value="Class D">D</option>
          <option value="Class E">E</option>
        </select>
        <label for="modalStatus" data-i18n="status">Status</label>
        <select id="modalStatus">
          <option value="Active" data-i18n="active">Active</option>
          <option value="Suspended" data-i18n="suspended">Suspended</option>
          <option value="Expired" data-i18n="expired">Expired</option>
        </select>
        <label for="modalIssue" data-i18n="issueDate">Issue</label>
        <input type="date" id="modalIssue" />
        <label for="modalExpiry" data-i18n="expiryDate">Expiry</label>
        <input type="date" id="modalExpiry" />
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" id="modalCancelBtn" data-i18n="cancel">Cancel</button>
        <button class="btn-primary" id="modalSaveBtn"><i class="fas fa-save"></i> <span data-i18n="saveChanges">Save Changes</span></button>
      </div>
    </div>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    /* ===== Firebase v9+ Modular ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ===== i18n ===== */
    const i18nResources = {
      en:{translation:{
        dashboard:"Dashboard", verificationPortal:"Verification", addLicense:"Add License",
        userManagement:"User Management", verificationRequests:"Verification Requests", analytics:"Analytics",
        logout:"Logout",
        totalLicenses:"Total Licenses", activeLicenses:"Active", suspended:"Suspended", expired:"Expired",
        licensesList:"Licenses", licenseNumber:"License #", fullName:"Full Name", class:"Class",
        issueDate:"Issue", expiryDate:"Expiry", status:"Status", action:"Action",
        loading:"Loading...", export:"Export", searchLicenses:"Search licenses...",
        editLicense:"Edit License", cancel:"Cancel", saveChanges:"Save Changes", active:"Active"
      }},
      fr:{translation:{
        dashboard:"Tableau de bord", verificationPortal:"V√©rification", addLicense:"Ajouter un permis",
        userManagement:"Gestion des utilisateurs", verificationRequests:"Demandes de v√©rification", analytics:"Analytique",
        logout:"D√©connexion",
        totalLicenses:"Nombre total de permis", activeLicenses:"Actifs", suspended:"Suspendus", expired:"Expir√©s",
        licensesList:"Permis", licenseNumber:"N¬∞ de permis", fullName:"Nom complet", class:"Cat√©gorie",
        issueDate:"√âmission", expiryDate:"Expiration", status:"Statut", action:"Action",
        loading:"Chargement...", export:"Exporter", searchLicenses:"Rechercher des permis‚Ä¶",
        editLicense:"Modifier le permis", cancel:"Annuler", saveChanges:"Enregistrer", active:"Actif"
      }},
      ja:{translation:{
        dashboard:"„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ", verificationPortal:"ÁÖßÂêà", addLicense:"ÂÖçË®±„ÇíËøΩÂä†",
        userManagement:"„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ", verificationRequests:"ÁÖßÂêà„É™„ÇØ„Ç®„Çπ„Éà", analytics:"ÂàÜÊûê",
        logout:"„É≠„Ç∞„Ç¢„Ç¶„Éà",
        totalLicenses:"Á∑èÂÖçË®±Êï∞", activeLicenses:"ÊúâÂäπ", suspended:"ÂÅúÊ≠¢‰∏≠", expired:"ÊúüÈôêÂàá„Çå",
        licensesList:"ÂÖçË®±‰∏ÄË¶ß", licenseNumber:"ÂÖçË®±Áï™Âè∑", fullName:"Ê∞èÂêç", class:"Âå∫ÂàÜ",
        issueDate:"Áô∫Ë°å", expiryDate:"ÊúâÂäπÊúüÈôê", status:"„Çπ„ÉÜ„Éº„Çø„Çπ", action:"Êìç‰Ωú",
        loading:"Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶", export:"„Ç®„ÇØ„Çπ„Éù„Éº„Éà", searchLicenses:"ÂÖçË®±„ÇíÊ§úÁ¥¢‚Ä¶",
        editLicense:"ÂÖçË®±„ÇíÁ∑®ÈõÜ", cancel:"„Ç≠„É£„É≥„Çª„É´", saveChanges:"‰øùÂ≠ò", active:"ÊúâÂäπ"
      }}
    };

    i18next.use(i18nextBrowserLanguageDetector).init(
      { resources:i18nResources, fallbackLng:"en" },
      () => { if (typeof jqueryI18next!=="undefined"){ jqueryI18next.init(i18next,$,{useOptionsAttr:true}); $("body").localize(); } }
    );
    document.getElementById("languageSwitcher").addEventListener("change", function(){
      i18next.changeLanguage(this.value, () => $("body").localize());
    });

    /* ===== Auth Gate ===== */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ window.location.href="index.html"; return; }
      const roleSnap = await getDoc(doc(db, "roles", user.email));
      const role = roleSnap.exists() ? roleSnap.data().role : "verifier";
      const adminOnly = document.getElementById("navVerificationRequests");
      if (adminOnly) adminOnly.style.display = (role==="admin") ? "block" : "none";
    });

    /* ===== Logout ===== */
    document.getElementById("logoutBtn").addEventListener("click", ()=>signOut(auth).then(()=>location.href="index.html"));

    /* ===== Modal helpers ===== */
    const overlay = document.getElementById("editModalOverlay");
    const closeBtn = document.getElementById("modalCloseBtn");
    const cancelBtn = document.getElementById("modalCancelBtn");
    const saveBtn = document.getElementById("modalSaveBtn");
    const fields = {
      id: document.getElementById("modalLicenseId"),
      fullName: document.getElementById("modalFullName"),
      klass: document.getElementById("modalClass"),
      status: document.getElementById("modalStatus"),
      issue: document.getElementById("modalIssue"),
      expiry: document.getElementById("modalExpiry")
    };
    function openModal(d){
      fields.id.value = d.licenseNumber || d.id || "";
      fields.fullName.value = d.fullName || "";
      fields.klass.value = d.class || "Class A";
      fields.status.value = d.status || "Active";
      fields.issue.value = (d.issueDate || "").slice(0,10);
      fields.expiry.value = (d.expiryDate || "").slice(0,10);
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
    }
    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);
    overlay.addEventListener("click", (e)=>{ if(e.target===overlay) closeModal(); });

    saveBtn.addEventListener("click", async ()=>{
      const id = fields.id.value.trim();
      if(!id){ alert("Missing license number"); return; }
      const payload = {
        licenseNumber: id,
        fullName: fields.fullName.value.trim(),
        class: fields.klass.value,
        status: fields.status.value,
        issueDate: fields.issue.value,
        expiryDate: fields.expiry.value
      };
      try{
        await setDoc(doc(db,"licenses", id), payload, { merge:true });
        closeModal();
      }catch(err){ alert("‚ùå " + err.message); }
    });

    /* ===== Licenses: realtime table + counters ===== */
    const tbody = document.querySelector("#licensesTable tbody");
    const qLic = query(collection(db, "licenses"), orderBy("licenseNumber"));

    onSnapshot(qLic, (snapshot)=>{
      let total=0, active=0, suspended=0, expired=0;
      tbody.innerHTML = "";
      if (snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="7">${i18next.t("loading")}</td></tr>`;
      } else {
        snapshot.forEach(docSnap=>{
          const d = docSnap.data();
          total++;
          const s = String(d.status||"").toLowerCase();
          if (s.startsWith("act")) active++; else if (s.startsWith("sus")) suspended++; else if (s.startsWith("exp")) expired++;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.licenseNumber||docSnap.id}</td>
            <td>${d.fullName||""}</td>
            <td>${d.class||""}</td>
            <td>${d.issueDate||""}</td>
            <td>${d.expiryDate||""}</td>
            <td>${d.status||""}</td>
            <td><button class="btn-inline" data-action="update" data-id="${d.licenseNumber||docSnap.id}"><i class="fas fa-pen"></i> ${i18next.t("editLicense")}</button></td>`;
          tbody.appendChild(tr);
        });
      }
      document.getElementById("totalLicenses").textContent = total;
      document.getElementById("activeLicenses").textContent = active;
      document.getElementById("suspendedLicenses").textContent = suspended;
      document.getElementById("expiredLicenses").textContent = expired;
    });

    /* ===== Row actions: open modal with current data ===== */
    tbody.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-action='update']");
      if(!btn) return;
      const id = btn.getAttribute("data-id");
      try {
        const snap = await getDoc(doc(db,"licenses",id));
        const data = snap.exists() ? snap.data() : { licenseNumber:id };
        openModal({ id, ...data });
      } catch(err){ alert("‚ùå " + err.message); }
    });

    /* ===== Search filter ===== */
    document.getElementById("licenseSearch").addEventListener("input", (e)=>{
      const term = e.target.value.toLowerCase();
      document.querySelectorAll("#licensesTable tbody tr").forEach(row=>{
        row.style.display = row.textContent.toLowerCase().includes(term) ? "" : "none";
      });
    });

    /* ===== Export CSV ===== */
    document.getElementById("exportLicenses").addEventListener("click", ()=>{
      const rows = document.querySelectorAll("#licensesTable tr");
      const csv = [];
      rows.forEach(r=>{
        const cols = r.querySelectorAll("th,td");
        const row = Array.from(cols).map(c => `"${c.innerText.replace(/"/g,'""')}"`).join(",");
        csv.push(row);
      });
      const blob = new Blob([csv.join("\n")], { type:"text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "licenses_export.csv";
      a.click();
    });
  </script>
</body>
</html>
