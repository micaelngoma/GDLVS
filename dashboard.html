<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- i18n + jQuery -->
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <style>
    body{font-family:Arial,sans-serif;color:#333;margin:0;background:#f6f8fb;overflow-x:hidden;}
    .background-image{position:fixed;inset:0;background:url('https://raw.githubusercontent.com/micaelngoma/GDLVS/main/Gabon%20Forest.jpg') center/cover no-repeat;z-index:-1;filter:brightness(0.9)}
    header{background:#2a3f54;color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;position:fixed;top:0;left:0;right:0;z-index:1000}
    header h1{margin:0;font-size:1.1rem;display:flex;gap:8px;align-items:center}
    .controls{display:flex;gap:8px;align-items:center}
    .controls select,.controls button{padding:6px 10px;border-radius:8px;border:0;font-size:.9rem}
    .controls select{background:#fff;color:#000}
    .controls button{background:#1e2d3c;color:#fff;cursor:pointer}
    nav{background:#1e2d3c;color:#fff;padding:10px 14px;display:flex;gap:16px;position:fixed;top:56px;left:0;right:0;z-index:999}
    nav a{color:#fff;text-decoration:none;font-weight:bold;transition:all 0.25s ease-in-out}
    nav a.active{border-bottom:2px solid #f1c40f;padding-bottom:3px}
    nav a:hover{border-bottom:2px solid #f1c40f;padding-bottom:3px;box-shadow:0 2px 6px rgba(241,196,15,0.7)}

    .container{
      max-width:95vw;
      margin:220px auto 0;
      background:rgba(255,255,255,0.9);
      padding:25px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.2);
      position:relative;
    }

    /* ===== Fixed Top Section ===== */
    .fixed-top-section{
      position:fixed;
      top:96px;
      left:50%;
      transform:translateX(-50%);
      width:95vw;
      z-index:998;
      background:rgba(255,255,255,0.95);
      padding:10px 20px 15px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }

    .dashboard-cards{display:flex;gap:15px;flex-wrap:wrap;margin-bottom:10px}
    .card{flex:1;min-width:220px;padding:16px;border-radius:10px;color:#fff;text-align:center}
    .card.total{background:#2980b9}.card.active{background:#27ae60}.card.suspended{background:#f1c40f;color:#333}.card.expired{background:#e74c3c}

    /* Search + Export */
    .search-export{display:flex;gap:10px;align-items:center;margin-top:10px;}
    .search-export input{padding:6px;border:1px solid #ccc;border-radius:6px;flex:1;}
    .search-export button{padding:6px 10px;border-radius:6px;border:0;color:#fff;background:#2980b9;cursor:pointer}

    /* ===== Scrollable Table ===== */
    .table-container{max-height:60vh;overflow-y:auto;margin-top:190px;}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{border:1px solid #eee;padding:8px;background:#fff;text-align:left;word-wrap:break-word}
    th{background:#f2f2f2;position:sticky;top:0;z-index:5}
    th:nth-child(1){width:10%}
    th:nth-child(2){width:20%}
    th:nth-child(3){width:10%}
    th:nth-child(4){width:15%}
    th:nth-child(5){width:15%}
    th:nth-child(6){width:10%}
    th:nth-child(7){width:10%}
    td:nth-child(7){white-space:nowrap}
    .btn-inline{padding:5px 8px;border-radius:6px;border:0;cursor:pointer;color:#fff;background:#2980b9}
    .btn-danger{background:#e74c3c}

    /* ===== Modal ===== */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:2000;animation:fadeIn .25s ease-in-out}
    .modal-overlay.show{display:flex}
    .modal{background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.3);width:min(520px,90vw);max-height:80vh;overflow-y:auto;display:flex;flex-direction:column;animation:popIn .25s ease-in-out}
    .modal header{background:#2a3f54;color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center;border-radius:10px 10px 0 0}
    .modal-body{padding:16px;display:flex;flex-direction:column;gap:10px}
    .modal-actions{padding:10px;display:flex;justify-content:flex-end;gap:10px;background:#fafafa;border-top:1px solid #eee;border-radius:0 0 10px 10px}
    .btn-primary{background:#27ae60;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn-secondary{background:#95a5a6;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes popIn{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}
  </style>
</head>
<body>
  <div class="background-image"></div>

  <header>
    <h1><i class="fas fa-id-card"></i> <span data-i18n="dashboard">Dashboard</span></h1>
    <div class="controls">
      <select id="languageSwitcher">
        <option value="en">🇬🇧 English</option>
        <option value="fr">🇫🇷 Français</option>
        <option value="ja">🇯🇵 日本語</option>
      </select>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span></button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html" class="active"><i class="fas fa-home"></i> <span data-i18n="dashboard">Dashboard</span></a>
    <a href="verify.html"><i class="fas fa-search"></i> <span data-i18n="verificationPortal">Verification</span></a>
    <a href="add_licenses.html"><i class="fas fa-id-card"></i> <span data-i18n="addLicense">Add License</span></a>
    <a href="users.html"><i class="fas fa-users-cog"></i> <span data-i18n="userManagement">User Management</span></a>
    <a id="navVerificationRequests" href="verification_requests.html"><i class="fas fa-inbox"></i> <span data-i18n="verificationRequests">Verification Requests</span></a>
    <a href="analytics.html"><i class="fas fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></a>
  </nav>

  <main class="container">
    <!-- ===== Fixed Top Section ===== -->
    <section class="fixed-top-section">
      <div class="dashboard-cards">
        <div class="card total"><h3 data-i18n="totalLicenses">Total Licenses</h3><h2 id="totalLicenses">0</h2></div>
        <div class="card active"><h3 data-i18n="activeLicenses">Active</h3><h2 id="activeLicenses">0</h2></div>
        <div class="card suspended"><h3 data-i18n="suspended">Suspended</h3><h2 id="suspendedLicenses">0</h2></div>
        <div class="card expired"><h3 data-i18n="expired">Expired</h3><h2 id="expiredLicenses">0</h2></div>
      </div>

      <div class="search-export">
        <input id="licenseSearch" type="text" data-i18n="[placeholder]searchLicenses" placeholder="Search licenses..." />
        <button id="exportLicenses"><i class="fas fa-file-export"></i> <span data-i18n="export">Export</span></button>
      </div>
    </section>

    <!-- Scrollable Table -->
    <section class="table-container">
      <table id="licensesTable">
        <thead>
          <tr>
            <th data-i18n="licenseNumber">License #</th>
            <th data-i18n="fullName">Full Name</th>
            <th data-i18n="class">Class</th>
            <th data-i18n="issueDate">Issue</th>
            <th data-i18n="expiryDate">Expiry</th>
            <th data-i18n="status">Status</th>
            <th data-i18n="action">Action</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="7" data-i18n="loading">Loading...</td></tr></tbody>
      </table>
    </section>
  </main>

  <!-- ===== Modal ===== -->
  <div class="modal-overlay" id="editModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
      <header>
        <h3 id="editModalTitle"><i class="fas fa-pen-to-square"></i> <span data-i18n="editLicense">Edit License</span></h3>
        <button class="btn-secondary" id="modalCloseBtn" aria-label="Close"><i class="fas fa-times"></i></button>
      </header>
      <div class="modal-body">
        <input type="hidden" id="modalLicenseId" />
        <label data-i18n="licenseNumber">License #</label>
        <input type="text" id="modalLicenseNumber" />
        <label data-i18n="fullName">Full Name</label>
        <input type="text" id="modalFullName" />
        <label data-i18n="class">Class</label>
        <select id="modalClass"><option>Class A</option><option>Class B</option><option>Class C</option><option>Class D</option><option>Class E</option><option>Class F</option></select>
        <label data-i18n="issueDate">Issue</label>
        <input type="date" id="modalIssue" />
        <label data-i18n="expiryDate">Expiry</label>
        <input type="date" id="modalExpiry" />
        <label data-i18n="status">Status</label>
        <select id="modalStatus"><option>Active</option><option>Suspended</option><option>Expired</option></select>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" id="modalCancelBtn" data-i18n="cancel">Cancel</button>
        <button class="btn-primary" id="modalSaveBtn"><i class="fas fa-save"></i> <span data-i18n="saveChanges">Save / Update</span></button>
      </div>
    </div>
  </div>

  <!-- ===== Firebase + Logic ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ===== i18n ===== */
    const i18n = window.i18next;
    const $ = window.$;
    const jqueryI18next = window.jqueryI18next;
    const resources = {
      en:{translation:{dashboard:"Dashboard",verificationPortal:"Verification",addLicense:"Add License",userManagement:"User Management",verificationRequests:"Verification Requests",analytics:"Analytics",logout:"Logout",totalLicenses:"Total Licenses",activeLicenses:"Active",suspended:"Suspended",expired:"Expired",licenseNumber:"License #",fullName:"Full Name",class:"Class",issueDate:"Issue",expiryDate:"Expiry",status:"Status",action:"Action",loading:"Loading...",export:"Export",searchLicenses:"Search licenses...",editLicense:"Edit License",cancel:"Cancel",saveChanges:"Save / Update",delete:"Delete",confirmDelete:"Delete this license?"}},
      fr:{translation:{dashboard:"Tableau de bord",verificationPortal:"Vérification",addLicense:"Ajouter un permis",userManagement:"Gestion des utilisateurs",verificationRequests:"Demandes de vérification",analytics:"Analytique",logout:"Déconnexion",totalLicenses:"Nombre total de permis",activeLicenses:"Actifs",suspended:"Suspendus",expired:"Expirés",licenseNumber:"N° de permis",fullName:"Nom complet",class:"Catégorie",issueDate:"Émission",expiryDate:"Expiration",status:"Statut",action:"Action",loading:"Chargement...",export:"Exporter",searchLicenses:"Rechercher des permis…",editLicense:"Modifier le permis",cancel:"Annuler",saveChanges:"Enregistrer / Mettre à jour",delete:"Supprimer",confirmDelete:"Supprimer ce permis ?"}},
      ja:{translation:{dashboard:"ダッシュボード",verificationPortal:"照合",addLicense:"免許を追加",userManagement:"ユーザー管理",verificationRequests:"照合リクエスト",analytics:"分析",logout:"ログアウト",totalLicenses:"総免許数",activeLicenses:"有効",suspended:"停止中",expired:"期限切れ",licenseNumber:"免許番号",fullName:"氏名",class:"区分",issueDate:"発行",expiryDate:"有効期限",status:"ステータス",action:"操作",loading:"読み込み中…",export:"エクスポート",searchLicenses:"免許を検索…",editLicense:"免許を編集",cancel:"キャンセル",saveChanges:"保存 / 更新",delete:"削除",confirmDelete:"この免許を削除しますか？"}}
    };
    i18n.use(i18nextBrowserLanguageDetector).init({resources,fallbackLng:"en"},()=>{jqueryI18next.init(i18n,$,{useOptionsAttr:true});$("body").localize();});
    document.getElementById("languageSwitcher").addEventListener("change",function(){i18n.changeLanguage(this.value,()=>$("body").localize());});

    /* ===== Auth ===== */
    onAuthStateChanged(auth,async user=>{
      if(!user){location.href="index.html";return;}
      const roleSnap=await getDoc(doc(db,"roles",user.email));
      const role=roleSnap.exists()?roleSnap.data().role:"verifier";
      const adminOnly=document.getElementById("navVerificationRequests");
      if(adminOnly)adminOnly.style.display=(role==="admin")?"block":"none";
    });
    document.getElementById("logoutBtn").addEventListener("click",()=>signOut(auth).then(()=>location.href="index.html"));

    /* ===== Table + Counters ===== */
    const tbody=document.querySelector("#licensesTable tbody");
    const qLic=query(collection(db,"licenses"),orderBy("licenseNumber"));
    onSnapshot(qLic,snapshot=>{
      let total=0,active=0,suspended=0,expired=0;
      tbody.innerHTML="";
      if(snapshot.empty){tbody.innerHTML=`<tr><td colspan='7'>No licenses
      if(snapshot.empty){
        tbody.innerHTML = `<tr><td colspan='7' data-i18n="loading">No licenses found</td></tr>`;
        $("body").localize();
        return;
      }

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        total++;
        if (data.status === "Active") active++;
        if (data.status === "Suspended") suspended++;
        if (data.status === "Expired") expired++;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${data.licenseNumber || ""}</td>
          <td>${data.fullName || ""}</td>
          <td>${data.class || ""}</td>
          <td>${data.issue || ""}</td>
          <td>${data.expiry || ""}</td>
          <td>${data.status || ""}</td>
          <td>
            <button class="btn-inline edit-btn" data-id="${docSnap.id}"><i class="fas fa-pen"></i></button>
            <button class="btn-inline btn-danger delete-btn" data-id="${docSnap.id}"><i class="fas fa-trash"></i></button>
          </td>`;
        tbody.appendChild(row);
      });

      document.getElementById("totalLicenses").textContent = total;
      document.getElementById("activeLicenses").textContent = active;
      document.getElementById("suspendedLicenses").textContent = suspended;
      document.getElementById("expiredLicenses").textContent = expired;
      $("body").localize();
    });

    /* ===== Edit License Modal ===== */
    const modalOverlay = document.getElementById("editModalOverlay");
    const modalClose = document.getElementById("modalCloseBtn");
    const modalCancel = document.getElementById("modalCancelBtn");
    const modalSave = document.getElementById("modalSaveBtn");

    function openModal(id, data) {
      modalOverlay.classList.add("show");
      document.getElementById("modalLicenseId").value = id;
      document.getElementById("modalLicenseNumber").value = data.licenseNumber || "";
      document.getElementById("modalFullName").value = data.fullName || "";
      document.getElementById("modalClass").value = data.class || "Class A";
      document.getElementById("modalIssue").value = data.issue || "";
      document.getElementById("modalExpiry").value = data.expiry || "";
      document.getElementById("modalStatus").value = data.status || "Active";
    }

    function closeModal() {
      modalOverlay.classList.remove("show");
    }

    modalClose.addEventListener("click", closeModal);
    modalCancel.addEventListener("click", closeModal);

    // Delegate click events on table for edit/delete
    tbody.addEventListener("click", async (e) => {
      const editBtn = e.target.closest(".edit-btn");
      const delBtn = e.target.closest(".delete-btn");
      if (editBtn) {
        const id = editBtn.dataset.id;
        const docRef = doc(db, "licenses", id);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          openModal(id, docSnap.data());
        }
      }
      if (delBtn) {
        const id = delBtn.dataset.id;
        if (confirm(i18n.t("confirmDelete"))) {
          await deleteDoc(doc(db, "licenses", id));
        }
      }
    });

    // Save/Update license
    modalSave.addEventListener("click", async () => {
      const id = document.getElementById("modalLicenseId").value;
      const updatedData = {
        licenseNumber: document.getElementById("modalLicenseNumber").value.trim(),
        fullName: document.getElementById("modalFullName").value.trim(),
        class: document.getElementById("modalClass").value,
        issue: document.getElementById("modalIssue").value,
        expiry: document.getElementById("modalExpiry").value,
        status: document.getElementById("modalStatus").value
      };
      if (!id) return;
      await setDoc(doc(db, "licenses", id), updatedData, { merge: true });
      closeModal();
    });

    /* ===== Search Function ===== */
    document.getElementById("licenseSearch").addEventListener("keyup", function () {
      const filter = this.value.toLowerCase();
      const rows = tbody.getElementsByTagName("tr");
      for (let i = 0; i < rows.length; i++) {
        const text = rows[i].textContent.toLowerCase();
        rows[i].style.display = text.includes(filter) ? "" : "none";
      }
    });

    /* ===== Export CSV ===== */
    document.getElementById("exportLicenses").addEventListener("click", () => {
      const rows = [["License #", "Full Name", "Class", "Issue", "Expiry", "Status"]];
      const trs = tbody.querySelectorAll("tr");
      trs.forEach(tr => {
        const cols = tr.querySelectorAll("td");
        if (cols.length === 7) {
          rows.push([
            cols[0].innerText,
            cols[1].innerText,
            cols[2].innerText,
            cols[3].innerText,
            cols[4].innerText,
            cols[5].innerText
          ]);
        }
      });
      let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "licenses.csv");
      link.click();
    });
  </script>
</body>
</html>
