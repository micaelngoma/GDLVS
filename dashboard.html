<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- i18n + jQuery -->
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <style>
    body{font-family:Arial,sans-serif;color:#333;margin:0;background:#f6f8fb}
    .background-image{position:fixed;inset:0;background:url('https://raw.githubusercontent.com/micaelngoma/GDLVS/main/Gabon%20Forest.jpg') center/cover no-repeat;z-index:-1;filter:brightness(0.9)}
    header{background:#2a3f54;color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;position:fixed;top:0;left:0;right:0;z-index:1000}
    header h1{margin:0;font-size:1.1rem;display:flex;gap:8px;align-items:center}
    .controls{display:flex;gap:8px;align-items:center}
    .controls select,.controls button{padding:6px 10px;border-radius:8px;border:0;font-size:.9rem}
    .controls select{background:#fff;color:#000}
    .controls button{background:#1e2d3c;color:#fff;cursor:pointer}
    nav{background:#1e2d3c;color:#fff;padding:10px 14px;display:flex;gap:16px;position:fixed;top:56px;left:0;right:0;z-index:999}
    nav a{color:#fff;text-decoration:none;font-weight:bold;transition:all 0.25s ease-in-out}
    nav a.active{border-bottom:2px solid #f1c40f;padding-bottom:3px}
    nav a:hover{border-bottom:2px solid #f1c40f;padding-bottom:3px;box-shadow:0 2px 6px rgba(241,196,15,0.7)}
    .container{max-width:95vw;margin:120px auto 0;background:rgba(255,255,255,0.9);padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.2)}
    .dashboard
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal-overlay.show{display:flex}
    .modal{background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.3);width:min(480px,90vw)}
    .modal header{background:#2a3f54;color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:16px;display:flex;flex-direction:column;gap:8px}
    .modal-actions{padding:10px;display:flex;justify-content:flex-end;gap:10px;background:#fafafa;border-top:1px solid #eee}
    .btn-primary{background:#27ae60;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn-secondary{background:#95a5a6;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  </style>
</head>
<body>
  <div class="background-image"></div>
  <!-- (Header, Nav, and Main remain unchanged from previous version) -->

  <!-- ===== Modal ===== -->
  <div class="modal-overlay" id="editModalOverlay" aria-hidden="true">
    <div class="modal">
      <header>
        <h3><i class="fas fa-pen-to-square"></i> <span data-i18n="editLicense">Edit License</span></h3>
        <button class="btn-secondary" id="modalCloseBtn"><i class="fas fa-times"></i></button>
      </header>
      <div class="modal-body">
        <input type="hidden" id="modalLicenseId" />
        <label data-i18n="licenseNumber">License #</label>
        <input type="text" id="modalLicenseNumber" />
        <label data-i18n="fullName">Full Name</label>
        <input type="text" id="modalFullName" />
        <label data-i18n="class">Class</label>
        <select id="modalClass">
          <option>Class A</option><option>Class B</option><option>Class C</option>
          <option>Class D</option><option>Class E</option><option>Class F</option>
        </select>
        <label data-i18n="issueDate">Issue</label>
        <input type="date" id="modalIssue" />
        <label data-i18n="expiryDate">Expiry</label>
        <input type="date" id="modalExpiry" />
        <label data-i18n="status">Status</label>
        <select id="modalStatus">
          <option>Active</option><option>Suspended</option><option>Expired</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" id="modalCancelBtn" data-i18n="cancel">Cancel</button>
        <button class="btn-primary" id="modalSaveBtn"><i class="fas fa-save"></i> <span data-i18n="saveChanges">Save / Update</span></button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Modal Logic =====
    const overlay=document.getElementById("editModalOverlay");
    const fields={
      id:document.getElementById("modalLicenseId"),
      licenseNumber:document.getElementById("modalLicenseNumber"),
      fullName:document.getElementById("modalFullName"),
      klass:document.getElementById("modalClass"),
      issue:document.getElementById("modalIssue"),
      expiry:document.getElementById("modalExpiry"),
      status:document.getElementById("modalStatus")
    };
    const closeModal=()=>{overlay.classList.remove("show");overlay.setAttribute("aria-hidden","true");};
    document.getElementById("modalCloseBtn").onclick=closeModal;
    document.getElementById("modalCancelBtn").onclick=closeModal;

    const openModal=data=>{
      fields.id.value=data.licenseNumber||data.id||"";
      fields.licenseNumber.value=data.licenseNumber||"";
      fields.fullName.value=data.fullName||"";
      fields.klass.value=data.class||"Class A";
      fields.issue.value=(data.issueDate||"").slice(0,10);
      fields.expiry.value=(data.expiryDate||"").slice(0,10);
      fields.status.value=data.status||"Active";
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
    };

    // Save / Update
    document.getElementById("modalSaveBtn").onclick=async()=>{
      const newId=fields.licenseNumber.value.trim();
      const oldId=fields.id.value.trim();
      if(!newId){alert("Missing License #");return;}
      const payload={
        licenseNumber:newId,fullName:fields.fullName.value.trim(),
        class:fields.klass.value,status:fields.status.value,
        issueDate:fields.issue.value,expiryDate:fields.expiry.value
      };
      try{
        if(oldId&&oldId!==newId){await deleteDoc(doc(db,"licenses",oldId));}
        await setDoc(doc(db,"licenses",newId),payload,{merge:true});
        closeModal();
      }catch(err){alert(err.message);}
    };

    // ===== Table Click Events =====
    const tbody=document.querySelector("#licensesTable tbody");
    tbody.addEventListener("click",async e=>{
      const edit=e.target.closest("button[data-action='update']");
      const del=e.target.closest("button[data-action='delete']");
      if(edit){
        const id=edit.dataset.id;
        const snap=await getDoc(doc(db,"licenses",id));
        if(snap.exists())openModal(snap.data());
      }
      if(del){
        const id=del.dataset.id;
        if(confirm(i18next.t("confirmDelete")||"Delete this license?")){
          await deleteDoc(doc(db,"licenses",id));
        }
      }
    });
  </script>
</body>
</html>
