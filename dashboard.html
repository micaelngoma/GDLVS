<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root {
      --brand-dark:#2a3f54; --brand-dark-2:#1e2d3c; --panel:#fff; --muted:#666;
      --success:#27ae60; --danger:#e74c3c; --warn:#f1c40f; --info:#2980b9;
      --shadow:0 2px 6px rgba(0,0,0,.1);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6f8fb;color:#333}
    header{
      background:var(--brand-dark);color:#fff;display:flex;align-items:center;justify-content:space-between;
      padding:10px 14px
    }
    header h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
    .header-controls{display:flex;gap:8px;align-items:center}
    .mini-btn{
      background:var(--brand-dark-2);color:#fff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:12px
    }
    .mini-select{
      border:1px solid #dcdcdc;border-radius:8px;padding:6px 8px;font-size:12px;background:#fff
    }
    nav{background:#fff;border-bottom:1px solid #eaeaea;padding:10px 14px;display:flex;gap:14px;flex-wrap:wrap}
    nav a{color:var(--brand-dark);font-weight:700;text-decoration:none}
    nav a.active{border-bottom:2px solid var(--brand-dark);padding-bottom:4px}
    .container{max-width:1100px;margin:20px auto;padding:0 14px}
    .panel{background:#fff;border-radius:10px;box-shadow:var(--shadow);padding:20px;margin:18px 0}
    .dashboard-cards{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin:10px 0 16px}
    .card{flex:1 1 180px;max-width:210px;min-width:150px;color:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);text-align:center;padding:14px}
    .card i{display:block;font-size:20px;margin-bottom:6px}
    .card.total{background:#2980b9}
    .card.active{background:#27ae60}
    .card.suspended{background:#f1c40f;color:#333}
    .card.expired{background:#e74c3c}
    .table-controls{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .table-controls input{max-width:260px;border:1px solid #dcdcdc;border-radius:8px;padding:8px 10px}
    .btn-export{background:var(--info);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .verification-table-wrapper{overflow-x:auto}
    table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:10px}
    th,td{background:#fff;border:1px solid #eee;padding:10px 12px;text-align:left}
    th{background:#f2f2f2}
    #licensesTable th:nth-child(3),#licensesTable td:nth-child(3){min-width:180px}
    #licensesTable th:nth-child(6),#licensesTable td:nth-child(6){min-width:160px;white-space:nowrap}
    footer{display:flex;justify-content:center;gap:8px;margin:20px 0 40px;color:var(--muted)}
    @media(max-width:900px){header{flex-direction:column;gap:8px}}
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-id-card"></i><span data-i18n="dashboard">Dashboard</span></h1>
    <div class="header-controls">
      <select id="languageSwitcher" class="mini-select" aria-label="Language">
        <option value="en">üá¨üáß English</option><option value="fr">üá´üá∑ Fran√ßais</option><option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
      </select>
      <button id="logoutBtn" class="mini-btn"><i class="fa-solid fa-right-from-bracket"></i> <span data-i18n="logout">Logout</span></button>
    </div>
  </header>

  <nav>
    <a href="dashboard.html" class="active"><i class="fa-solid fa-house"></i> <span data-i18n="dashboard">Dashboard</span></a>
    <a href="verify.html"><i class="fa-solid fa-search"></i> <span data-i18n="verificationPortal">Verification</span></a>
    <a href="add_licenses.html"><i class="fa-solid fa-id-card"></i> <span data-i18n="addLicense">Add License</span></a>
    <a href="users.html"><i class="fa-solid fa-users-cog"></i> <span data-i18n="userManagement">Users</span></a>
    <a href="verification_requests.html"><i class="fa-solid fa-inbox"></i> <span data-i18n="requests">Requests</span></a>
    <a href="analytics.html"><i class="fa-solid fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></a>
  </nav>

  <main class="container">
    <section class="dashboard-cards">
      <div class="card total"><i class="fa-solid fa-user"></i><h3 data-i18n="totalLicenses">Total Licenses</h3><h2 id="totalLicenses">0</h2></div>
      <div class="card active"><i class="fa-solid fa-circle-check"></i><h3 data-i18n="active">Active</h3><h2 id="activeLicenses">0</h2></div>
      <div class="card suspended"><i class="fa-solid fa-triangle-exclamation"></i><h3 data-i18n="suspended">Suspended</h3><h2 id="suspendedLicenses">0</h2></div>
      <div class="card expired"><i class="fa-solid fa-ban"></i><h3 data-i18n="expired">Expired</h3><h2 id="expiredLicenses">0</h2></div>
    </section>

    <section class="panel">
      <h2><i class="fa-solid fa-id-badge"></i> <span data-i18n="licenses">Licenses</span></h2>
      <div class="table-controls">
        <input id="licenseSearch" type="text" data-i18n="[placeholder]searchLicensesPh" placeholder="Search licenses...">
        <button id="exportLicenses" class="btn-export"><i class="fa-solid fa-file-export"></i> <span data-i18n="export">Export</span></button>
      </div>

      <div class="verification-table-wrapper">
        <table id="licensesTable">
          <thead>
            <tr>
              <th data-i18n="licenseNumber">License #</th>
              <th data-i18n="fullName">Full Name</th>
              <th data-i18n="class">Class</th>
              <th data-i18n="issue">Issue</th>
              <th data-i18n="expiry">Expiry</th>
              <th data-i18n="status">Status</th>
              <th data-i18n="action">Action</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="7" data-i18n="loading">Loading...</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <i class="fa-solid fa-globe"></i>
    <span data-i18n="languageNote">Change language from the menu above.</span>
  </footer>

  <script type="module">
    /* ---------- Imports ---------- */
    import { auth, db } from './firebase-config.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    /* ---------- i18n (inline) ---------- */
    const i18nResources = {
      en:{t:{dashboard:"Dashboard",logout:"Logout",verificationPortal:"Verification",addLicense:"Add License",userManagement:"User Management",requests:"Requests",analytics:"Analytics",totalLicenses:"Total Licenses",active:"Active",suspended:"Suspended",expired:"Expired",licenses:"Licenses",licenseNumber:"License #",fullName:"Full Name",class:"Class",issue:"Issue",expiry:"Expiry",status:"Status",action:"Action",loading:"Loading...",export:"Export",searchLicensesPh:"Search licenses...",view:"View",languageNote:"Change language from the menu above."}},
      fr:{t:{dashboard:"Tableau de bord",logout:"D√©connexion",verificationPortal:"V√©rification",addLicense:"Ajouter un permis",userManagement:"Gestion des utilisateurs",requests:"Demandes",analytics:"Analytique",totalLicenses:"Total des permis",active:"Actif",suspended:"Suspendu",expired:"Expir√©",licenses:"Permis",licenseNumber:"N¬∞ de permis",fullName:"Nom complet",class:"Cat√©gorie",issue:"√âmission",expiry:"Expiration",status:"Statut",action:"Action",loading:"Chargement...",export:"Exporter",searchLicensesPh:"Rechercher des permis...",view:"Voir",languageNote:"Changez la langue dans le menu ci-dessus."}},
      ja:{t:{dashboard:"„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ",logout:"„É≠„Ç∞„Ç¢„Ç¶„Éà",verificationPortal:"ÁÖß‰ºö",addLicense:"ÂÖçË®±„ÇíËøΩÂä†",userManagement:"„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ",requests:"„É™„ÇØ„Ç®„Çπ„Éà",analytics:"ÂàÜÊûê",totalLicenses:"Á∑èÂÖçË®±Êï∞",active:"ÊúâÂäπ",suspended:"ÂÅúÊ≠¢",expired:"Â§±Âäπ",licenses:"ÂÖçË®±",licenseNumber:"ÂÖçË®±Áï™Âè∑",fullName:"Ê∞èÂêç",class:"Âå∫ÂàÜ",issue:"Áô∫Ë°åÊó•",expiry:"ÊúâÂäπÊúüÈôê",status:"Áä∂ÊÖã",action:"Êìç‰Ωú",loading:"Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶",export:"„Ç®„ÇØ„Çπ„Éù„Éº„Éà",searchLicensesPh:"ÂÖçË®±„ÇíÊ§úÁ¥¢‚Ä¶",view:"Ë°®Á§∫",languageNote:"‰∏ä„ÅÆ„É°„Éã„É•„Éº„Åã„ÇâË®ÄË™û„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ"}}
    };
    const t=(k)=>i18nResources[currentLang].t[k]||i18nResources.en.t[k];
    let currentLang=localStorage.getItem('gdlvs_lang')||'en';
    const applyI18n=()=>{
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key=el.getAttribute('data-i18n');
        if(key.startsWith('[placeholder]')){ el.placeholder=t(key.replace('[placeholder]','')); }
        else el.textContent=t(key);
      });
    };
    const langSel=document.getElementById('languageSwitcher');
    langSel.value=currentLang; applyI18n();
    langSel.addEventListener('change',()=>{ currentLang=langSel.value; localStorage.setItem('gdlvs_lang',currentLang); applyI18n(); });

    /* ---------- Auth gate + logout ---------- */
    onAuthStateChanged(auth,(user)=>{ if(!user){ location.href='index.html'; }});
    document.getElementById('logoutBtn').onclick=()=>signOut(auth).then(()=>location.href='index.html');

    /* ---------- Licenses realtime + counters ---------- */
    const tbody=document.querySelector('#licensesTable tbody');
    const qLicenses=query(collection(db,'licenses'), orderBy('licenseNumber'));
    onSnapshot(qLicenses,(snap)=>{
      let total=0,active=0,suspended=0,expired=0;
      tbody.innerHTML='';
      if(snap.empty){ tbody.innerHTML=`<tr><td colspan="7">${t('loading')}</td></tr>`; return; }
      snap.forEach(docSnap=>{
        const d=docSnap.data(); total++;
        const st=(d.status||'').toLowerCase();
        if(st.includes('active')||st.includes('ÊúâÂäπ')||st.includes('actif')) active++;
        else if(st.includes('suspend')||st.includes('ÂÅúÊ≠¢')) suspended++;
        else if(st.includes('expir')||st.includes('Â§±Âäπ')) expired++;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${d.licenseNumber||docSnap.id}</td>
          <td>${d.fullName||''}</td>
          <td>${d.class||''}</td>
          <td>${d.issueDate||''}</td>
          <td>${d.expiryDate||''}</td>
          <td>${d.status||''}</td>
          <td><button class="mini-btn" style="background:#2980b9">${t('view')}</button></td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('totalLicenses').textContent=total;
      document.getElementById('activeLicenses').textContent=active;
      document.getElementById('suspendedLicenses').textContent=suspended;
      document.getElementById('expiredLicenses').textContent=expired;
    });

    /* ---------- Search + Export ---------- */
    document.getElementById('licenseSearch').addEventListener('keyup',(e)=>{
      const term=e.target.value.toLowerCase();
      document.querySelectorAll('#licensesTable tbody tr').forEach(r=>{
        r.style.display=r.textContent.toLowerCase().includes(term)?'':'none';
      });
    });
    document.getElementById('exportLicenses').addEventListener('click',()=>{
      const rows=[...document.querySelectorAll('#licensesTable tr')];
      const csv=rows.map(r=>[...r.querySelectorAll('th,td')].map(c=>`"${c.innerText.replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='licenses.csv'; a.click();
    });
  </script>
</body>
</html>
