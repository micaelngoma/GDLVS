<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- ===== Inline CSS (styled like your dashboard) ===== -->
  <style>
    :root{
      --brand-dark:#2a3f54; --brand-dark-2:#1e2d3c; --text:#333; --muted:#666;
      --panel-bg:#fff; --card-shadow:0 2px 6px rgba(0,0,0,0.1);
      --success:#27ae60; --danger:#e74c3c; --warn:#f1c40f; --info:#2980b9;
      --bg:#f6f8fb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Arial, sans-serif;color:var(--text);background:var(--bg)}
    header{
      background:var(--brand-dark);color:#fff;padding:12px 20px;
      display:flex;justify-content:space-between;align-items:center
    }
    header h1{margin:0;font-size:1.2rem}
    header button{background:var(--brand-dark-2);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    header button:hover{background:#16222d}
    nav{
      background:#fff;border-bottom:1px solid #eaeaea;padding:10px 20px;display:flex;flex-wrap:wrap;gap:15px
    }
    nav a{color:var(--brand-dark);text-decoration:none;font-weight:bold}
    nav a.active{border-bottom:2px solid var(--brand-dark);padding-bottom:4px}
    .container{max-width:980px;margin:22px auto 40px;padding:24px;background:var(--panel-bg);border-radius:10px;box-shadow:var(--card-shadow)}
    label{display:block;margin-top:8px;font-weight:600}
    input,textarea,button,select{
      width:100%;padding:10px;margin:8px 0;border:1px solid #dcdcdc;border-radius:8px;font-size:.98rem;background:#fff
    }
    textarea{min-height:110px;resize:vertical}
    button{background:var(--brand-dark);color:#fff;cursor:pointer}
    button:hover{background:var(--brand-dark-2)}
    button.inline{width:auto;padding:6px 12px;border-radius:8px}
    .panel{background:#fff;border-radius:10px;box-shadow:var(--card-shadow);padding:20px;margin:20px auto}
    footer{text-align:center;margin:24px 0 40px}
    #languageSwitcher{width:auto;padding:6px 10px;border-radius:8px}
    .muted{color:var(--muted)}
    /* Result block styling consistent with your current look */
    #verifyResult h3{margin:0 0 8px}
    #verifyResult .ok{color:var(--success);font-weight:700}
    #verifyResult .bad{color:var(--danger);font-weight:700}
    @media(max-width:900px){nav{justify-content:center}header{flex-direction:column;gap:8px}.container{width:95%}}
  </style>

  <!-- i18n + jQuery (for placeholders) -->
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <!-- EmailJS (for admin notifications) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    // ‚úÖ Initialize EmailJS (uses your existing public key)
    (function(){ emailjs.init("TfmaZEvxtz2MNUb70"); })();
    // Set your service/template IDs here (reuse your service; template can be the same or a new one)
    window.EMAILJS_SERVICE_ID = "service_ddq3kka";
    window.EMAILJS_TEMPLATE_ID = "template_inl3jsv"; /* replace with a dedicated verify template if you have one */
    window.ADMIN_EMAIL = "m.ngoma1988@gmail.com";    /* admin notification target (optional; can be inside your EmailJS template) */
  </script>

  <!-- Firebase (modular) + page logic -->
  <script type="module">
    import { auth, db } from './firebase-config.js';
    import {
      doc, getDoc, collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    /* ========= i18n resources (EN/FR/JA) ========= */
    const resources = {
      en: {
        translation: {
          verificationPortal: "Verification",
          logout: "Logout",
          dashboard: "Dashboard",
          addLicense: "Add License",
          userManagement: "User Management",
          verificationRequests: "Verification Requests",
          analytics: "Analytics",
          licenseNumber: "License Number",
          organization: "Requesting Organization",
          country: "Country",
          purpose: "Purpose of Verification",
          verify: "Verify",
          placeholders: {
            licenseNumber: "Enter license number",
            organization: "Enter requesting organization",
            country: "Enter country",
            purpose: "Describe the purpose"
          },
          adminOnly: "Requests"
        }
      },
      fr: {
        translation: {
          verificationPortal: "V√©rification",
          logout: "D√©connexion",
          dashboard: "Tableau de bord",
          addLicense: "Ajouter un permis",
          userManagement: "Gestion des utilisateurs",
          verificationRequests: "Demandes de v√©rification",
          analytics: "Analytique",
          licenseNumber: "Num√©ro du permis",
          organization: "Organisme demandeur",
          country: "Pays",
          purpose: "Objet de la v√©rification",
          verify: "V√©rifier",
          placeholders: {
            licenseNumber: "Saisir le num√©ro du permis",
            organization: "Saisir l‚Äôorganisme",
            country: "Saisir le pays",
            purpose: "D√©crivez l‚Äôobjet"
          },
          adminOnly: "Demandes"
        }
      },
      ja: {
        translation: {
          verificationPortal: "ÁÖß‰ºö",
          logout: "„É≠„Ç∞„Ç¢„Ç¶„Éà",
          dashboard: "„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ",
          addLicense: "ÂÖçË®±„ÇíËøΩÂä†",
          userManagement: "„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ",
          verificationRequests: "ÁÖß‰ºö„É™„ÇØ„Ç®„Çπ„Éà",
          analytics: "ÂàÜÊûê",
          licenseNumber: "ÂÖçË®±Áï™Âè∑",
          organization: "ÁÖß‰ºöÊ©üÈñ¢",
          country: "ÂõΩ",
          purpose: "ÁÖß‰ºö„ÅÆÁõÆÁöÑ",
          verify: "ÁÖß‰ºö„Åô„Çã",
          placeholders: {
            licenseNumber: "ÂÖçË®±Áï™Âè∑„ÇíÂÖ•Âäõ",
            organization: "Ê©üÈñ¢Âêç„ÇíÂÖ•Âäõ",
            country: "ÂõΩÂêç„ÇíÂÖ•Âäõ",
            purpose: "ÁõÆÁöÑ„ÇíÂÖ•Âäõ"
          },
          adminOnly: "„É™„ÇØ„Ç®„Çπ„Éà"
        }
      }
    };

    // Init i18n
    i18next.use(i18nextBrowserLanguageDetector).init({
      resources, fallbackLng: "en"
    }, () => {
      if (typeof jqueryI18next !== "undefined") {
        jqueryI18next.init(i18next, $, { useOptionsAttr: true });
        $("body").localize();
        // placeholders
        applyPlaceholders();
      }
    });

    function applyPlaceholders(){
      const t = i18next.t.bind(i18next);
      const p = t("placeholders");
      const map = {
        verifyLicenseNumber: p.licenseNumber,
        verifyOrg: p.organization,
        verifyCountry: p.country,
        verifyPurpose: p.purpose
      };
      Object.keys(map).forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.setAttribute("placeholder", map[id]);
      });
    }

    document.getElementById("languageSwitcher")?.addEventListener("change", (e)=>{
      i18next.changeLanguage(e.target.value, ()=> { $("body").localize(); applyPlaceholders(); });
    });

    // Auth gate: show Requests nav only if admin
    onAuthStateChanged(auth, async (user)=>{
      const reqLink = document.getElementById("navVerificationRequests");
      if(!user){
        // Not signed in -> go to login
        window.location.href = "index.html";
        return;
      }
      // If you keep a roles collection, you can pull it here and toggle visibility.
      // For now we simply show it for signed-in users; uncomment below if needed.
      // import { getDoc, doc } from 'firebase/firestore'; (already imported)
      try{
        const snap = await getDoc(doc(db, "roles", user.email));
        const role = snap.exists() ? (snap.data().role || "verifier") : "verifier";
        if(reqLink) reqLink.style.display = (role === "admin") ? "inline-block" : "none";
      }catch{ if(reqLink) reqLink.style.display = "none"; }
    });

    // Sign out handler for header button
    window.signOutUser = () => signOut(auth).then(()=> window.location.href="index.html");

    // ======= Verify handler (keeps your current result layout) =======
    window.verifyLicense = async (ev)=>{
      if(ev) ev.preventDefault();
      const licenseNumber = document.getElementById("verifyLicenseNumber")?.value.trim();
      const org = document.getElementById("verifyOrg")?.value.trim();
      const country = document.getElementById("verifyCountry")?.value.trim();
      const purpose = document.getElementById("verifyPurpose")?.value.trim();
      const resultEl = document.getElementById("verifyResult");
      const nextContainer = document.getElementById("verifyNextContainer");

      if(!licenseNumber){ alert("‚ö†Ô∏è " + i18next.t("licenseNumber") + " required"); return; }

      try{
        // Lookup
        const snap = await getDoc(doc(db, "licenses", licenseNumber));
        const exists = snap.exists();
        const d = exists ? snap.data() : {};
        const resultText = exists ? "License found" : "License not found";

        // Log to Firestore
        await addDoc(collection(db, "verifications"), {
          licenseNumber,
          requestingOrg: org || "",
          country: country || "",
          purpose: purpose || "",
          email: (auth.currentUser && auth.currentUser.email) || "",
          result: resultText,
          verifiedAt: serverTimestamp(),
          verifiedBy: (auth.currentUser && auth.currentUser.uid) || ""
        });

        // Email admin (optional)
        try{
          if(window.emailjs){
            await emailjs.send(
              window.EMAILJS_SERVICE_ID,
              window.EMAILJS_TEMPLATE_ID,
              {
                to_email: window.ADMIN_EMAIL,
                subject: "GDLVS - New Verification",
                licenseNumber, org, country, purpose,
                result: resultText,
                user_email: (auth.currentUser && auth.currentUser.email) || ""
              }
            );
          }
        }catch(e){ console.warn("EmailJS error:", e); }

        // Render result block (same structure you‚Äôve been using)
        if(resultEl){
          resultEl.style.display = "block";
          resultEl.innerHTML = `
            <h3 class="${exists ? 'ok' : 'bad'}">${exists ? "‚úÖ License Found" : "‚ùå License Not Found"}</h3>
            <p><strong>License #:</strong> ${licenseNumber}</p>
            ${exists ? `
              <p><strong>Full Name:</strong> ${d.fullName || "N/A"}</p>
              <p><strong>Class:</strong> ${d.class || "N/A"}</p>
              <p><strong>Issue:</strong> ${d.issueDate || "N/A"}</p>
              <p><strong>Expiry:</strong> ${d.expiryDate || "N/A"}</p>
              <p><strong>Status:</strong> ${d.status || "N/A"}</p>
            ` : ""}
            <hr>
            <p><strong>Organization:</strong> ${org || "‚Äî"}</p>
            <p><strong>Country:</strong> ${country || "‚Äî"}</p>
            <p><strong>Purpose:</strong> ${purpose || "‚Äî"}</p>
          `;
        }
        if(nextContainer){
          nextContainer.style.display = "block";
          document.getElementById("verifyNextBtn").onclick = ()=>{
            document.getElementById("verifyForm").reset();
            resultEl.style.display = "none";
            nextContainer.style.display = "none";
          };
        }
      }catch(err){
        console.error(err);
        alert("‚ùå " + err.message);
      }
    };
  </script>
</head>
<body>
  <header>
    <h1><i class="fas fa-search"></i> <span data-i18n="verificationPortal">Verification</span></h1>
    <button onclick="signOutUser()"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span></button>
  </header>

  <nav>
    <a href="dashboard.html"><i class="fas fa-home"></i> <span data-i18n="dashboard">Dashboard</span></a>
    <a href="verify.html" class="active"><i class="fas fa-search"></i> <span data-i18n="verificationPortal">Verification</span></a>
    <a href="add_licenses.html"><i class="fas fa-id-card"></i> <span data-i18n="addLicense">Add License</span></a>
    <a href="users.html"><i class="fas fa-users-cog"></i> <span data-i18n="userManagement">User Management</span></a>
    <a id="navVerificationRequests" href="verification_requests.html" style="display:none;"><i class="fas fa-inbox"></i> <span data-i18n="verificationRequests">Verification Requests</span></a>
    <a href="analytics.html"><i class="fas fa-chart-bar"></i> <span data-i18n="analytics">Analytics</span></a>
  </nav>

  <main>
    <div class="container">
      <form id="verifyForm" onsubmit="verifyLicense(event)">
        <label data-i18n="licenseNumber">License Number</label>
        <input type="text" id="verifyLicenseNumber" required />

        <label data-i18n="organization">Requesting Organization</label>
        <input type="text" id="verifyOrg" />

        <label data-i18n="country">Country</label>
        <input type="text" id="verifyCountry" />

        <label data-i18n="purpose">Purpose of Verification</label>
        <textarea id="verifyPurpose"></textarea>

        <button type="submit"><i class="fas fa-search"></i> <span data-i18n="verify">Verify</span></button>
      </form>

      <div id="verifyResult" class="panel" style="display:none;"></div>

      <div id="verifyNextContainer" style="display:none; margin-top:15px;">
        <button type="button" id="verifyNextBtn" class="inline"><i class="fas fa-plus"></i> Verify Next Driver License</button>
      </div>
    </div>
  </main>

  <footer>
    <label for="languageSwitcher"><i class="fas fa-globe"></i></label>
    <select id="languageSwitcher">
      <option value="en">üá¨üáß English</option>
      <option value="fr">üá´üá∑ Fran√ßais</option>
      <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
    </select>
  </footer>
</body>
</html>
