<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root {
      --brand-dark: #2a3f54;
      --brand-dark-2: #1e2d3c;
      --text: #333;
      --bg: #f6f8fb;
      --panel-bg: #fff;
      --success: #27ae60;
      --danger: #e74c3c;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: "Segoe UI", Arial, sans-serif; background:var(--bg); color:var(--text); }

    header {
      background:var(--brand-dark); color:#fff; padding:8px 16px;
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      border-bottom:2px solid #1b2a38;
    }
    header h1 { margin:0; font-size:1.1rem; display:flex; align-items:center; gap:6px; }
    .header-actions { display:flex; align-items:center; gap:10px; }
    header button {
      background:#1f2d3a; color:#fff; border:none; padding:5px 9px;
      border-radius:6px; font-size:0.8rem; cursor:pointer; display:flex; align-items:center; gap:4px;
    }
    header button:hover { background:#16222d; }
    #languageSwitcher {
      padding:4px 6px; border-radius:5px; font-size:0.8rem;
      background:#1f2d3a; color:#fff; border:none; cursor:pointer;
    }

    .container {
      max-width:980px; margin:22px auto 40px; background:var(--panel-bg);
      border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:24px;
    }
    label { font-weight:600; margin-top:8px; display:block; }
    input, textarea, button, select {
      width:100%; padding:10px; margin:8px 0;
      border:1px solid #dcdcdc; border-radius:8px; font-size:0.95rem;
    }
    textarea { min-height:110px; resize:vertical; }
    button {
      background:var(--brand-dark); color:#fff; border:none;
      border-radius:8px; cursor:pointer; transition:background 0.2s;
    }
    button:hover { background:var(--brand-dark-2); }
    .panel {
      margin-top:20px; padding:18px; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08); background:#fff;
    }
    #verifyResult h3 { margin:0 0 8px; }
    #verifyResult .ok { color:var(--success); font-weight:700; }
    #verifyResult .bad { color:var(--danger); font-weight:700; }
  </style>

  <!-- ===== i18n + jQuery ===== -->
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <!-- ===== Firebase ===== -->
  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import {
      doc, getDoc, collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    /* üåê Translations */
    const resources = {
      en:{translation:{verificationPortal:"Verification",logout:"Logout",licenseNumber:"License Number",organization:"Organization",country:"Country",purpose:"Purpose",verify:"Verify"}},
      fr:{translation:{verificationPortal:"V√©rification",logout:"D√©connexion",licenseNumber:"Num√©ro du permis",organization:"Organisation",country:"Pays",purpose:"Objet",verify:"V√©rifier"}},
      ja:{translation:{verificationPortal:"ÁÖß‰ºö",logout:"„É≠„Ç∞„Ç¢„Ç¶„Éà",licenseNumber:"ÂÖçË®±Áï™Âè∑",organization:"ÁµÑÁπî",country:"ÂõΩ",purpose:"ÁõÆÁöÑ",verify:"ÁÖß‰ºö„Åô„Çã"}}
    };
    i18next.use(i18nextBrowserLanguageDetector).init({resources,fallbackLng:"en"},()=>{jqueryI18next.init(i18next,$,{useOptionsAttr:true});$("body").localize();});
    document.getElementById("languageSwitcher")?.addEventListener("change",e=>{i18next.changeLanguage(e.target.value,()=>$("body").localize());});

    /* üîê ROLE ENFORCEMENT */
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Not logged in
        window.location.href = "index.html";
        return;
      }

      try {
        const roleSnap = await getDoc(doc(db, "roles", user.email));
        const role = roleSnap.exists() ? roleSnap.data().role : "verifier";

        if (role === "admin") {
          // ‚úÖ Admin can access all pages, stays here or navigates freely
          console.log("‚úÖ Admin access granted:", user.email);
          return;
        }

        if (role !== "verifier") {
          // Unknown or unapproved role
          console.warn("‚õî Unauthorized role, redirecting to login...");
          window.location.href = "index.html";
          return;
        }

        // Verifier confirmed
        console.log("‚úÖ Verifier access granted:", user.email);

      } catch (err) {
        console.error("‚ùå Role check error:", err);
        window.location.href = "index.html";
      }
    });

    /* üö™ Logout */
    window.signOutUser = () => signOut(auth).then(() => window.location.href = "index.html");

    /* üîç Verification Logic */
    window.verifyLicense = async (e)=>{
      e.preventDefault();
      const licenseNumber=document.getElementById("verifyLicenseNumber").value.trim();
      const org=document.getElementById("verifyOrg").value.trim();
      const country=document.getElementById("verifyCountry").value.trim();
      const purpose=document.getElementById("verifyPurpose").value.trim();
      const resultEl=document.getElementById("verifyResult");
      const nextContainer=document.getElementById("verifyNextContainer");

      if(!licenseNumber){ alert("‚ö†Ô∏è License number required"); return; }

      try{
        const snap=await getDoc(doc(db,"licenses",licenseNumber));
        const exists=snap.exists();
        const d=exists?snap.data():{};
        const resultText=exists?"License found":"License not found";

        await addDoc(collection(db,"verifications"),{
          licenseNumber,requestingOrg:org||"",country:country||"",purpose:purpose||"",
          email:auth.currentUser?.email||"",result:resultText,
          verifiedAt:serverTimestamp()
        });

        resultEl.style.display="block";
        resultEl.innerHTML=`
          <h3 class="${exists?'ok':'bad'}">${exists?'‚úÖ License Found':'‚ùå License Not Found'}</h3>
          ${exists?`
            <p><strong>Full Name:</strong> ${d.fullName||""}</p>
            <p><strong>Class:</strong> ${d.class||""}</p>
            <p><strong>Issue:</strong> ${d.issueDate||""}</p>
            <p><strong>Expiry:</strong> ${d.expiryDate||""}</p>
            <p><strong>Status:</strong> ${d.status||""}</p>
          `:""}
          <hr>
          <p><strong>Organization:</strong> ${org}</p>
          <p><strong>Country:</strong> ${country}</p>
          <p><strong>Purpose:</strong> ${purpose}</p>
        `;
        nextContainer.style.display="block";
        document.getElementById("verifyNextBtn").onclick=()=>{
          document.getElementById("verifyForm").reset();
          resultEl.style.display="none";
          nextContainer.style.display="none";
        };
      }catch(err){console.error(err);alert("‚ùå "+err.message);}
    };
  </script>
</head>

<body>
  <header>
    <h1><i class="fas fa-search"></i> <span data-i18n="verificationPortal">Verification</span></h1>
    <div class="header-actions">
      <select id="languageSwitcher">
        <option value="en">üá¨üáß EN</option>
        <option value="fr">üá´üá∑ FR</option>
        <option value="ja">üáØüáµ JP</option>
      </select>
      <button onclick="signOutUser()"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Logout</span></button>
    </div>
  </header>

  <main>
    <div class="container">
      <form id="verifyForm" onsubmit="verifyLicense(event)">
        <label data-i18n="licenseNumber">License Number</label>
        <input type="text" id="verifyLicenseNumber" required />

        <label data-i18n="organization">Organization</label>
        <input type="text" id="verifyOrg" />

        <label data-i18n="country">Country</label>
        <input type="text" id="verifyCountry" />

        <label data-i18n="purpose">Purpose</label>
        <textarea id="verifyPurpose"></textarea>

        <button type="submit"><i class="fas fa-search"></i> <span data-i18n="verify">Verify</span></button>
      </form>

      <div id="verifyResult" class="panel" style="display:none;"></div>
      <div id="verifyNextContainer" style="display:none; margin-top:15px;">
        <button type="button" id="verifyNextBtn"><i class="fas fa-plus"></i> Verify Next License</button>
      </div>
    </div>
  </main>
</body>
</html>
