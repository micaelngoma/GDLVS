<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Admin Notifications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- i18n + jQuery -->
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root {
      --brand-dark: #2a3f54;
      --brand-dark-2: #1e2d3c;
      --blue: #004aad;
      --text: #333;
      --muted: #666;
      --shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: "Arial", sans-serif;
      margin: 0;
      background: #f6f8fb;
      color: var(--text);
    }

    header {
      background: var(--brand-dark);
      color: white;
      padding: 20px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }

    main {
      max-width: 1000px;
      margin: 40px auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background: var(--brand-dark);
      color: #fff;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    button {
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 6px;
    }

    .approve {
      background-color: #28a745;
      color: white;
    }

    .reject {
      background-color: #dc3545;
      color: white;
    }

    .delete {
      background-color: #6c757d;
      color: white;
    }

    footer {
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }

    #languageSwitcher {
      margin-top: 10px;
      padding: 5px 10px;
      border-radius: 6px;
    }

    .status {
      font-weight: bold;
    }

    .pending { color: #ffc107; }
    .approved { color: #28a745; }
    .rejected { color: #dc3545; }

  </style>
</head>

<body>
  <header>
    <h1 data-i18n="title">GDLVS Access Requests</h1>
    <select id="languageSwitcher">
      <option value="en">🇬🇧 English</option>
      <option value="fr">🇫🇷 Français</option>
      <option value="ja">🇯🇵 日本語</option>
    </select>
  </header>

  <main>
    <h2 data-i18n="subtitle">Pending and Processed Requests</h2>
    <table id="requestsTable">
      <thead>
        <tr>
          <th data-i18n="name">Name</th>
          <th data-i18n="email">Email</th>
          <th data-i18n="organization">Organization</th>
          <th data-i18n="phone">Phone</th>
          <th data-i18n="purpose">Purpose</th>
          <th data-i18n="status">Status</th>
          <th data-i18n="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="requestsBody">
        <tr><td colspan="7" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </main>

  <footer>
    — GDLVS Administration — <br />
    <a href="https://gdlvs-2348e.web.app" style="color: var(--blue); text-decoration: none;">https://gdlvs-2348e.web.app</a>
  </footer>

  <script>
    /* === Firebase Init === */
    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* === EmailJS Init === */
    emailjs.init("TfmaZEvxtz2MNUb70");
    const ADMIN_EMAIL = "m.ngoma1988@gmail.com";

    /* === Translations === */
    const i18nResources = {
      en: {
        translation: {
          title: "GDLVS Access Requests",
          subtitle: "Pending and Processed Requests",
          name: "Name",
          email: "Email",
          organization: "Organization",
          phone: "Phone",
          purpose: "Purpose",
          status: "Status",
          actions: "Actions",
          approve: "Approve",
          reject: "Reject",
          delete: "Delete"
        }
      },
      fr: {
        translation: {
          title: "Demandes d’accès GDLVS",
          subtitle: "Demandes en attente et traitées",
          name: "Nom",
          email: "E-mail",
          organization: "Organisation",
          phone: "Téléphone",
          purpose: "Objet",
          status: "Statut",
          actions: "Actions",
          approve: "Approuver",
          reject: "Rejeter",
          delete: "Supprimer"
        }
      },
      ja: {
        translation: {
          title: "GDLVS アクセス申請",
          subtitle: "保留中および処理済みの申請",
          name: "氏名",
          email: "メール",
          organization: "組織",
          phone: "電話番号",
          purpose: "目的",
          status: "ステータス",
          actions: "操作",
          approve: "承認",
          reject: "拒否",
          delete: "削除"
        }
      }
    };

    i18next
      .use(i18nextBrowserLanguageDetector)
      .init({ resources: i18nResources, fallbackLng: "en" }, () => {
        jqueryI18next.init(i18next, $, { useOptionsAttr: true });
        $("body").localize();
      });

    document.getElementById("languageSwitcher").addEventListener("change", function () {
      i18next.changeLanguage(this.value, () => $("body").localize());
    });

    /* === Load Requests === */
    const requestsBody = document.getElementById("requestsBody");

    db.collection("requests").orderBy("requestedAt", "desc").onSnapshot(snapshot => {
      requestsBody.innerHTML = "";
      snapshot.forEach(doc => {
        const r = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.fullName || "-"}</td>
          <td>${r.email}</td>
          <td>${r.organization || "-"}</td>
          <td>${r.phone || "-"}</td>
          <td>${r.purpose || "-"}</td>
          <td class="status ${r.status}">${r.status}</td>
          <td>
            <button class="approve" onclick="updateStatus('${doc.id}', '${r.email}', 'approved', '${r.fullName}')">${i18next.t('approve')}</button>
            <button class="reject" onclick="updateStatus('${doc.id}', '${r.email}', 'rejected', '${r.fullName}')">${i18next.t('reject')}</button>
            <button class="delete" onclick="deleteRequest('${doc.id}')">${i18next.t('delete')}</button>
          </td>
        `;
        requestsBody.appendChild(tr);
      });
    });

    /* === Update Status + Send Multilingual Email === */
    async function updateStatus(id, email, status, name) {
      await db.collection("requests").doc(id).update({ status });

      let enMsg, frMsg, jaMsg;
      if (status === "approved") {
        enMsg = `✅ Dear ${name},\n\nYour GDLVS access request has been approved. Your account will be created within 72 hours.\n\n— GDLVS Administration\nhttps://gdlvs-2348e.web.app`;
        frMsg = `✅ Cher ${name},\n\nVotre demande d’accès au GDLVS a été approuvée. Votre compte sera créé dans les 72 prochaines heures.\n\n— Administration GDLVS\nhttps://gdlvs-2348e.web.app`;
        jaMsg = `✅ ${name}様\n\nGDLVSアクセス申請が承認されました。アカウントは72時間以内に作成されます。\n\n— GDLVS管理部\nhttps://gdlvs-2348e.web.app`;
      } else {
        enMsg = `❌ Dear ${name},\n\nYour GDLVS access request has been rejected. Please contact the administrator for more details.\n\n— GDLVS Administration\nhttps://gdlvs-2348e.web.app`;
        frMsg = `❌ Cher ${name},\n\nVotre demande d’accès au GDLVS a été rejetée. Veuillez contacter l’administrateur pour plus d’informations.\n\n— Administration GDLVS\nhttps://gdlvs-2348e.web.app`;
        jaMsg = `❌ ${name}様\n\nGDLVSアクセス申請は拒否されました。詳細については管理者にお問い合わせください。\n\n— GDLVS管理部\nhttps://gdlvs-2348e.web.app`;
      }

      try {
        await emailjs.send("service_ddq3kka", "template_inl3jsv", {
          name: name,
          email: email,
          organization: "GDLVS Access Center",
          phone: "",
          purpose: `${enMsg}\n\n🇫🇷 ${frMsg}\n\n🇯🇵 ${jaMsg}`,
          to_email: email,
          cc_email: ADMIN_EMAIL
        });

        alert(`✅ ${status.toUpperCase()} — Email notification sent to requester.`);
      } catch (err) {
        console.error("❌ EmailJS error:", err);
        alert("⚠️ Status updated, but email notification failed.");
      }
    }

    async function deleteRequest(id) {
      if (!confirm("Are you sure you want to delete this request?")) return;
      await db.collection("requests").doc(id).delete();
      alert("🗑️ Request deleted.");
    }
  </script>
</body>
</html>
