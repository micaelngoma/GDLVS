<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GDLVS - Login & Access Request</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- i18n + jQuery -->
  <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/jquery-i18next@1.2.1/dist/umd/jquery-i18next.min.js"></script>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("TfmaZEvxtz2MNUb70"); // ‚úÖ Your EmailJS public key
    })();
  </script>

  <style>
    :root {
      --brand-dark:#2a3f54;
      --brand-dark-2:#1e2d3c;
      --blue:#007bff;
      --text:#333;
      --muted:#666;
      --shadow:0 2px 6px rgba(0,0,0,.1);
      --success:#27ae60;
      --danger:#e74c3c;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,sans-serif;background:#f6f8fb;color:var(--text);}
    .background-image{position:fixed;inset:0;background:url('https://raw.githubusercontent.com/micaelngoma/GDLVS/main/Gabon%20Forest.jpg') no-repeat center center fixed;background-size:cover;z-index:-1;filter:brightness(0.9);}
    .welcome-section{max-width:960px;margin:50px auto 20px;background:rgba(255,255,255,.95);padding:24px 20px;text-align:center;border-radius:10px;box-shadow:var(--shadow);}
    .car-hero{font-size:72px;color:var(--brand-dark);}
    .welcome-section h1{color:var(--brand-dark);margin:10px 0;}
    .welcome-text{max-width:860px;margin:0 auto;font-size:1.05rem;}
    .login-container,.container{max-width:480px;margin:30px auto;padding:24px;background:#fff;border-radius:10px;box-shadow:var(--shadow);text-align:center;}
    input,textarea,button,select{width:100%;padding:10px;margin:8px 0;border:1px solid #dcdcdc;border-radius:8px;font-size:.98rem;}
    textarea{resize:vertical;min-height:100px;}
    button{background:var(--brand-dark);color:#fff;cursor:pointer;transition:.2s;}
    button:hover{background:var(--brand-dark-2);}
    a{color:var(--blue);font-weight:bold;text-decoration:none;}
    a:hover{text-decoration:underline;}
    .muted{color:var(--muted);font-size:.95rem;}
    #msg{margin-top:10px;font-weight:bold;}
    footer{text-align:center;margin:20px 0 40px;}
    #languageSwitcher{width:auto;padding:6px 10px;border-radius:8px;}
  </style>
</head>

<body>
  <div class="background-image"></div>

  <!-- === Welcome Banner === -->
  <section class="welcome-section">
    <i class="fas fa-car car-hero"></i>
    <h1 data-i18n="welcomeTitle">Welcome</h1>
    <p class="welcome-text" data-i18n="welcomeMessage">
      Welcome to the <strong>Gabon Driver‚Äôs License Verification System (GDLVS)</strong> ‚Äî a secure platform designed to verify the authenticity of Gabonese driver‚Äôs license IDs.
    </p>
  </section>

  <!-- === Login Section (will toggle dynamically) === -->
  <div class="login-container" id="mainContainer">
    <div id="loginPage">
      <h2><i class="fas fa-id-card"></i> <span data-i18n="login">Login</span></h2>
      <form id="loginForm" onsubmit="loginUser(event)">
        <input type="email" id="email" required data-i18n="[placeholder]emailPlaceholder" placeholder="Email" />
        <input type="password" id="password" required data-i18n="[placeholder]passwordPlaceholder" placeholder="Password" />
        <button type="submit"><i class="fas fa-sign-in-alt"></i> <span data-i18n="loginBtn">Login</span></button>
      </form>
      <div class="links-row">
        <a href="#" onclick="resetPassword()" data-i18n="forgotPassword">Forgot Password?</a>
      </div>
      <div id="msg" class="muted"></div>
      <p class="muted">
        <span data-i18n="noAccount">Don‚Äôt have an account?</span>
        <a href="#" onclick="showRequestAccess()" data-i18n="requestAccessHere">Request access here</a>
      </p>
    </div>
  </div>

  <footer>
    <label for="languageSwitcher"><i class="fas fa-globe"></i></label>
    <select id="languageSwitcher">
      <option value="en">üá¨üáß English</option>
      <option value="fr">üá´üá∑ Fran√ßais</option>
      <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
    </select>
  </footer>

  <!-- ==========================================================
       SCRIPT SECTION
       ========================================================== -->
  <script>
    /* === Firebase Init === */
    const firebaseConfig = {
      apiKey: "AIzaSyBiZN1G3ShoDOcPLe-bUILNf90NpdcCu6k",
      authDomain: "gdlvs-2348e.firebaseapp.com",
      projectId: "gdlvs-2348e",
      storageBucket: "gdlvs-2348e.appspot.com",
      messagingSenderId: "358715790318",
      appId: "1:358715790318:web:9d4c85e0f71222cf1b34ff"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* === Translations === */
    const i18nResources = {
      en:{translation:{
        welcomeTitle:"Welcome",
        welcomeMessage:"Welcome to the Gabon Driver‚Äôs License Verification System (GDLVS) ‚Äî a secure platform designed to verify the authenticity of Gabonese driver‚Äôs license IDs.",
        login:"Login",loginBtn:"Login",emailPlaceholder:"Email",passwordPlaceholder:"Password",
        forgotPassword:"Forgot Password?",noAccount:"Don‚Äôt have an account?",requestAccessHere:"Request access here",
        verifyEmailFirst:"Please verify your email before logging in.",
        adminWelcome:"Welcome Admin!",loginSuccess:"Login successful!",
        requestAccess:"Request Access",submitRequest:"Submit Request",
        approvalNotice:"Your request will be reviewed by the administrator.",
        fullNamePlaceholder:"Full Name",emailPlaceholder:"Email",organizationPlaceholder:"Organization / Agency",
        phonePlaceholder:"Phone Number",purposePlaceholder:"Purpose of access...",
        backToLogin:"‚Üê Back to Login"
      }},
      fr:{translation:{
        welcomeTitle:"Bienvenue",welcomeMessage:"Bienvenue sur le Syst√®me Gabonais de V√©rification des Permis de Conduire (GDLVS).",
        login:"Connexion",loginBtn:"Connexion",emailPlaceholder:"Adresse e-mail",passwordPlaceholder:"Mot de passe",
        forgotPassword:"Mot de passe oubli√© ?",noAccount:"Pas de compte ?",requestAccessHere:"Demander un acc√®s ici",
        verifyEmailFirst:"Veuillez d‚Äôabord v√©rifier votre e-mail.",adminWelcome:"Bienvenue Administrateur!",loginSuccess:"Connexion r√©ussie!",
        requestAccess:"Demande d‚Äôacc√®s",submitRequest:"Soumettre la demande",
        approvalNotice:"Votre demande sera examin√©e par l‚Äôadministrateur.",
        fullNamePlaceholder:"Nom complet",organizationPlaceholder:"Organisation / Agence",
        phonePlaceholder:"Num√©ro de t√©l√©phone",purposePlaceholder:"But de l'acc√®s...",
        backToLogin:"‚Üê Retour √† la connexion"
      }},
      ja:{translation:{
        welcomeTitle:"„Çà„ÅÜ„Åì„Åù",welcomeMessage:"„Ç¨„Éú„É≥ÈÅãËª¢ÂÖçË®±Ë®ºË™çË®º„Ç∑„Çπ„ÉÜ„É† (GDLVS) „Å∏„Çà„ÅÜ„Åì„Åù„ÄÇ„Ç¨„Éú„É≥„ÅÆÈÅãËª¢ÂÖçË®±Ë®º„ÅÆÁúüÊ≠£ÊÄß„ÇíÁ¢∫Ë™ç„Åô„ÇãÂÆâÂÖ®„Å™„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„Åß„Åô„ÄÇ",
        login:"„É≠„Ç∞„Ç§„É≥",loginBtn:"„É≠„Ç∞„Ç§„É≥",emailPlaceholder:"„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ",passwordPlaceholder:"„Éë„Çπ„ÉØ„Éº„Éâ",
        forgotPassword:"„Éë„Çπ„ÉØ„Éº„Éâ„Çí„ÅäÂøò„Çå„Åß„Åô„ÅãÔºü",noAccount:"„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Å™„ÅÑÂ†¥Âêà",requestAccessHere:"„Ç¢„ÇØ„Çª„Çπ„Çí„É™„ÇØ„Ç®„Çπ„Éà„Åô„Çã",
        verifyEmailFirst:"„É≠„Ç∞„Ç§„É≥„Åô„ÇãÂâç„Å´„É°„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",adminWelcome:"ÁÆ°ÁêÜËÄÖ„Å®„Åó„Å¶„Çà„ÅÜ„Åì„Åù!",loginSuccess:"„É≠„Ç∞„Ç§„É≥ÊàêÂäü!",
        requestAccess:"„Ç¢„ÇØ„Çª„ÇπÁî≥Ë´ã",submitRequest:"Áî≥Ë´ã„ÇíÈÄÅ‰ø°",
        approvalNotice:"ÁÆ°ÁêÜËÄÖ„ÅåÁî≥Ë´ãÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ",
        fullNamePlaceholder:"Ê∞èÂêç",organizationPlaceholder:"ÁµÑÁπî / Ê©üÈñ¢",
        phonePlaceholder:"ÈõªË©±Áï™Âè∑",purposePlaceholder:"„Ç¢„ÇØ„Çª„ÇπÁõÆÁöÑ...",
        backToLogin:"‚Üê „É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã"
      }}
    };

    i18next.use(i18nextBrowserLanguageDetector).init(
      {resources:i18nResources,fallbackLng:"en"},
      ()=>{jqueryI18next.init(i18next,$,{useOptionsAttr:true});$("body").localize();}
    );
    document.getElementById("languageSwitcher").addEventListener("change",function(){
      i18next.changeLanguage(this.value,()=>$("body").localize());
    });

    /* === Helpers === */
    function showMsg(t,ok=false){const m=document.getElementById("msg");m.textContent=t;m.style.color=ok?"green":"red";}

    /* === Login === */
    async function loginUser(e){
      e.preventDefault();
      const email=document.getElementById("email").value.trim();
      const password=document.getElementById("password").value;
      try{
        const cred=await auth.signInWithEmailAndPassword(email,password);
        if(!cred.user.emailVerified){await cred.user.sendEmailVerification();showMsg(i18next.t("verifyEmailFirst"));await auth.signOut();return;}
        const roleDoc=await db.collection("roles").doc(email).get();
        const role=roleDoc.exists?roleDoc.data().role:"verifier";
        showMsg(i18next.t(role==="admin"?"adminWelcome":"loginSuccess"),true);
        setTimeout(()=>window.location.href=role==="admin"?"dashboard.html":"verify.html",700);
      }catch(err){showMsg("‚ùå "+err.message);}
    }

    /* === Password Reset === */
    async function resetPassword(){
      const email=document.getElementById("email")?.value.trim()||prompt("Enter your email:");
      if(!email) return;
      try{await auth.sendPasswordResetEmail(email);alert("Password reset email sent!");}
      catch(err){alert("Error: "+err.message);}
    }

    /* ==========================================================
       REQUEST ACCESS (Firestore + EmailJS)
       ========================================================== */
    function showRequestAccess(){
      const html = `
        <div class="container">
          <h2><i class="fas fa-user-plus"></i> ${i18next.t("requestAccess")}</h2>
          <form id="requestForm" onsubmit="submitAccessRequest(event)">
            <input type="text" id="requestFullName" required placeholder="${i18next.t("fullNamePlaceholder")}" />
            <input type="email" id="requestEmail" required placeholder="${i18next.t("emailPlaceholder")}" />
            <input type="text" id="organization" required placeholder="${i18next.t("organizationPlaceholder")}" />
            <input type="tel" id="phone" required placeholder="${i18next.t("phonePlaceholder")}" />
            <textarea id="purpose" required rows="4" placeholder="${i18next.t("purposePlaceholder")}"></textarea>
            <button type="submit"><i class="fas fa-paper-plane"></i> ${i18next.t("submitRequest")}</button>
          </form>
          <div id="msg"></div>
          <p class="muted">${i18next.t("approvalNotice")}</p>
          <p class="muted"><a href="#" onclick="showLoginPage()">${i18next.t("backToLogin")}</a></p>
        </div>`;
      document.getElementById("mainContainer").innerHTML = html;
    }

    async function submitAccessRequest(event) {
      event.preventDefault();
      const fullName = document.getElementById("requestFullName").value.trim();
      const email = document.getElementById("requestEmail").value.trim();
      const organization = document.getElementById("organization").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const purpose = document.getElementById("purpose").value.trim();
      const msgBox = document.getElementById("msg");

      msgBox.innerHTML = "‚è≥ Submitting your request...";
      msgBox.style.color = "#004aad";

      try {
        await db.collection("requests").add({
          fullName,
          email,
          organization,
          phone,
          purpose,
          status: "pending",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        await emailjs.send("service_ddq3kka", "template_inl3jsv", {
          name: fullName,
          email: email,
          organization: organization,
          phone: phone,
          purpose: purpose
        });

        msgBox.innerHTML = "‚úÖ Your request has been submitted successfully! You'll receive a confirmation email within 72 hours.";
        msgBox.style.color = "green";
        document.getElementById("requestForm").reset();
      } catch (error) {
        console.error("‚ùå Error submitting request:", error);
        msgBox.innerHTML = "‚ö†Ô∏è Failed to submit request. Please try again later.";
        msgBox.style.color = "red";
      }
    }

    function showLoginPage(){location.reload();}

    /* === Expose for HTML === */
    window.loginUser=loginUser;
    window.resetPassword=resetPassword;
    window.showRequestAccess=showRequestAccess;
    window.submitAccessRequest=submitAccessRequest;
  </script>
</body>
</html>
